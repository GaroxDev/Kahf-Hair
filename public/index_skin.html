<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/assets/images/favicon.png" sizes="any" />
  <title>KAHF Virtual Hair Try-On 2025</title>
  <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/owl.carousel.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/skin-analyzer.css">
  <script>
    let eulerY = 0;
  </script>
  <script src="/assets/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="/assets/js/owl.carousel.min.js"></script>
  <script src="/assets/js/three.min.js"></script>
  <script src="/assets/js/GLTFLoader.js"></script>
  <script type="module" src="/assets/js/OrbitControls.js"></script>
  <script src="/assets/js/dom-to-image.min.js"></script>
  <script src="/assets/js/jquery-3.6.0.min.js"></script>
  <script type="module" src="/assets/js/model-viewer.min.js"></script>
</head>

<body>
  <div class="kahf-container">


    <!-- Face Shape Result Screen -->
    <!-- <section id="face-result-screen" class="kahf-screen hidden">
  <img class="logo mb-5" width="30%" style="max-width: 200px;" src="/assets/images/logo-skin.png" alt="">
  
  <button class="kahf-btn kahf-btn-accent back-btn">
    <span>Back</span>
  </button>

  <div class="face-shape-card">
    <div class="d-flex gap-5 justify-content-center mb-4">
      <div class="wrapper-captured captured-left">
        <img src="/assets/images/oval.png" alt="">
        <div class="shape-name">Result</div>
      </div>
      <div class="wrapper-captured captured-right">
        <img src="/assets/images/oval.png" alt="">
        <div class="shape-name">Oval</div>
      </div>
    </div>
    <div class="face-shape-info mb-4">
      <p class="mb-2 shape-title">Face Shape Result</p>
      <p class="shape-desc">
        The most balanced and versatile face shape, with a slightly wider forehead than jawline.
        Almost any hairstyle works well, from short, sharp crops to longer, layered looks,
        giving you the freedom to experiment.
      </p>
    </div>
  </div>

  ✅ Captured photo container for dynamic image 
  <div id="captured-photo" style="text-align: center; margin: 20px 0;"></div>

  <button id="result-continue-btn" class="kahf-btn kahf-btn-accent">
    CONTINUE
  </button>
</section> 
-->


    <!-- Hairstyle Selection Screen -->
    <section id="hairstyle-screen" class="kahf-screen hidden">
      <button class="kahf-btn kahf-btn-accent back-btn">
        <span>Back</span>
      </button>
      <h1 class="kahf-title mb-5">Hairstyle Selection</h1>

      <!-- Three.js Container - Single consistent element -->
      <div class="scene-container" style="width: 100%; height: 450px;">
        <canvas id="renderCanvas1" style="width: 100%; height: 100%;"></canvas>
        <!-- <model-viewer auto-rotate camera-controls id="hair_0" src="/assets/models/hair-1.glb" data-hair="hair-1" alt="A 3D model"></model-viewer>
        <model-viewer auto-rotate camera-controls id="hair_1" src="/assets/models/hair-2.glb" data-hair="hair-2" alt="A 3D model"></model-viewer>
        <model-viewer auto-rotate camera-controls id="hair_2" src="/assets/models/hair-3.glb" data-hair="hair-3" alt="A 3D model"></model-viewer> -->
        <div class="scene-name"></div>
        <!-- Three.js will create its own canvas here -->
        <img class="rotate-icon" src="/assets/images/icon-rotate.png" alt="">
      </div>

      <div class="hairstyle-grid">
        <div class="hairstyle-grid-inner owl-carousel">
          <div class="hairstyle-item" data-model-index="0">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-1.glb" alt="A 3D model"></model-viewer>
              <!-- <img src="/assets/images/image 11.png" alt=""> -->
            </div>
            <div class="hairstyle-name">Hair Style 1</div>
          </div>
          <div class="hairstyle-item" data-model-index="1">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-4.glb" alt="A 3D model"></model-viewer>
              <!-- <img src="/assets/images/image 11.png" alt=""> -->
            </div>
            <div class="hairstyle-name">Hair Style 2</div>
          </div>
          <div class="hairstyle-item" data-model-index="2">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-5.glb" alt="A 3D model"></model-viewer>
              <!-- <img src="/assets/images/image 12.png" alt=""> -->
            </div>
            <div class="hairstyle-name">Hair Style 3</div>
          </div>
        </div>
      </div>

      <button id="hairstyle-continue-btn" class="kahf-btn kahf-btn-accent">
        CONTINUE
      </button>
    </section>

    <!-- Product Recommendation Screen -->
    <section id="product-screen" class="kahf-screen hidden">
      <button class="kahf-btn kahf-btn-accent back-btn">
        <span>Back</span>
      </button>
      <h1 class="kahf-title mb-0">Product<br />Recommendation</h1>

      <div class="product-card">
        <!-- <div class="product-header">
                    <h2>Perfect Match for Your Hair</h2>
                </div> -->
        <div class="product-body">
          <!-- <div class="face-shape-card"> -->
          <div class="d-flex gap-5 justify-content-center mb-2">
            <!-- <div class="photo-image-recommendation">
                <div class="shape-label">Face Shape:</div>
                <img src="/assets/images/image 10.png" alt="">
                <div class="shape-name">Two Block</div>
                <div class="shape-result">OVAL</div>
              </div> -->
            <div class="product-wrapper flex-column d-flex">
              <div class="product-item">
                <div class="product-item-inner">
                  <div class="product-name">Hair Styling</div>
                  <img src="/assets/images/product-3.png" alt="">
                </div>
                Water-based pomade for men with a long-lasting matte look, nourishes and protects hair.
              </div>
              <div class="product-item">
                <div class="product-item-inner">
                  <div class="product-name">Hair Styling</div>
                  <img src="/assets/images/product-4.png" alt="">
                </div>
                Water-based pomade for men with a long-lasting matte look, nourishes and protects hair.
              </div>
            </div>

            <div class="product-wrapper flex-column d-flex">
              <div class="product-item">
                <div class="product-item-inner">
                  <div class="product-name">Hair Styling</div>
                  <img src="/assets/images/pomade-matte.png" alt="">
                </div>
                Water-based pomade for men with a long-lasting matte look, nourishes and protects hair.
              </div>
              <div class="product-item">
                <div class="product-item-inner">
                  <div class="product-name">Hair Styling</div>
                  <img src="/assets/images/pomade-sleek.png" alt="">
                </div>
                Water-based pomade for men with a long-lasting matte look, nourishes and protects hair.
              </div>
            </div>

          </div>
          <div class="face-shape-info mb-4">
            <p class="mb-2 shape-title">HAIR TREATMENT :</p>
            <p class="shape-desc">Kahf Hair & Scalp Revitalizing Tonic - Menguatkan akar rambut, mengurangi kerontokan,
              dan menyegarkan kulit kepala dengan sensasi dingin. Cocok digunakan setiap hari untuk menjaga rambut tetap
              sehat dan bervolume.</p>
          </div>
          <!-- </div> -->
          <div class="d-flex gap-4 button-inline-wrapper justify-content-center align-items-center">
            <button id="restart-btn" class="kahf-btn kahf-btn-accent" style="width: 40%;">
              RETAKE
            </button>

            <button id="restart-btn" class="kahf-btn kahf-btn-accent" style="width: 40%">
              SHARE
            </button>
          </div>
        </div>
      </div>
    </section>

    <section id="home-page" class="home-page kahf-screen">
      <div class="kv">
        <img class="kv-image w-100" src="/assets/images/home-kv-skin.png" alt="">
        <div class="button-start-wrapper d-none d-flex gap-3 justify-content-center">
          <div class="button-left">
            <button id="button-start" class="kahf-btn kahf-btn-accent btn-yellow" style="pointer-events: none;">
              SCAN QR
            </button>
          </div>
          <div class="button-right d-flex justify-content-center align-items-center flex-column">
            <button id="button-to-form" class="button-to-form kahf-btn kahf-btn-accent">
              FILL FORM
            </button>
            <p class="mt-2 text-center small text-uppercase">No QR? Start here</p>
          </div>
        </div>
        <div class="splash-loading">
          <img src="./assets/images/loader-start.png" class="me-2">
          <img src="./assets/images/loader-bg.png" class="bg-load">
        </div>
      </div>
      <!-- <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt=""> -->
      <!-- <img class="home-tagline" src="/assets/images/tagline.png" alt=""> -->
    </section>
    
    <section id="loading-screen" class="loading p-0 kahf-screen page-stye-1 hidden">
      <div class="loading-image-wrapper">
        <img class="logo-decode" src="/assets/images/kahf-logo.png" alt="">
        <img class="logo-desc" src="/assets/images/kahf-desc.png" alt="">
        <div class="result-loading mt-3 justify-content-center align-items-center">
          <i class="custom-spinner me-2"></i>
          <!-- <span>Please Wait</span> -->
        </div>
      </div>
      <!-- <img class="logo-bottom" src="/assets/images/loading-logo.png" alt=""> -->
    </section>

    <section id="page-intro" class="kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <img class="logo" src="/assets/images/logo-skin.png" alt=""
        style="top: 0; left: 4%; width: 52%; max-width: 379px;">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt=""
        style="top: 9%; right: 6%; width: 45%; max-width: 330px;">
      <div class="top-intro-wrapper pt-5 text-center" style="top: 56%">
        <h2 class="mb-5">We are going to take a selfie to analyze<br />your skin.</h2>
        <p>Receive personalized skincare product advice and product recommendations from your favourite brands in a few
          minutes.</p>
      </div>
      <button id="button-to-age" class="button-question kahf-btn kahf-btn-accent" style="width: 220px;">
        Next
      </button>
    </section>

    <section id="page-question-age" class="page-question-mirror page-question kahf-screen page-stye-1 hidden">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Ketika bercermin<br/>apakah wajah kamu<br/>mengkilap?</h2>
      </div>
      
      <div class="question-wrapper question-square-wrapper pt-4 flex-row flex-wrap qustion-wrapper-two-column w-100">
        <div class="question-list">
          <div class="question-image-square">
            <img src="/assets/images/skin_dry.png" alt="">
          </div>
          <p>Tidak sama sekali<br/><span>dry</span></p>
        </div>
        <div class="question-list">
          <div class="question-image-square">
            <img src="/assets/images/combi_skin.png" alt="">
          </div>
          <p>Iya,<br/>di sebagian wajah <span>combination</span></p>
        </div>
        <div class="w-100 d-flex justify-content-center">
          <div class="question-list">
            <div class="question-image-square">
              <img src="/assets/images/oily_skin.png" alt="">
            </div>
            <p>Iya,<br/>di seluruh wajah <span>oily</span></p>
          </div>
        </div>
      </div>
      <div class="question-wrapper question-text-container">
        <!-- <div class="question-list question-text">Tidak sama sekali (dry)</div>
        <div class="question-list question-text">Iya, di sebagian wajah (combination)</div>
        <div class="question-list question-text">Iya, di seluruh wajah (oily)</div> -->
        <!-- <div class="question-list question-text">45-54</div> -->
        <!-- <div class="question-list question-text">55+</div> -->
      </div>
      <div class="w-100 mt-5">
        <button id="button-to-skin-condition" class="button-question kahf-btn kahf-btn-accent mt-5 disabled"
          style="width: 220px; top: 84%;">
          Next
        </button>
      </div>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <section id="page-question-skin-condition" class="page-question kahf-screen page-stye-1 hidden">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper pt-4">
        <h2>Apa masalah <span>kulit wajahmu?</span></h2>
        <!-- <p>Select one of the options to learn more. Tap “Not sure” to answer a few extra questions to help you find out. -->
        </p>
      </div>
      <div id="question-skin-condition" class="question-wrapper question-square-wrapper pt-1 pt-md-2 flex-row flex-wrap" style="width: 86%;">
        <div class="question-list">
          <p>Acne Prone</p>
          <div class="question-image-square">
            <img src="/assets/images/skin_acne.png" alt="">
          </div>
        </div>
        <div class="question-list">
          <p>Dry</p>
          <div class="question-image-square">
            <img src="/assets/images/skin_dry.png" alt="">
          </div>
        </div>
        <div class="question-list">
          <p>Hyper-<br/>pigmentation</p>
          <div class="question-image-square">
            <img src="/assets/images/skin_hyper.png" alt="">
          </div>
        </div>
        <div class="question-list">
          <p>Rough</p>
          <div class="question-image-square">
            <img src="/assets/images/skin_rough.png" alt="">
          </div>
        </div>
        <div class="question-list">
          <p>Dull Skin</p>
          <div class="question-image-square">
            <img src="/assets/images/skin_dull.png" alt="">
          </div>
        </div>
        <div class="question-list">
          <p>Redness</p>
          <div class="question-image-square">
            <img src="/assets/images/skin_redness.png" alt="">
          </div>
        </div>
        <div class="question-list">
          <p>Wrinkle</p>
          <div class="question-image-square">
            <img src="/assets/images/skin_wrinkle.png" alt="">
          </div>
        </div>
        <div class="question-list">
          <p>Tidak Tahu</p>
          <div class="question-image-square">
            <img src="/assets/images/dont-know.png" alt="">
          </div>
        </div>
      </div>
      <!-- <div class="question-wrapper question-image-container" style="top: 49%;">
        <div class="question-list question-image normal">
          <div class="question-image-wrapper">
            <img src="/assets/images/normal.png" alt="">
          </div>
          <div class="question-image-desc">
            <h5>Normal</h5>
            <p>Balanced and<br />
              hydrated.</p>
          </div>
        </div>
        <div class="question-list question-image oily">
          <div class="question-image-wrapper">
            <img src="/assets/images/oily.png" alt="">
          </div>
          <div class="question-image-desc">
            <h5>Oily</h5>
            <p>Shiny skin with visible pores,<br />prone to breakouts.</p>
          </div>
        </div>
        <div class="question-list question-image combination">
          <div class="question-image-wrapper">
            <img src="/assets/images/combination.png" alt="">
          </div>
          <div class="question-image-desc">
            <h5>Combination</h5>
            <p>Both oily and dry.</p>
          </div>
        </div>
        <div class="question-list question-image dry">
          <div class="question-image-wrapper">
            <img src="/assets/images/dry.png" alt="">
          </div>
          <div class="question-image-desc">
            <h5>Dry</h5>
            <p>Tight and flaky, less visible pores.</p>
          </div>
        </div>
        <div class="question-list question-image dull">
          <div class="question-image-wrapper">
            <img src="/assets/images/dull.png" alt="">
          </div>
          <div class="question-image-desc">
            <h5>Dull Skin</h5>
            <p>Lacks radiance; appears tired and uneven.</p>
          </div>
        </div>
        <div class="question-list question-image acne">
          <div class="question-image-wrapper">
            <img src="/assets/images/acne-prone.png" alt="">
          </div>
          <div class="question-image-desc">
            <h5>Acne Prone</h5>
            <p>Frequent breakouts; oily with clogged pores.</p>
          </div>
        </div>
        <div class="question-list question-image i-dont-know">
          <div class="question-image-wrapper">
            <img src="/assets/images/i-don-know.png" alt="">
          </div>
          <div class="question-image-desc">
            <h5>I don't know</h5>
            <p>Let' find out.</p>
          </div>
        </div>
      </div> -->
        <div class="w-100 mt-4">
          <button id="button-to-transportation" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px; top: 80%;">
            Next
          </button>
        </div>
        <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
        <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>


    <section id="page-question-transportation" class="page-question page-style-v4 kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <!-- <img class="logo" src="/assets/images/logo-skin.png" alt=""> -->
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper" style="top: 3%;">
        <h2>Apa transportasi<br/> yang kamu gunakan<br/>sehari-hari?</h2>
      </div>
      <div class="question-container">
        <div class="question-wrapper question-text-container" style="width: 78%; min-height: 55%;">
          <div class="question-list question-text" data-value="oily">Motor</div>
          <div class="question-list question-text" data-value="sensitive">Mobil</div>
          <div class="question-list question-text" data-value="normal">Bus</div>
          <div class="question-list question-text" data-value="combination">Kereta</div>
        </div>
        <button id="button-to-personal-type" class="button-question button-question kahf-btn kahf-btn-accent disabled"
          style="width: 220px;">
          Next
        </button>
      </div>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <section id="page-question-sport" class="page-question page-style-v4 kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <!-- <img class="logo" src="/assets/images/logo-skin.png" alt=""> -->
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper" style="top: 3%;">
        <h2>OLAHRAGA/HOBI APA<br/>YANG KAMU TEKUNI?</h2>
      </div>
      <div class="question-container">
        <div class="question-wrapper question-text-container flex-row flex-wrap" style="width: 96%; min-height: 52%;">
          <div class="question-list question-text" data-value="oily">Padel</div>
          <div class="question-list question-text" data-value="sensitive">Lari</div>
          <div class="question-list question-text" data-value="normal">Game</div>
          <div class="question-list question-text" data-value="combination">Gym</div>
          <div class="question-list question-text" data-value="dry">Badminton</div>
          <div class="question-list question-text" data-value="dry">Tennis</div>
          <div class="question-list question-text" data-value="dry">Others</div>
        </div>
        
        <button id="button-to-direct-sunlight" class="button-question kahf-btn kahf-btn-accent disabled"
          style="width: 220px;">
          Next
        </button>
      </div>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <section id="page-question-direct-sunlight" class="page-question kahf-screen page-stye-1 hidden">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Rata-rata jam terpapar matahari per hari</h2>
        <!-- <p>Select the option that best describes your skin</p> -->
      </div>
      <div class="question-wrapper question-text-container mt-3" style="width: 78%; min-height: 55%;">
        <div class="question-list question-text">0 - 30 menit</div>
        <div class="question-list question-text">30 menit - 1 jam</div>
        <div class="question-list question-text">1 - 2 jam</div>
        <div class="question-list question-text">2 - 3 jam</div>
      </div>
      <button id="button-to-livein" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
        Next
      </button>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <section id="page-question-personal-type" class="page-question kahf-screen page-stye-1 hidden">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Pilih <span>salah satu</span> tipe yang paling sesuai denganmu</h2>
        <!-- <p class="font-size: 13px;">Your local climate, air quality and sun exposure affect your skin. We use your
          location information to personalise our recommendations to better fit your needs.</p> -->
      </div>
      <div class="question-wrapper question-square-wrapper pt-5 flex-row flex-wrap qustion-wrapper-two-column w-100">
        <div class="question-list">
          <div class="question-image-square">
            <img src="/assets/images/indoor.jpg" alt="">
          </div>
          <p>Indoor Guy</span></p>
        </div>
        <div class="question-list">
          <div class="question-image-square">
            <img src="/assets/images/fieldman.jpg" alt="">
          </div>
          <p>Fieldman</p>
        </div>
        <div class="w-100 d-flex justify-content-center">
          <div class="question-list">
            <div class="question-image-square">
              <img src="/assets/images/sunlord.jpg" alt="">
            </div>
            <p>Sunlord</p>
          </div>
        </div>
      </div>
      <div class="w-100 mt-4">
        <button id="button-to-sport" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <section id="page-question-blemishes" class="page-question kahf-screen page-stye-1 hidden">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Let us help identify your skin type</h2>
        <p>How often do you get spots or blemishes?</p>
      </div>
      <div class="question-wrapper question-text-container">
        <div class="question-list question-text" data-value="oily">Every day or weekly</div>
        <div class="question-list question-text" data-value="sensitive">About once a month</div>
        <div class="question-list question-text" data-value="normal">Very rarely</div>
        <div class="question-list question-text" data-value="combination">Every now and then, but most often on the
          forehead, nose or chin area</div>
        <div class="question-list question-text" data-value="dry">Never</div>
      </div>
      <button id="button-to-morning" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
        Next
      </button>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <section id="page-question-livein" class="page-question kahf-screen page-stye-1 hidden">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper pt-4">
        <h2>Lokasi saya...</h2>
        <!-- <p class="font-size: 13px;">Your local climate, air quality and sun exposure affect your skin. We use your
          location information to personalise our recommendations to better fit your needs.</p> -->
      </div>
      <div class="question-wrapper question-text-container question-multiselect mt-3" style="width: 78%; min-height: 56%;">
        <div class="question-list question-text">Jakarta <img class="question-icon" width="24"
            src="/assets/images/icon-edit.png" alt=""></div>
        <div class="question-list question-text">UV index 11</div>
        <div class="question-list question-text">humidity 78%</div>
        <div class="question-list question-text">pollution 103</div>
      </div>
      <button id="button-to-intro-analyzer" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
        Next
      </button>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <!-- I DONT KNOW -->
    <!-- <section id="page-question-describe-skin" class="page-question kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Let us help identify your skin type</h2>
        <p>Select the option that best describes your skin</p>
      </div>
      <div class="question-wrapper question-text-container" style="width: 70%; margin-left: -4%; top: 50%;">
        <div class="question-list question-text" data-value="dry">My skin usually feels dry and tight</div>
        <div class="question-list question-text" data-value="oily">My skin usually feels greasy and can often look shiny
        </div>
        <div class="question-list question-text" data-value="normal">My skin usually feels soft and comfortable</div>
        <div class="question-list question-text" data-value="sensitive">My skin can often get red and irritate easily
        </div>
        <div class="question-list question-text" data-value="combination">My skin feels greasy in the T-zone area but
          the rest feels fairly dry/normal</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-pores" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- <section id="page-question-pores" class="page-question kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Let us help identify your skin type</h2>
        <p>How visible are your pores?</p>
      </div>
      <div class="question-wrapper question-text-container" style="width: 70%; margin-left: -4%; top: 50%;">
        <div class="question-list question-text" data-value="normal">Small pores that are not that visible</div>
        <div class="question-list question-text" data-value="oily">Large pores that are very visible</div>
        <div class="question-list question-text" data-value="dry">I don't see any pores</div>
        <div class="question-list question-text" data-value="sensitive">I've never noticed my pore size but I have
          surface blood vessels</div>
        <div class="question-list question-text" data-value="combination">The pores are larger on my forehead, nose and
          jaw, but normal in the rest of the face</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-afternoon" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- <section id="page-question-afternoon" class="page-question kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Let us help identify your skin type</h2>
        <p>How does your skin feel in the afternoon?</p>
      </div>
      <div class="question-wrapper question-text-container">
        <div class="question-list question-text" data-value="dry">My skin usually feels dry and tight</div>
        <div class="question-list question-text" data-value="oily">My skin usually feels greasy and can often look shiny
        </div>
        <div class="question-list question-text" data-value="normal">My skin feels normal, no major problems</div>
        <div class="question-list question-text" data-value="sensitive">My skin can often get quite red and irritated
        </div>
        <div class="question-list question-text" data-value="combination">My skin feels greasy in the T-zone area but
          the rest feels fairly dry/normal</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-blemishes" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- <section id="page-question-blemishes" class="page-question kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Let us help identify your skin type</h2>
        <p>How often do you get spots or blemishes?</p>
      </div>
      <div class="question-wrapper question-text-container">
        <div class="question-list question-text" data-value="oily">Every day or weekly</div>
        <div class="question-list question-text" data-value="sensitive">About once a month</div>
        <div class="question-list question-text" data-value="normal">Very rarely</div>
        <div class="question-list question-text" data-value="combination">Every now and then, but most often on the
          forehead, nose or chin area</div>
        <div class="question-list question-text" data-value="dry">Never</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-morning" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- <section id="page-question-morning" class="page-question kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Let us help identify your skin type</h2>
        <p>How does your skin feel when you first wake up in the morning?</p>
      </div>
      <div class="question-wrapper question-text-container">
        <div class="question-list question-text" data-value="dry">My skin usually feels dry and tight</div>
        <div class="question-list question-text" data-value="oily">Greasy and pores are visible around the face</div>
        <div class="question-list question-text" data-value="normal">Soft and good</div>
        <div class="question-list question-text" data-value="sensitive">Quite thin, skin feels translucent</div>
        <div class="question-list question-text" data-value="combination">T-zone feels normal but cheek areas are dry
          and tight</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-result-question" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section>

    <section id="page-result-skintype" class="kahf-screen justify-content-start align-items-start page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper mt-4 pt-5">
        <h2>Your skin type is:</h2>
      </div>
      <div class="skin-result-content">
        <div class="image-result-skin-wrapper mb-4">
          <img src="/assets/images/dry.png" alt="">
        </div>
        <h2>DRY</h2>
        <h4>Tight and flaky, less visible pores.</h4>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-backto-skin-condition" class="kahf-btn kahf-btn-accent" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- NORMAL SKIN QUESTION -->
    <!-- <section id="page-question-normal-concerns" class="page-question kahf-screen page-stye-1 page-question-skin-concern hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <img class="logo" src="/assets/images/logo-skin.png" alt="">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Do you have any personal skin concerns? Select all that apply.
        </h2>
        <p>You can choose more than 1 skin problem. Please choose according to your current condition</p>
      </div>
      <div class="question-wrapper question-text-container question-multiselect"
        style="width: 70%; margin-left: -4%; top: 58%;">
        <div class="question-list question-text">Texturized skin</div>
        <div class="question-list question-text">Large Pores</div>
        <div class="question-list question-text">Dehydrated skin</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-livein" class="button-question button-to-live-in kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- OILY SKIN QUESTION -->
    <!-- <section id="page-question-oily-concerns" class="page-question kahf-screen page-stye-1 page-question-skin-concern hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Do you have any personal skin concerns? Select all that apply.
        </h2>
        <p>You can choose more than 1 skin problem. Please choose according to your current condition</p>
      </div>
      <div class="question-wrapper question-text-container question-multiselect"
        style="width: 70%; margin-left: -4%; top: 58%;">
        <div class="question-list question-text">Excessive oil</div>
        <div class="question-list question-text">Comedones</div>
        <div class="question-list question-text">Acne</div>
        <div class="question-list question-text">Large Pores</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-livein" class="button-question button-to-live-in kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- COMBINATION SKIN QUESTION -->
    <!-- <section id="page-question-combination-concerns" class="page-question kahf-screen page-stye-1 page-question-skin-concern hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Do you have any personal skin concerns? Select all that apply.
        </h2>
        <p>You can choose more than 1 skin problem. Please choose according to your current condition</p>
      </div>
      <div class="question-wrapper question-text-container question-multiselect"
        style="width: 70%; margin-left: -4%; top: 52.5%; flex-direction: unset; flex-wrap: wrap;">
        <div class="question-list question-text">Normal to oily skin</div>
        <div class="question-list question-text">Normal to dry skin</div>
        <div class="question-list question-text">Dry to oily skin</div>
        <div class="question-list question-text">Acne prone skin to dull skin</div>
        <div class="question-list question-text">Dull and oily skin</div>
        <div class="question-list question-text">Acne prone skin and dry skin</div>
        <div class="question-list question-text">Dull skin with acne spot</div>
        <div class="question-list question-text">Normal and dull skin</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-livein" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- DULL SKIN QUESTION -->
    <!-- <section id="page-question-dull-concerns" class="page-question kahf-screen page-stye-1 page-question-skin-concern hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <img class="logo" src="/assets/images/logo-skin.png" alt="">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Do you have any personal skin concerns? Select all that apply.
        </h2>
        <p>You can choose more than 1 skin problem. Please choose according to your current condition</p>
      </div>
      <div class="question-wrapper question-text-container question-multiselect"
        style="width: 70%; margin-left: -4%; top: 58%;">
        <div class="question-list question-text">Uneven skin tone</div>
        <div class="question-list question-text">Dark spot due to acne scars</div>
        <div class="question-list question-text">Dead skin cells</div>
        <div class="question-list question-text">Fatigued skin</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-livein" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- DRY SKIN QUESTION -->
    <!-- <section id="page-question-dry-concerns" class="page-question kahf-screen page-stye-1 page-question-skin-concern hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Do you have any personal skin concerns? Select all that apply.
        </h2>
        <p>You can choose more than 1 skin problem. Please choose according to your current condition</p>
      </div>
      <div class="question-wrapper question-text-container question-multiselect"
        style="width: 70%; margin-left: -4%; top: 58%;">
        <div class="question-list question-text">Acne Prone</div>
        <div class="question-list question-text">Dull skin</div>
        <div class="question-list question-text">I don't see any pores</div>
        <div class="question-list question-text">I've never noticed my pore size but I have surface blood vessels</div>
        <div class="question-list question-text">The pores are larger on my forehead, nose and jaw, but normal in the rest of the face</div> 
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-livein" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <!-- ACNE SKIN QUESTION -->
    <!-- <section id="page-question-acne-concerns" class="page-question kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <img class="logo" src="/assets/images/logo-skin.png" alt="">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Do you have any personal skin concerns? Select all that apply.
        </h2>
        <p>You can choose more than 1 skin problem. Please choose according to your current condition</p>
      </div>
      <div class="question-wrapper question-text-container question-multiselect"
        style="width: 70%; margin-left: -4%; top: 55%;">
        <div class="question-list question-text">Clogged pores</div>
        <div class="question-list question-text">Redness due to acne scars</div>
        <div class="question-list question-text">Itchiness</div>
        <div class="question-list question-text">Active acne</div>
      </div>
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center w-100">
        <button id="button-to-livein" class="button-question kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section> -->

    <section id="skin-analyzer-splash" class="kahf-screen page-style-v4 page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper" style="top: 3%;">
        <h2>START SKIN<br/>
          ANALYSIS</h2>
      </div>
      <div class="instruction-container">
        <div class="h5 w-100 instruction-intro mb-3 mb-md-5">We are going to take a selfie<br />to analyze your skin.</div>
        <div class="instruction-wrap mb-2 pb-2">
          <div class="instruction-item">
            <img src="/assets/images/inst1.png" alt="">
          </div>
          <div class="instruction-item">
            <img src="/assets/images/inst2.png" alt="">
          </div>
          <div class="instruction-item">
            <img src="/assets/images/inst3.png" alt="">
          </div>
          <div class="instruction-item">
            <img src="/assets/images/inst4.png" alt="">
            <!-- <p>Keep neutral<br />expression</p> -->
          </div>
        </div>
        <div class="input-wrapper position-relative mb-5">
          <label class="checkbox splash-agreement d-flex align-items-start" for="privacy">
            <input type="checkbox" name="privacy" id="privacy">
            <div>
              If you upload a selfie, the image will be used to provide more precise recommendations that may be of interest
              to you. The image is deleted after being analyzed.<br /><br />
              See our <a href="https://www.kahfeveryday.com/en/terms-conditions/" target="_blank">Privacy Policy</a> for more information.
            </div>
          </label>
        </div>
        <div class="d-flex gap-3 mt-1 mt-md-3 justify-content-center align-items-center w-100">
          <button id="take-selfie" class="kahf-btn kahf-btn-accent disabled">
            NEXT
          </button>

          <!-- <button id="skip-selfie" class="kahf-btn kahf-btn-secondary" style="width: 50%">
            Skip Selfie
          </button> -->
        </div>
      </div>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <!-- Face Scan Screen -->
    <section id="face-scan-skin" class="kahf-screen page-style-v4 page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper" style="top: 3%;">
        <h2><span>HAI <a>KAHF</a></span></h2>
      </div>

      <div class="face-scanner-inner p-0">
        <div class="h5 w-100 instruction-intro mb-2">WE'LL ANALZE YOUR FACE & SKIN TO RECOMEND<br/>THE RIGHT PRODUCTS.</div>
        <div id="face-scan-container" class="mb-2 mb-md-1">
          <img class="ellipse" src="/assets/images/ellipse.png" alt="">
          <!-- <video id="camera-feed" autoplay playsinline></video> -->
          <!-- <div class="scan-animation"></div> -->
          <div class="scan-helper-container" id="scan-helper">
            <div class="scan-helper-text" id="scan-helper-text"></div>
            <div class="scan-progress">
              <div class="progress-bar" id="scan-progress"></div>
            </div>
          </div>
        </div>
        <!-- <h3 class="title-2 mb-4 text-center">Please Scan Your Face</h3>
        <h4 class="title-3 mb-5 text-center">We'll analyze your face shape to suggest suitable<br/>hairstyles and products.</h4> -->
  
        <button id="scan-btn" type="button" class="kahf-btn kahf-btn-accent">
          <span>Scan</span>
        </button>
      </div>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <section id="face-result-skin" class="p-0 kahf-screen hidden">
      <div class="header">
        <img class="icon-back" src="/assets/images/back-icon.png" alt="">
        <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
        <img class="logo" src="/assets/images/logo-header.png" alt="">
      </div>

      <div class="face-shape-card" style="max-width: unset;">
        <div class="wrapper-captured captured-left">
          <img src="" alt="">
        </div>
        <div class="face-shape-info mb-4 mt-3">
          <p class="shape-desc" id="shape-desc">
            We'll analyze your face & skin to recommend the <span>right products.</span>
          </p>
        </div>
      </div>

      <div class="d-flex gap-4 mt-5 justify-content-center align-items-center">
        <button id="retake-button" class="kahf-btn kahf-btn-secondary" style="width: 50%;">
          Re-take
        </button>

        <button id="next-to-result" class="kahf-btn kahf-btn-accent" style="width: 50%">
          Continue
        </button>
      </div>
    </section>

    <section id="skin-analyzer-selection" class="kahf-screen page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <img class="logo" src="/assets/images/logo-skin.png" alt="">
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper">
        <h2>Pick matching conditions
          <p>Help us find the best possible products for you by choosing which of the example images matches your skin
            closest.</p>
        </h2>
      </div>
      <div class="selection-container">
        <div class="selection-wrap mb-2">
          <div class="selection-title">Eyebags</div>
          <div class="selection-question">
            <label class="selection-item" for="eyebag_a">
              <input type="radio" name="eyebag" id="eyebag_a">
              <img src="/assets/images/selection/eyebag1.png" alt="">
            </label>
            <label class="selection-item" for="eyebag_b">
              <input type="radio" name="eyebag" id="eyebag_b">
              <img src="/assets/images/selection/eyebag2.png" alt="">
            </label>
            <label class="selection-item" for="eyebag_c">
              <input type="radio" name="eyebag" id="eyebag_c">
              <img src="/assets/images/selection/eyebag3.png" alt="">
            </label>
          </div>
        </div>

        <div class="selection-wrap mb-2">
          <div class="selection-title">Dark Spots</div>
          <div class="selection-question">
            <label class="selection-item" for="darkspot_a">
              <input type="radio" name="darkspot" id="darkspot_a">
              <img src="/assets/images/selection/darkspot1.png" alt="">
            </label>
            <label class="selection-item" for="darkspot_b">
              <input type="radio" name="darkspot" id="darkspot_b">
              <img src="/assets/images/selection/darkspot2.png" alt="">
            </label>
            <label class="selection-item" for="darkspot_c">
              <input type="radio" name="darkspot" id="darkspot_c">
              <img src="/assets/images/selection/darkspot3.png" alt="">
            </label>
          </div>
        </div>

        <div class="selection-wrap mb-2">
          <div class="selection-title">Wrinkles</div>
          <div class="selection-question">
            <label class="selection-item" for="wrinkles_a">
              <input type="radio" name="wrinkles" id="wrinkles_a">
              <img src="/assets/images/selection/wrinkles1.png" alt="">
            </label>
            <label class="selection-item" for="wrinkles_b">
              <input type="radio" name="wrinkles" id="wrinkles_b">
              <img src="/assets/images/selection/wrinkles2.png" alt="">
            </label>
            <label class="selection-item" for="wrinkles_c">
              <input type="radio" name="wrinkles" id="wrinkles_c">
              <img src="/assets/images/selection/wrinkles3.png" alt="">
            </label>
            <label class="selection-item" for="wrinkles_d">
              <input type="radio" name="wrinkles" id="wrinkles_d">
              <img src="/assets/images/selection/wrinkles4.png" alt="">
            </label>
          </div>
        </div>
      </div>

      <button id="button-to-skin-product" class="button-question next-to-form kahf-btn kahf-btn-accent disabled"
        style="min-width: 200px;">
        NEXT
      </button>
    </section>


    <section id="page-form" class="kahf-screen page-style-v4 page-stye-1 hidden">
      <img class="icon-back" src="/assets/images/back-icon.png" alt="">
      <!-- <img class="logo" src="/assets/images/logo-skin.png" alt=""> -->
      <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
      <div class="top-intro-wrapper" style="top: 3%;">
        <h2>REGISTER<br />TO DECODE</h2>
      </div>

      <form id="form">
        <div class="h5 text-white mt-4" style="font-weight: 300;">Fill in your details to unlock the experience.</div>
        <div class="input-wrapper">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-control name" placeholder="Enter your full name" autocomplete="off">
          <p class="error-validation">Name is required</p>
        </div>
        <div class="input-wrapper position-relative">
          <label class="form-label">WhatsApp Number</label>
          <input type="number" class="form-control phone" placeholder="Enter your WhatsApp number" autocomplete="off">
          <p class="error-validation">WhatsApp number is invalid</p>
        </div>
        <div class="input-wrapper position-relative">
          <label class="form-label">Age</label>
          <input type="number" class="form-control age" placeholder="Enter your age" autocomplete="off" max="120">
          <p class="error-validation">Age is required</p>
        </div>
        <div class="input-wrapper position-relative">
          <div class="mb-2">
            <label class="checkbox d-flex align-items-start">
              <input name="tnc" class="tnc" type="checkbox">
              <div>
                See our&nbsp;<a href="#">Privacy Policy</a>&nbsp;for more
                information.
              </div>
            </label>
          </div>
          <div class="mb-2">
            <label class="checkbox d-flex align-items-start">
              <input name="tnc" class="tnc2" type="checkbox">I agree to receive promotional & further information from
              Kahf (Optional)
            </label>
          </div>
        </div>
        <div class="d-flex mt-5 justify-content-center align-items-center">
          <a id="submit-form" class="kahf-btn kahf-btn-accent btn-form-submit disabled" style="min-width: 200px;">
            NEXT
          </a>
        </div>
        <p class="error-validation submit-failed mt-2">Server sedang banyak permintaan,<br />mohon coba lagi</p>
      </form>
      <img src="/assets/images/bg-union.png" alt="" class="acc-bottom-left">
      <img src="/assets/images/bg-union-2.png" alt="" class="acc-bottom-right">
    </section>

    <section id="page-result" class="p-0 page-stye-1 kahf-screen hidden">
      <div class="hint-wrapper">
        <img class="hint hint-summary" src="/assets/images/hint-summary.png" alt="">
        <img class="hint hint-analysis" src="/assets/images/hint-analysis.png" alt="">
        <p>[tap everywhere to continue]</p>
      </div>
      <div class="result-inner-wrapper">
        <div class="header-2">
          <img class="icon-back" src="/assets/images/back-icon.png" alt="">
          <div class="header-inner">
            <div class="header-name">KAHF</div>
            <div class="header-2-logo">/DECODE SKIN</div>
          </div>

          <!-- <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
          <img class="logo" src="/assets/images/logo-header.png" alt=""> -->
        </div>
        <div class="result-intro">
          <div class="left-result-intro">
            <span>SKIN TYPE</span>
          </div>
          <div class="right-result-intro">
            <h2>DRPT</h2>
            <p>DRY RESISTANT PIGMENTED TIGHT</p>
          </div>
        </div>
        <div class="result-inner position-relative navtab-result-skin">
          <ul class="nav nav-tabs parent-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab_summary_report" type="button"
                role="tab" aria-controls="tab_summary_report" aria-selected="true">
                SUMMARY REPORT
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab_skin_analysis" type="button" role="tab"
                aria-controls="tab_skin_analysis" aria-selected="true">
                SKIN ANALYSIS
              </button>
            </li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tab_summary_report" role="tabpanel">

              <div class="bars">
                <div class="bar-left-side w-100">
                  <div class="bar-wrapper">
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuemin="0"
                      aria-valuemax="100">
                      <div class="bar-acne progress-bar text-bg-success" data-value="60" style="width: 60%">Acne <div class="bar-value">60%</div></div>
                    </div>
                  </div>
                  <div class="bar-wrapper">
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuemin="0"
                      aria-valuemax="100">
                      <div class="bar-darkspot progress-bar text-bg-success" data-value="40" style="width: 40%">Dark Spot <div class="bar-value">40%</div></div>
                    </div>
                  </div>
                  <div class="bar-wrapper">
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuemin="0"
                      aria-valuemax="100">
                      <div class="bar-blackhead progress-bar text-bg-success" data-value="75" style="width: 75%">BLACKHEAD <div class="bar-value">75%</div></div>
                    </div>
                  </div>
                  <div class="bar-wrapper">
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuemin="0"
                      aria-valuemax="100">
                      <div class="bar-pores progress-bar text-bg-success" data-value="90" style="width: 90%">PORES <div class="bar-value">90%</div></div>
                    </div>
                  </div>
                  <div class="bar-wrapper">
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuemin="0"
                      aria-valuemax="100">
                      <div class="progress-bar text-bg-success" data-value="30" style="width: 30%">ACNE SCARS <div class="bar-value">30%</div></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="title-section">
                PRODUCTS RECOMMENDATION
              </div>
              <div class="section-products-wrapper">
                <div class="product product-1">
                  <div class="image-product-section">
                    <img src="./assets/images/product-1.png" alt="">
                  </div>
                  <p>Cleanser</p>
                </div>
                <div class="product product-1">
                  <div class="image-product-section">
                    <img src="./assets/images/product-2.png" alt="">
                  </div>
                  <p>Face Spray</p>
                </div>
                <div class="product product-1">
                  <div class="image-product-section">
                    <img src="./assets/images/product-3.png" alt="">
                  </div>
                  <p>Serum</p>
                </div>
                <div class="product product-1">
                  <div class="image-product-section">
                    <img src="./assets/images/product-4.png" alt="">
                  </div>
                  <p>Sunscreen</p>
                </div>
              </div>
              <div class="w-100">
                <div class="result-parameter definition-parameter">
                  <h2>Definition:</h2>
                  <p></p>
                </div>
                <div class="result-parameter solution-parameter">
                  <h2>Solution:</h2>
                  <p></p>
                </div>
              </div>
              <div class="w-100 d-flex justify-content-center align-items-center gap-4 py-5"
                style="background-color: #e8e8e8;">
                <button class="finish back-to-home kahf-btn kahf-btn-accent">FINISH</button>
                <button class="kahf-btn kahf-btn-accent btn-yellow button-download">DOWNLOAD</button>
              </div>
            </div>
            <div class="tab-pane fade" id="tab_skin_analysis" role="tabpanel">
              <div class="w-100 d-flex tab-inline" style="aspect-ratio: calc(6 / 3); overflow: hidden;">
                <div class="tab-content">
                  <!-- <div class="tab-pane fade show active" id="tabcontent-surface-issues" role="tabpanel"> -->
                  <div class="tab-pane fade show active" id="tabcontent-darkspot" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>
                  </div>
                  <div class="tab-pane fade" id="tabcontent-pore" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-acne-scars" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-dullness" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-acne" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-wrinkles" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-eyebags" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-finelines" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-hyperpigmentation" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-loss-firmness" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>



                  </div>
                  <div class="tab-pane fade" id="tabcontent-pigmen" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-colagen" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                  <div class="tab-pane fade" id="tabcontent-aging" role="tabpanel">
                    <div class="image-face-skin-result mb-5">
                      <img src="/assets/images/face.png" alt="">
                    </div>


                  </div>
                </div>

                <div class="tab-scroller" style="position:relative;"> 
                  <div id="arrow-up" class="scroll-arrow" aria-label="Scroll up"><i class="fa-solid fa-chevron-up"></i></div>
                
                  <div id="tabWrapper">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                      <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabcontent-darkspot" type="button"
                          role="tab" aria-controls="darkspot" aria-selected="true">Darkspot</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-acne" type="button" role="tab"
                          aria-controls="acne" aria-selected="false">
                          Acne
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-pore" type="button" role="tab"
                          aria-controls="pore" aria-selected="false">
                          Pore
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-acne-scars" type="button"
                          role="tab" aria-controls="pore" aria-selected="false">
                          Acne Scars
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-dullness" type="button"
                          role="tab" aria-controls="pore" aria-selected="false">
                          Dullness
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-wrinkles" type="button"
                          role="tab" aria-controls="wrinkles" aria-selected="false">
                          Wrinkles
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-eyebags" type="button"
                          role="tab" aria-controls="eyebags" aria-selected="false">
                          eyebags
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-finelines" type="button"
                          role="tab" aria-controls="finelines" aria-selected="false">
                          Finelines
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-hyperpigmentation"
                          type="button" role="tab" aria-controls="tabcontent-hyperpigmentation" aria-selected="false">
                          Hyperpigmentation
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-loss-firmness" type="button"
                          role="tab" aria-controls="tabcontent-loss-firmness" aria-selected="false">
                          Loss of Firmness
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-pigmen" type="button"
                          role="tab" aria-controls="tabcontent-pigmen" aria-selected="false">
                          Unseen Darkspot
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-colagen" type="button"
                          role="tab" aria-controls="tabcontent-colagen" aria-selected="false">
                          Collagen
                        </button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabcontent-aging" type="button"
                          role="tab" aria-controls="tabcontent-aging" aria-selected="false">
                          Aging
                        </button>
                      </li>
                    </ul>
                  </div>
                  <div id="arrow-down" class="scroll-arrow" aria-label="Scroll down"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
              </div>
              <div class="result-parameter bars" style="background-color: #737373">
                <!-- <h2>Parameter:</h2> -->
                <div class="gradien-parameter w-100">
                </div>
              </div>
              <div class="title-section">
                PRODUCTS RECOMMENDATION
              </div>
              <div class="section-products-wrapper" style="border-bottom: 1px solid #000">
                <div class="product product-1">
                  <div class="image-product-section">
                    <img src="./assets/images/product-1.png" alt="">
                  </div>
                  <p>Cleanser</p>
                </div>
                <div class="product product-1">
                  <div class="image-product-section">
                    <img src="./assets/images/product-2.png" alt="">
                  </div>
                  <p>Face Spray</p>
                </div>
                <div class="product product-1">
                  <div class="image-product-section">
                    <img src="./assets/images/product-3.png" alt="">
                  </div>
                  <p>Serum</p>
                </div>
                <div class="product product-1">
                  <div class="image-product-section">
                    <img src="./assets/images/product-4.png" alt="">
                  </div>
                  <p>Sunscreen</p>
                </div>
              </div>
              <div class="w-100 d-flex justify-content-center align-items-center gap-4 py-5"
                style="background-color: #e8e8e8;">
                <button class="back-to-summary kahf-btn kahf-btn-accent">BACK</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="page-result-product" class="p-0 page-stye-1 kahf-screen hidden">
      <div class="header">
        <!-- <img class="icon-back" src="/assets/images/back-icon.png" alt=""> -->

        <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
        <img class="logo" src="/assets/images/logo-header.png" alt="">
      </div>
      <div style="width: 80%;" class="ps-5 ms-2">
        <div class="w-100 top-intro-wrapper pt-2 mb-2 position-static">
          <h2>Hi Kahf!<br />
            Your Personalized SkinAnalysis is Here, Bro!</h2>
        </div>

        <div class="card">
          <img src="/assets/images/selection/darkspot1.png" alt="Skin Texture">
          <div class="info">
            <div class="row-card">
              <div>
                <h3>Location</h3>
                <p>Jakarta</p>
                <h3>Skin Type</h3>
                <p>Dry</p>
              </div>
              <div>
                <h3>Current Concerns</h3>
                <p>Acne Prone, Dull skin</p>
              </div>
            </div>
          </div>
        </div>
        <div class="main mt-5">
          <div class="grid">
            <!-- Product Card 1 -->
            <div class="gcard">
              <div class="gcard-text">
                <h3>First</h3>
                <h3>Cleanser</h3>
                <h4>KAHF</h4>
                <p>Skin Energizing and Brightening Face Wash</p>
                <a href="#" class="btn-prod">PRODUCT INFORMATION</a>
              </div>
              <img src="/assets/images/product/Cleanser.png" alt="Cleanser">
            </div>

            <!-- Product Card 2 -->
            <div class="gcard">
              <div class="gcard-text">
                <h3>Face</h3>
                <h3>Spray</h3>
                <h4>KAHF</h4>
                <p>All-in-one power toning face spray</p>
                <a href="#" class="btn-prod">PRODUCT INFORMATION</a>
              </div>
              <img src="/assets/images/product/Face Spray.png" alt="Face Spray">
            </div>

            <!-- Product Card 3 -->
            <div class="gcard">
              <div class="gcard-text">
                <h3>Serum</h3>
                <h4>KAHF</h4>
                <p>Brightening and Texture Refining Face Serum</p>
                <a href="#" class="btn-prod">PRODUCT INFORMATION</a>
              </div>
              <img src="/assets/images/product/Serum.png" alt="Serum">
            </div>

            <!-- Product Card 4 -->
            <div class="gcard">
              <div class="gcard-text">
                <h3>Sunscreen</h3>
                <h4>KAHF</h4>
                <p>Triple+ Protection Sunscreen Moisturizer</p>
                <a href="#" class="btn-prod">PRODUCT INFORMATION</a>
              </div>
              <img src="/assets/images/product/Sunscreen.png" alt="Sunscreen">
            </div>
          </div>
        </div>

        <div class="sidebar">
          PRODUCTS RECOMMENDATION
        </div>
        <div class="w-100 d-flex justify-content-center align-items-center">
          <button class="finish back-to-home kahf-btn kahf-btn-accent">FINISH</button>
        </div>
      </div>
    </section>

    <section id="page-skin-score" class="p-0 page-stye-1 kahf-screen hidden">
      <div class="header">
        <!-- <img class="icon-back" src="/assets/images/back-icon.png" alt=""> -->
        <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt="">
        <img class="logo" src="/assets/images/logo-header.png" alt="">
      </div>
      <div class="face-shape-card p-0 mb-4" style="max-width: unset; width: 64%;">
        <div class="wrapper-captured captured-left w-100">
          <img src="" alt="">
        </div>
      </div>

      <div class="score-wrapper">
        <div class="score-category">
          your<br />
          <strong>Enlarged Pores</strong><br />
          skin score is
          <h4>Good</h4>
        </div>
        <div class="score-number-wrapper">
          <div class="score-number">
            <span>40</span>%
            <svg width="84" height="84" viewBox="0 0 84 84" class="circular-progress" style="--dash: calc(40% * 3)">
              <circle class="bg"></circle>
              <circle class="fg"></circle>
            </svg>
          </div>
        </div>
        <div class="btn btn-sm btn-secondary">More info</div>
      </div>

      <button id="button-to-skin-product" class="button-question next-to-form kahf-btn kahf-btn-accent"
        style="min-width: 80%">
        get recommended products!
      </button>
    </section>

  </div>


  <div id="captured-photo">
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "/assets/js/three.module.js",
        "three/addons/": "/assets/js/three/addons/",
        "mindar-face-three":"/assets/js/mindar-face-three.prod.js"
      }
    }
  </script>

  <script type="module">
    // --- Face capture variables ---
    let straightFace = null;
    let leftFace = null;
    let rightFace = null;
    let straightFaceSrc;
    let leftFaceSrc;
    let rightFaceSrc;


    // Function to show a specific screen
    function showScreen(screenName) {
      // Hide all screens
      Object.values(screens).forEach(screen => {
        screen.addClass('hidden');
      });

      // Show the requested screen
      screens[screenName].removeClass('hidden');
    }

    // Screen navigation
    const screens = {
      profile: $('#profile-screen'),
      splash: $('#splash-screen'),
      landing: $('#landing-screen'),
      startScan: $('#start-qr-screen'),

      registForm: $('#register-form'),
      scanAnalyzer: $('#skin-analyzer-splash'),
      scanSkin: $('#face-scan-skin'),
      scanAnalyzerSelection: $('#skin-analyzer-selection'),
      homePage: $('#home-page'),
      pageForm: $('#page-form'),
      pageIntro: $('#page-intro'),
      // skin analyzer
      loadingScreen: $('#loading-screen'),
      pageResultSkin: $('#page-result'),
      pageSkinResult: $('#face-result-skin'),
      // pageSkinScore: $('#page-skin-score'),
      pageSkinProduct: $('#page-result-product'),
      pageQuestionAge: $('#page-question-age'),
      questionSkinCondition: $('#page-question-skin-condition'),
      questionDirectSunlight: $('#page-question-direct-sunlight'),
      questionPersonalConcern: $('#page-question-dry-concerns'),
      questionSport: $('#page-question-sport'),
      questionLivein: $('#page-question-livein'),
      questionPersonalType: $('#page-question-personal-type'),
      questionTransportation: $('#page-question-transportation'),
      // i dont know
      questionDescribeSkin: $('#page-question-describe-skin'),
      questionPoresSkin: $('#page-question-pores'),
      questionAfternoon: $('#page-question-afternoon'),
      questionBlemishes: $('#page-question-blemishes'),
      questionMorning: $('#page-question-morning'),
      // skin condition
      questionNormalSkin: $('#page-question-normal-concerns'),
      questionOilySkin: $('#page-question-oily-concerns'),
      questionCombinationSkin: $('#page-question-combination-concerns'),
      questionDullSkin: $('#page-question-dull-concerns'),
      questionDrySkin: $('#page-question-dry-concerns'),
      questionAcneSkin: $('#page-question-acne-concerns'),
      // result
      resultSkinType: $('#page-result-skintype')
    }

    // Called whenever you capture a photo
    function captureFace(type, imageData) {
      console.log("Captured face type:", type);
      if (type === "straight") {
        straightFace = imageData;
        $('<img>')
          .addClass('straight-face')
          .attr('src', straightFace.dataUrl)
          .appendTo('#captured-photo');
      } else if (type === "left") {
        leftFace = imageData;
        $('<img>')
          .addClass('left-face')
          .attr('src', leftFace.dataUrl)
          .appendTo('#captured-photo');
      } else if (type === "right") {
        rightFace = imageData;
        $('<img>')
          .addClass('right-face')
          .attr('src', rightFace.dataUrl)
          .appendTo('#captured-photo');
      }

      // ✅ Once all 3 are captured, auto-trigger upload
      if (straightFace && leftFace && rightFace) {
        handleFaceCapture(straightFace, leftFace, rightFace);
      }
    }

    // Send all 3 images to backend
    function handleFaceCapture(straightImage, leftImage, rightImage) {
      fetch("http://localhost:8000/api/upload-face", { // ✅ remove trailing slash
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            center: straightImage.dataUrl.split(",")[1],
            left: leftImage.dataUrl.split(",")[1],
            right: rightImage.dataUrl.split(",")[1]
          })
        })
        .then(res => res.json())
        .then(data => {
          console.log("Predictions:", data.predictions);
          console.log("Result image saved at:", data.saved_path);

          // ✅ Display predictions
          const predictionsDiv = document.createElement("div");
          predictionsDiv.innerHTML = `
        <h3>Face Shape Predictions</h3>
        <p><strong>Center:</strong> ${data.predictions.center.class} (${data.predictions.center.confidence})</p>
        <p><strong>Left:</strong> ${data.predictions.left.class} (${data.predictions.left.confidence})</p>
        <p><strong>Right:</strong> ${data.predictions.right.class} (${data.predictions.right.confidence})</p>
      `;
          document.querySelector("#captured-photo").appendChild(predictionsDiv);

          $('.face-left').attr('src', leftFace.dataUrl)
          $('.face-straight').attr('src', straightFace.dataUrl)
          $('.face-left').attr('src', rightFace.dataUrl)

          // ✅ Display result image
          const resultImg = document.createElement("img");
          resultImg.src = "data:image/png;base64," + data.result_base64;
          resultImg.style.maxWidth = "300px";
          resultImg.style.border = "2px solid #333";
          resultImg.style.display = "block";
          resultImg.style.marginTop = "10px";
          document.querySelector("#captured-photo").appendChild(resultImg);

          // ✅ Switch to Product Screen
          document.getElementById('face-scan-screen').classList.add('hidden');
          document.getElementById('product-screen').classList.remove('hidden');
        })
        .catch(err => console.error("Upload error:", err));
    }


    $("#page-result .icon-back").on("click", function () {
      showScreen("scanSkin");
    });

    const $scroller = $('#tabWrapper');

$('#arrow-up').on('click', function(e){
  e.preventDefault();
  const current = $scroller.scrollTop();
  const newTop = Math.max(0, current - 40);
  $scroller.stop(true).animate({ scrollTop: newTop }, 300);
});

$('#arrow-down').on('click', function(e){
  e.preventDefault();
  const current = $scroller.scrollTop();
  const max = $scroller.prop('scrollHeight') - $scroller.innerHeight();
  const newTop = Math.min(max, current + 40);
  $scroller.stop(true).animate({ scrollTop: newTop }, 300);
});

$('.back-to-summary').on('click', function() {
  $('[data-bs-target="#tab_summary_report"]').tab('show');
})

$('.button-download').on('click', function() {
  domtoimage.toBlob(document.getElementById('page-result'))
    .then(function (blob) {
      window.saveAs(blob, 'my-node.png');
    });
})


$("#button-to-skin-condition").on("click", function () {
  showScreen("questionSkinCondition");
});

$("#button-backto-skin-condition").on("click", function () {
  showScreen("questionSkinCondition");
  // $('#page-question-skin-condition .question-list:nth-child(4)').addClass('question-selected')
  $("#button-after-skin-condition").removeClass("disabled");
});

$("#button-to-personal-type").on("click", function () {
  showScreen("questionPersonalType");
});

$("#button-to-live-in").on("click", function () {
  showScreen("questionLivein");
});

$("#button-to-direct-sunlight").on("click", function () {
  showScreen("questionDirectSunlight");
});

$("#button-to-personal-concerns").on("click", function () {
  showScreen("questionPersonalConcern");
});

$("#button-to-intro-analyzer").on("click", function () {
  showScreen("scanAnalyzer");
});


$("#button-after-skin-condition").on("click", function () {
  if ($(".i-dont-know").hasClass("question-selected")) {
    showScreen("questionDescribeSkin");
  } else if ($(".normal").hasClass("question-selected")) {
    showScreen("questionNormalSkin");
  } else if ($(".oily").hasClass("question-selected")) {
    showScreen("questionOilySkin");
  } else if ($(".combination").hasClass("question-selected")) {
    showScreen("questionCombinationSkin");
  } else if ($(".dull").hasClass("question-selected")) {
    showScreen("questionDullSkin");
  } else if ($(".dry").hasClass("question-selected")) {
    showScreen("questionDrySkin");
  } else if ($(".acne").hasClass("question-selected")) {
    showScreen("questionAcneSkin");
  }
});

$("#button-to-pores").on("click", function () {
  showScreen("questionPoresSkin");
});

$("#button-to-afternoon").on("click", function () {
  showScreen("questionAfternoon");
});

$("#button-to-blemishes").on("click", function () {
  showScreen("questionBlemishes");
});

$("#button-to-morning").on("click", function () {
  showScreen("questionMorning");
});

$("#button-to-result-question").on("click", function () {
  showScreen("resultSkinType");
});

$(".question-wrapper:not(.question-multiselect) .question-list").on(
  "click",
  function () {
    $(
      ".question-wrapper:not(.question-multiselect) .question-list"
    ).removeClass("question-selected");
    $(this).addClass("question-selected");
    $(this)
      .parents(".question-wrapper")
      .next()
      .find("button")
      .removeClass("disabled");
  }
);

$(".question-multiselect .question-list").on("click", function () {
  $(this).toggleClass("question-selected");
  $(this)
    .parents(".question-wrapper")
    .next()
    .find("button")
    .removeClass("disabled");
});

$("#page-question-livein .question-multiselect .question-list").on(
  "click",
  function () {
    $("#page-question-livein .question-multiselect .question-list").addClass(
      "question-selected"
    );
    $(this)
      .parents(".question-wrapper")
      .next()
      .find("button")
      .removeClass("disabled");
  }
);

$(".page-question-mirror .icon-back").on("click", function () {
  showScreen("pageForm");
});

$("#page-question-skin-condition .icon-back").on("click", function () {
  showScreen("pageQuestionAge");
});

$("#page-question-dry-concerns .icon-back").on("click", function () {
  showScreen("questionDirectSunlight");
});

$("#skin-analyzer-splash .icon-back").on("click", function () {
  showScreen("questionLivein");
});

$("#face-scan-skin .icon-back").on("click", function () {
  showScreen("scanAnalyzer");
});

$("#page-question-livein .icon-back").on("click", function () {
  showScreen("questionPersonalConcern");
});

$("#page-question-livein .icon-back").on("click", function () {
  showScreen("questionPersonalConcern");
});

$("#page-question-describe-skin .icon-back").on("click", function () {
  showScreen("questionSkinCondition");
});

$("#page-question-pores .icon-back").on("click", function () {
  showScreen("questionDescribeSkin");
});

$("#page-question-afternoon .icon-back").on("click", function () {
  showScreen("questionPoresSkin");
});

$("#page-question-blemishes .icon-back").on("click", function () {
  showScreen("questionAfternoon");
});

$("#page-question-morning .icon-back").on("click", function () {
  showScreen("questionBlemishes");
});

$(".page-question-skin-concern .icon-back").on("click", function () {
  showScreen("questionSkinCondition");
});

$("#page-form .icon-back").on("click", function () {
  showScreen("homePage");
});

$("#skin-analyzer-selection .icon-back").on("click", function () {
  showScreen("scanAnalyzer");
});

$('#page-question-transportation .icon-back').on('click', function() {
  showScreen("questionSkinCondition");
})

$('#page-question-personal-type .icon-back').on('click', function() {
  showScreen("questionTransportation");
})

$('#page-question-sport .icon-back').on('click', function() {
  showScreen("questionPersonalType");
})

$("#page-question-livein .icon-back").on("click", function () {
  showScreen("questionDirectSunlight");
});

$("#page-question-direct-sunlight .icon-back").on("click", function () {
  showScreen("questionSport");
});


// Set up question selection
$(".question-list").on("click", function () {
  // Remove selected class from all options in this question
  $(this).siblings().removeClass("selected");

  // Add selected class to clicked option
  $(this).addClass("selected");

  // Enable the next button
  const container = $(this).closest(".kahf-screen");
  container.find("button").removeClass("disabled");

  // Store the answer
  const screenId = container.attr("id");
  const answer = $(this).data("value");

  if (screenId === "page-question-describe-skin") {
    userAnswers.describe = answer;
  } else if (screenId === "page-question-pores") {
    userAnswers.pores = answer;
  } else if (screenId === "page-question-afternoon") {
    userAnswers.afternoon = answer;
  } else if (screenId === "page-question-blemishes") {
    userAnswers.blemishes = answer;
  } else if (screenId === "page-question-morning") {
    userAnswers.morning = answer;
  }
});

// Navigation between screens
$("#button-to-pores").on("click", function () {
  if (!$(this).hasClass("disabled")) {
    showScreen("questionPoresSkin");
  }
});

$("#button-to-afternoon").on("click", function () {
  if (!$(this).hasClass("disabled")) {
    showScreen("questionAfternoon");
  }
});

$("#button-to-blemishes").on("click", function () {
  if (!$(this).hasClass("disabled")) {
    showScreen("questionBlemishes");
  }
});

$("#button-to-morning").on("click", function () {
  if (!$(this).hasClass("disabled")) {
    showScreen("questionMorning");
  }
});


// Back button functionality
$(".icon-back, .back-button").on("click", function () {
  const currentScreen = $(this).closest(".kahf-screen");

  if (currentScreen.attr("id") === "page-question-pores") {
    showScreen("questionDescribeSkin");
  } else if (currentScreen.attr("id") === "page-question-afternoon") {
    showScreen("questionPoresSkin");
  } else if (currentScreen.attr("id") === "page-question-blemishes") {
    showScreen("questionAfternoon");
  } else if (currentScreen.attr("id") === "page-question-morning") {
    showScreen("questionBlemishes");
  } else if (currentScreen.attr("id") === "page-result-question") {
    showScreen("questionMorning");
  }
});

// Restart quiz
$("#button-restart").on("click", function () {
  // Reset answers
  for (let key in userAnswers) {
    userAnswers[key] = null;
  }

  // Clear selections
  $(".question-list").removeClass("selected");

  // Disable all buttons
  $(".kahf-btn").addClass("disabled");

  // Go to first screen
  showScreen("questionDescribeSkin");
});

// jQuery: pinch-to-zoom (with focus-point) + one-finger pan when zoomed

$(".image-face-skin-result").each(function () {
  var $container = $(this);
  var $image = $container.find("img");

  // Shared state
  var currentScale = 1;
  var minScale = 1;
  var maxScale = 3;
  var panX = 0, panY = 0;

  // Pinch state
  var initialDistance = null;
  var initialScale = 1;
  var didPinchZoom = false;

  // Pan state
  var isPanning = false;
  var panStartX = 0, panStartY = 0;
  var panLastX = 0, panLastY = 0;

  var SNAP_THRESHOLD = 1.05;

  function getDistance(t1, t2) {
    var dx = t2.pageX - t1.pageX;
    var dy = t2.pageY - t1.pageY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function getMidpoint(t1, t2) {
    return {
      x: (t1.pageX + t2.pageX) / 2,
      y: (t1.pageY + t2.pageY) / 2
    };
  }

  function applyTransform(scale, px, py) {
    $image.css("transform", "translate(-50%,-50%) translate(" + px + "px," + py + "px) scale(" + scale + ")");
  }

  // Adjust for 136% default size
  function clampPan(px, py, scale) {
    var cw = $container.width(), ch = $container.height();
    var visualScale = 1.36 * scale;
    var maxX = Math.max(0, (visualScale - 1) * cw / 2);
    var maxY = Math.max(0, (visualScale - 1) * ch / 2);
    return {
      x: Math.max(-maxX, Math.min(maxX, px)),
      y: Math.max(-maxY, Math.min(maxY, py))
    };
  }

  function readScaleFromComputed() {
    try {
      var cs = window.getComputedStyle($image[0]).transform;
      if (cs && cs !== "none") {
        var m = new DOMMatrix(cs);
        return m.a || 1;
      }
    } catch (err) {}
    return currentScale || 1;
  }

  function resetZoomSmooth() {
    currentScale = 1;
    panX = 0;
    panY = 0;
    $image.css("transition", "transform 200ms ease");
    $image.css("transform-origin", "50% 50%");
    applyTransform(currentScale, panX, panY);
  }

  // ----- Desktop behavior -----
  if (!("ontouchstart" in window)) {
    $container.on("mouseenter", function () {
      currentScale = 1.7;
      panX = 0; panY = 0;
      $image.css("transition", "transform 250ms ease");
      applyTransform(currentScale, panX, panY);
    });

    $container.on("mousemove", function (e) {
      var offset = $container.offset();
      var relX = e.pageX - offset.left;
      var relY = e.pageY - offset.top;
      var width = $container.width();
      var height = $container.height();
      var xPercent = (relX / width) * 100;
      var yPercent = (relY / height) * 100;
      $image.css("transform-origin", xPercent + "% " + yPercent + "%");
      applyTransform(currentScale, 0, 0);
    });

    $container.on("mouseleave", function () {
      currentScale = 1;
      $image.css("transition", "transform 200ms ease");
      $image.css("transform-origin", "50% 50%");
      applyTransform(currentScale, 0, 0);
    });
  }

  // ----- Touch (mobile) behavior -----
  if ("ontouchstart" in window) {
    $container.on("touchstart", function (ev) {
      var e = ev.originalEvent || ev;
      var touches = e.touches || [];

      if (touches.length === 2) {
        ev.preventDefault();
        didPinchZoom = true;
        initialDistance = getDistance(touches[0], touches[1]);
        initialScale = currentScale;

        var mid = getMidpoint(touches[0], touches[1]);
        var offset = $container.offset();
        var relX = mid.x - offset.left;
        var relY = mid.y - offset.top;
        var pctX = (relX / $container.width()) * 100;
        var pctY = (relY / $container.height()) * 100;
        $image.css("transform-origin", pctX + "% " + pctY + "%");
        $image.css("transition", "none");
      } else if (touches.length === 1) {
        if (currentScale > 1.01) {
          isPanning = true;
          panStartX = touches[0].pageX;
          panStartY = touches[0].pageY;
          panLastX = panX;
          panLastY = panY;
          $image.css("transition", "none");
        }
      }
    });

    $container.on("touchmove", function (ev) {
      var e = ev.originalEvent || ev;
      var touches = e.touches || [];

      if (touches.length === 2 && initialDistance) {
        ev.preventDefault();
        var newDistance = getDistance(touches[0], touches[1]);
        var scaleChange = newDistance / initialDistance;
        var newScale = initialScale * scaleChange;
        newScale = Math.max(minScale, Math.min(maxScale, newScale));
        currentScale = newScale;

        var clamped = clampPan(panX, panY, currentScale);
        panX = clamped.x;
        panY = clamped.y;
        applyTransform(currentScale, panX, panY);
      } else if (touches.length === 1 && isPanning) {
        ev.preventDefault();
        var tx = touches[0].pageX, ty = touches[0].pageY;
        var dx = tx - panStartX, dy = ty - panStartY;
        var candidateX = panLastX + dx, candidateY = panLastY + dy;
        var clamped = clampPan(candidateX, candidateY, currentScale);
        panX = clamped.x;
        panY = clamped.y;
        applyTransform(currentScale, panX, panY);
      }
    });

    $container.on("touchend touchcancel", function (ev) {
      var e = ev.originalEvent || ev;
      var touches = e.touches || [];

      if (!touches || touches.length === 0) {
        currentScale = readScaleFromComputed();
        $image.css("transition", "transform 180ms ease");

        if (currentScale <= SNAP_THRESHOLD) {
          resetZoomSmooth();
        } else {
          var clamped = clampPan(panX, panY, currentScale);
          panX = clamped.x;
          panY = clamped.y;
          applyTransform(currentScale, panX, panY);
        }

        initialDistance = null;
        initialScale = currentScale;
        isPanning = false;
      } else if (touches.length === 1) {
        currentScale = readScaleFromComputed();
        initialDistance = null;
        initialScale = currentScale;
        $image.css("transition", "transform 120ms linear");

        if (currentScale <= SNAP_THRESHOLD) {
          resetZoomSmooth();
        }
      }
    });

    // Double-tap to reset
    var lastTap = 0;
    $container.on("touchend", function (ev) {
      var now = Date.now();
      if (now - lastTap < 300) {
        resetZoomSmooth();
      }
      lastTap = now;
    });

    // Auto reset zoom when tab is hidden or browser loses focus (after pinch)
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "hidden" && didPinchZoom) {
        resetZoomSmooth();
        didPinchZoom = false;
      }
    });

    window.addEventListener("blur", function () {
      if (didPinchZoom) {
        resetZoomSmooth();
        didPinchZoom = false;
      }
    });
  }

  // Optional: Desktop drag-to-pan and wheel zoom
  if (!("ontouchstart" in window)) {
    var mouseDown = false, mouseStartX = 0, mouseStartY = 0, mouseLastX = 0, mouseLastY = 0;

    $container.on("mousedown", function (e) {
      if (currentScale > 1.01) {
        mouseDown = true;
        mouseStartX = e.pageX;
        mouseStartY = e.pageY;
        mouseLastX = panX;
        mouseLastY = panY;
        e.preventDefault();
      }
    });

    $(document).on("mousemove", function (e) {
      if (mouseDown) {
        var dx = e.pageX - mouseStartX;
        var dy = e.pageY - mouseStartY;
        var candidateX = mouseLastX + dx;
        var candidateY = mouseLastY + dy;
        var clamped = clampPan(candidateX, candidateY, currentScale);
        panX = clamped.x;
        panY = clamped.y;
        applyTransform(currentScale, panX, panY);
      }
    }).on("mouseup", function () {
      if (mouseDown) {
        mouseDown = false;
      }
    });

    $container.on("wheel", function (ev) {
      ev.preventDefault();
      var e = ev.originalEvent;
      var delta = e.deltaY;
      var zoomFactor = delta > 0 ? 0.9 : 1.1;
      var newScale = Math.max(minScale, Math.min(maxScale, currentScale * zoomFactor));

      var offset = $container.offset();
      var relX = e.pageX - offset.left;
      var relY = e.pageY - offset.top;
      var pctX = (relX / $container.width()) * 100;
      var pctY = (relY / $container.height()) * 100;
      $image.css("transform-origin", pctX + "% " + pctY + "%");

      currentScale = newScale;
      var clamped = clampPan(panX, panY, currentScale);
      panX = clamped.x;
      panY = clamped.y;
      applyTransform(currentScale, panX, panY);
    });
  }
});

import * as THREE from "three";
import { MindARThree } from "mindar-face-three";

const mindarThree = new MindARThree({
  container: document.getElementById("face-scan-container"),
  uiLoading: false,
  uiScanning: false,
  uiError: false,
});

const { renderer, scene, camera } = mindarThree;

// Create face mesh with custom scanning effect material
const faceMesh = mindarThree.addFaceMesh();
const texture = new THREE.TextureLoader().load("/assets/images/face-mesh.png");

// Shader uniforms
const uniforms = {
  map: {
    value: texture,
  },
  time: {
    value: 0,
  },
  lineColor: {
    value: new THREE.Color(0xffffff),
  },
  lineSpeed: {
    value: 1.0,
  },
  lineWidth: {
    value: 0.01,
  },
  glowWidth: {
    value: 0.02,
  },
};

let capturedImages = [];

// Declare the variables before using them
// let base64Center; // hasil dari file upload / webcam
// let base64Left;
// let base64Right;

// const images = {
//   center: base64Center,
//   left: base64Left,
//   right: base64Right,
// };

// document.addEventListener('DOMContentLoaded', () => {
//       document.getElementById("scan-btn").addEventListener("click", async () => {
//         console.log("📸 Sending images to backend...");
//         const result = await loadPrediction(images);
//         console.log("✅ Backend response received!", result);
//       });
//     });

// -------------------- CONFIG (updated) --------------------
const FACE_SHAPE_CONFIG = {
  emaAlpha: 0.18, // smoothing (0 = no smoothing, closer to 1 = slower updates)
  sigma: 0.08, // scoring sensitivity (smaller = more sensitive)
  lowerSlice: [0.0, 0.33],
  middleSlice: [0.33, 0.66],
  upperSlice: [0.66, 1.0],
  minConfidence: 0.03, // never report lower than this (3%)
  softmaxEps: 1e-6, // tiny regularizer for numerical stability
  lastResultDecay: 0.6, // multiply previous confidence by this when measurements fail
  shapes: {
    Oval: {
      ideal: [1.5, 0.8, 1.02],
      weight: [0.5, 0.25, 0.25],
    }, // less jaw weight
    Round: {
      ideal: [1.18, 0.98, 1.0],
      weight: [0.45, 0.3, 0.25],
    },
    Square: {
      ideal: [1.2, 1.05, 1.0],
      weight: [0.3, 0.55, 0.15],
    }, // stronger jaw weight, jaw ideal > 1
    Rectangle: {
      ideal: [1.6, 0.93, 1.0],
      weight: [0.5, 0.25, 0.25],
    },
    Heart: {
      ideal: [1.35, 0.8, 1.2],
      weight: [0.35, 0.25, 0.4],
    },
    Diamond: {
      ideal: [1.45, 0.78, 0.92],
      weight: [0.45, 0.25, 0.3],
    },
    Triangle: {
      ideal: [1.25, 1.1, 0.88],
      weight: [0.35, 0.4, 0.25],
    },
  },
};

// -------------------- STATE --------------------
const faceShapeState = {
  ema: null, // EMA for numeric measurements
  lastResult: null, // last returned detection result (for graceful fallback)
};

let faceShapeResult =
  typeof faceShape !== "undefined" && faceShape.length
    ? faceShape[0]
    : {
        name: "Unknown",
      };

// -------------------- HELPERS --------------------
function isValidNumber(v) {
  return typeof v === "number" && Number.isFinite(v) && !Number.isNaN(v);
}

function clamp(v, a = 0, b = 1) {
  return Math.max(a, Math.min(b, v));
}

function ema(prev, next, alpha) {
  if (!prev)
    return {
      ...next,
    };
  const out = {};
  for (const k of Object.keys(next)) {
    const nv = next[k];
    if (isValidNumber(nv) && isValidNumber(prev[k]))
      out[k] = alpha * nv + (1 - alpha) * prev[k];
    else if (isValidNumber(nv)) out[k] = nv;
    else out[k] = prev[k] ?? 0;
  }
  return out;
}

// -------------------- HELPERS (updated to transform -> NDC/screen) --------------------
function buildPoints(positions, mesh = null, camera = null) {
  // positions is Float32Array [x,y,z,...]
  // If mesh and camera provided, points will be projected to NDC via camera
  // If mesh provided but camera omitted, points will be converted to world-space (3D)
  const pts = [];
  const v = new THREE.Vector3();

  // cache matrixWorld for speed if provided
  const mat = mesh && mesh.matrixWorld ? mesh.matrixWorld : null;

  for (let i = 0; i < positions.length; i += 3) {
    v.set(positions[i], positions[i + 1], positions[i + 2]);

    if (mat) {
      v.applyMatrix4(mat); // now in world-space
    }

    if (camera) {
      // project to NDC (-1..1)
      v.project(camera);
      // use NDC x/y for relative geometry. z remains depth (optional)
      pts.push({
        x: v.x,
        y: v.y,
        z: v.z,
      });
    } else {
      // world-space fallback (3D)
      pts.push({
        x: v.x,
        y: v.y,
        z: v.z,
      });
    }
  }
  return pts;
}

function computeBBox(points) {
  let minX = Infinity,
    maxX = -Infinity,
    minY = Infinity,
    maxY = -Infinity;
  for (const p of points) {
    if (p.x < minX) minX = p.x;
    if (p.x > maxX) maxX = p.x;
    if (p.y < minY) minY = p.y;
    if (p.y > maxY) maxY = p.y;
  }
  const width = maxX - minX || 1e-6;
  const height = maxY - minY || 1e-6;
  return {
    minX,
    maxX,
    minY,
    maxY,
    width,
    height,
  };
}

function sliceWidth(points, bbox, fracStart, fracEnd) {
  const yStart = bbox.minY + fracStart * bbox.height;
  const yEnd = bbox.minY + fracEnd * bbox.height;

  let left = Infinity,
    right = -Infinity,
    count = 0;
  for (const p of points) {
    if (p.y >= yStart && p.y <= yEnd) {
      if (p.x < left) left = p.x;
      if (p.x > right) right = p.x;
      count++;
    }
  }
  if (count === 0) return bbox.width || 1e-6;
  return Math.max(1e-6, right - left);
}

function getFaceMeasurementsFromMesh(positions, mesh = null, camera = null) {
  // positions: Float32Array
  // mesh: the THREE.Mesh (faceMesh) so we can transform to world and project to camera
  // camera: optional THREE.Camera to project into 2D NDC space (recommended)
  const points = buildPoints(positions, mesh, camera);

  // If using NDC coordinates (camera provided), note NDC y runs -1..1,
  // but relative bbox calculations still work fine.
  const bbox = computeBBox(points);

  const jaw = sliceWidth(points, bbox, ...FACE_SHAPE_CONFIG.lowerSlice);
  const cheekbone = sliceWidth(points, bbox, ...FACE_SHAPE_CONFIG.middleSlice);
  const forehead = sliceWidth(points, bbox, ...FACE_SHAPE_CONFIG.upperSlice);
  const length = bbox.height;

  return {
    jaw,
    cheekbone,
    forehead,
    length,
    bbox,
  };
}

// -------------------- SCORING (stable + non-zero confidences) --------------------
function gaussianScore(measured, ideal, sigma) {
  if (
    !isValidNumber(measured) ||
    !isValidNumber(ideal) ||
    ideal === 0 ||
    !(sigma > 0)
  )
    return 0;
  const diff = (measured - ideal) / ideal;
  const val = Math.exp((-0.5 * (diff * diff)) / (sigma * sigma));
  return isValidNumber(val) ? val : 0;
}

function scoreShapes(meas) {
  const { jaw, cheekbone, forehead, length } = meas;

  // quick guard: if critical dims invalid -> attempt to return lastResult or uniform small confidences
  if (
    !isValidNumber(cheekbone) ||
    cheekbone <= 1e-6 ||
    !isValidNumber(length)
  ) {
    // If we have a lastResult, return it (but we'll handle decay in detect function)
    if (faceShapeState.lastResult) {
      const fallback = Object.keys(FACE_SHAPE_CONFIG.shapes).map((name) => ({
        name,
        score: faceShapeState.lastResult.name === name ? 1 : 0,
        confidence:
          faceShapeState.lastResult.name === name
            ? faceShapeState.lastResult.confidence
            : 0,
        details: {},
        ratios: {},
      }));
      return fallback;
    }
    // Otherwise produce tiny uniform confidences
    const n = Object.keys(FACE_SHAPE_CONFIG.shapes).length;
    const conf = 1 / n;
    return Object.keys(FACE_SHAPE_CONFIG.shapes).map((name) => ({
      name,
      score: 0,
      confidence: conf,
      details: {},
      ratios: {},
    }));
  }

  const lengthToWidth = length / cheekbone;
  const jawToCheek = jaw / cheekbone;
  const foreheadToCheek = forehead / cheekbone;
  const ratios = {
    lengthToWidth,
    jawToCheek,
    foreheadToCheek,
  };

  const results = [];
  for (const [name, meta] of Object.entries(FACE_SHAPE_CONFIG.shapes)) {
    const [idealLtoW, idealJtoC, idealFtoC] = meta.ideal;
    const w = meta.weight;

    const sL = gaussianScore(lengthToWidth, idealLtoW, FACE_SHAPE_CONFIG.sigma);
    const sJ = gaussianScore(jawToCheek, idealJtoC, FACE_SHAPE_CONFIG.sigma);
    const sF = gaussianScore(
      foreheadToCheek,
      idealFtoC,
      FACE_SHAPE_CONFIG.sigma
    );

    const score = sL * w[0] + sJ * w[1] + sF * w[2];
    results.push({
      name,
      score,
      details: {
        sL,
        sJ,
        sF,
      },
      ratios,
    });
  }

  // Softmax with tiny regularizer to avoid all-zero or NaN
  const scores = results.map((r) => r.score);
  const maxScore = Math.max(...scores, 0);
  const exps = results.map((r) => {
    const capped = clamp(r.score - maxScore, -50, 50);
    const v = Math.exp(capped);
    return isFinite(v)
      ? v + FACE_SHAPE_CONFIG.softmaxEps
      : FACE_SHAPE_CONFIG.softmaxEps;
  });
  let sumExp = exps.reduce((a, b) => a + b, 0) || 1;

  // initial confidences
  results.forEach((r, i) => (r.confidence = clamp(exps[i] / sumExp, 0, 1)));

  // enforce minimum confidence floor and renormalize
  const minC = FACE_SHAPE_CONFIG.minConfidence;
  let needRenorm = false;
  for (const r of results) {
    if (r.confidence < minC) {
      r.confidence = minC;
      needRenorm = true;
    }
  }
  if (needRenorm) {
    const tot = results.reduce((s, r) => s + r.confidence, 0) || 1;
    results.forEach((r) => (r.confidence = clamp(r.confidence / tot, 0, 1)));
  }

  results.sort((a, b) => b.score - a.score || b.confidence - a.confidence);
  return results;
}

// -------------------- DETECTION ENTRY (updated signature) --------------------
function detectFaceShapeFromMesh(positions, mesh = null, camera = null) {
  // Validate positions quickly and allow graceful fallback to lastResult
  if (!positions || positions.length < 12) {
    if (faceShapeState.lastResult) {
      const dec = clamp(
        (faceShapeState.lastResult.confidence || 0) *
          FACE_SHAPE_CONFIG.lastResultDecay,
        FACE_SHAPE_CONFIG.minConfidence,
        1
      );
      return {
        ...faceShapeState.lastResult,
        confidence: dec,
      };
    }
    return {
      name: "Oval",
      confidence: FACE_SHAPE_CONFIG.minConfidence,
      score: 0,
      second: null,
      measurements: {
        jaw: 0,
        cheekbone: 0,
        forehead: 0,
        length: 0,
      },
      ratios: {
        lengthToWidth: 0,
        jawToCheek: 0,
        foreheadToCheek: 0,
      },
    };
  }

  const raw = getFaceMeasurementsFromMesh(positions, mesh, camera);
  const numericRaw = {
    jaw: raw.jaw,
    cheekbone: raw.cheekbone,
    forehead: raw.forehead,
    length: raw.length,
  };

  if (!isValidNumber(numericRaw.cheekbone) || numericRaw.cheekbone <= 1e-6) {
    if (faceShapeState.lastResult) {
      const dec = clamp(
        (faceShapeState.lastResult.confidence || 0) *
          FACE_SHAPE_CONFIG.lastResultDecay,
        FACE_SHAPE_CONFIG.minConfidence,
        1
      );
      return {
        ...faceShapeState.lastResult,
        confidence: dec,
      };
    } else {
      return {
        name: "Oval",
        confidence: FACE_SHAPE_CONFIG.minConfidence,
        score: 0,
        second: null,
        measurements: numericRaw,
        ratios: {
          lengthToWidth: 0,
          jawToCheek: 0,
          foreheadToCheek: 0,
        },
      };
    }
  }

  // apply EMA to numeric measurements only
  faceShapeState.ema = ema(
    faceShapeState.ema,
    numericRaw,
    FACE_SHAPE_CONFIG.emaAlpha
  );

  const scored = scoreShapes(faceShapeState.ema);
  const top = scored[0] || {
    name: "Oval",
    confidence: FACE_SHAPE_CONFIG.minConfidence,
    score: 0,
  };
  const second = scored[1] || null;

  const conf = isValidNumber(top.confidence)
    ? clamp(top.confidence, FACE_SHAPE_CONFIG.minConfidence, 1)
    : FACE_SHAPE_CONFIG.minConfidence;

  const result = {
    name: top.name,
    confidence: conf,
    score: isValidNumber(top.score) ? top.score : 0,
    second: second
      ? {
          name: second.name,
          confidence: isValidNumber(second.confidence)
            ? clamp(second.confidence, FACE_SHAPE_CONFIG.minConfidence, 1)
            : FACE_SHAPE_CONFIG.minConfidence,
        }
      : null,
    measurements: {
      ...faceShapeState.ema,
    },
    ratios: top.ratios || {
      lengthToWidth: 0,
      jawToCheek: 0,
      foreheadToCheek: 0,
    },
  };

  // persist lastResult for fallback use
  faceShapeState.lastResult = {
    name: result.name,
    confidence: result.confidence,
    score: result.score,
    measurements: result.measurements,
    ratios: result.ratios,
  };

  return result;
}

// -------------------- INTEGRATION: call in your update loop (updated) --------------------
function onUpdate() {
  if (typeof faceMesh === "undefined" || !faceMesh || !faceMesh.geometry)
    return;
  const positions = faceMesh.geometry.attributes.position.array;

  // IMPORTANT: pass faceMesh and your THREE.Camera instance (replace 'camera' with your camera variable)
  // This makes measurements operate in camera-projected 2D space (NDC) where face shape is visually meaningful.
  const detection = detectFaceShapeFromMesh(positions, faceMesh, camera);

  const found =
    typeof faceShape !== "undefined"
      ? faceShape.find((item) => item.name === detection.name)
      : null;
  faceShapeResult = found
    ? {
        ...found,
        confidence: detection.confidence,
      }
    : {
        name: detection.name,
        confidence: detection.confidence,
      };

  faceShapeResult._debug = {
    confidence: detection.confidence,
    second: detection.second,
    measurements: detection.measurements,
    ratios: detection.ratios,
  };
}

// -------------------- LOGGER (safe) --------------------
function logFaceShape() {
  if (!faceShapeResult) return;
  const conf = isValidNumber(faceShapeResult.confidence)
    ? faceShapeResult.confidence
    : FACE_SHAPE_CONFIG.minConfidence;
  console.log(
    `Detected: ${faceShapeResult.name} (${(conf * 100).toFixed(0)}%)`,
    faceShapeResult._debug || {}
  );
}

// Vertex shader remains the same
const vertexShader = `
  varying vec2 vUv;
  void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`;

// Updated fragment shader with more solid scanning line
const fragmentShader = `
  uniform sampler2D map;
  uniform float time;
  uniform vec3 lineColor;
  uniform float lineSpeed;
  uniform float lineWidth;
  uniform float glowWidth;
  varying vec2 vUv;
  
  void main() {
    // Original texture
    vec4 texColor = texture2D(map, vUv);
    
    // Animated line position (0-1 range)
    float linePos = abs(fract(time * lineSpeed / 2.0) * 2.0 - 1.0);
    
    // Distance to line
    float dist = abs(vUv.y - linePos);
    
    // Sharper line with less smoothstep blending
    float lineIntensity = 1.0 - smoothstep(0.0, lineWidth, dist);
    float glowIntensity = 0.5 - smoothstep(lineWidth, lineWidth + glowWidth, dist);
    
    // More intense core with stronger glow
    vec3 scanEffect = lineColor * (lineIntensity * 0.5 + glowIntensity * 0.5);
    
    // Blend with original texture (use max to make effect more prominent)
    vec3 finalColor = max(texColor.rgb, scanEffect);
    
    // Increase overall opacity by reducing alpha blending
    float alpha = max(texColor.a, (lineIntensity + glowIntensity) * 0.7);
    
    gl_FragColor = vec4(finalColor, alpha);
  }
`;

// Create custom shader material
const material = new THREE.ShaderMaterial({
  uniforms: uniforms,
  vertexShader: vertexShader,
  fragmentShader: fragmentShader,
  transparent: true,
});

faceMesh.material = material;
scene.add(faceMesh);

let lookedRight = false,
  lookedLeft = false,
  lookedStraight = false;
let currentStepIndex = 0;
let startCapture = false;
let startScanFace = false;
let clock;

const scanSteps = [
  {
    text: "Please look forward",
    orientation: "straight",
  },
  {
    text: "Please look right",
    orientation: "right",
  },
  {
    text: "Please look left",
    orientation: "left",
  },
];

let timeOutScan;

function captureFrame(orientation) {
  const video = document.querySelector("#face-scan-container > video");
  if (!video) return null;

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");

  // Flip horizontally for mirror effect
  ctx.translate(canvas.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  return {
    orientation: orientation,
    dataUrl: canvas.toDataURL("image/png"),
  };
}

function nextStep() {
  currentStepIndex++;
  if (currentStepIndex < scanSteps.length) {
    $("#scan-helper-text").text(scanSteps[currentStepIndex].text);

    // Calculate progress percentage based on completed steps
    const progressPercentage = currentStepIndex * (100 / scanSteps.length);
    $("#scan-progress").css("width", `${progressPercentage}%`);
  }
}

const postData = {
  "event": "kahf",
  "id": "1756873534386",
  "sources": [],
  "landmarks": [""],
};

const baumanType = [
  {"name": "DRNT", "desc": "Dry Resistant Non-Pigmented Tight", "bg": "#90b9df", "definition": "The DNRT Skin Type is Dry, Non-Pigmented, Resistant, and Tight. The main barrier to skin health is dehydration. Unlike pigmented skin types, DNRT does not commonly experience hyperpigmentation or dark spots. However, dryness and tightness lead to discomfort, rough texture, and increased visibility of fine lines if not managed properly.", "solution": "Gentle cleansing: Mild, low-pH cleansers that do not strip essential moisture. Daily moisturization: Rich hydrating creams or lotions to lock in water and prevent transepidermal water loss (TEWL). Sun protection: Lightweight sunscreens to prevent premature aging and collagen loss."}, //0

  {"name": "DRNW", "desc": "Dry Resistant Non-Pigmented Wrinkle Prone", "bg": "#b3a8d3", "definition": "Tipe kulit DRNW adalah Dry (kering), Resistant (tahan/sulit iritasi), Non pigmented (berpigmen/mudah muncul noda), dan Wrinkled (mudah keriput). Tantangan utamanya ada pada kesehatan kulit: dehidrasi dan penuaan.", "solution": "Tipe kulit ini sebaiknya menggunakan pembersih wajah mild dan sunscreen dengan proteksi minimal SPF 15 dan melakukan re-apply. Pelembap diperlukan untuk membantu menghidrasi kulit. Antioksidan juga bagus untuk meningkatkan proteksi kulit."}, //1

  {"name": "DRPT", "desc": "Dry Resistant Pigmented Tight", "bg": "#2e99b8", "definition": "The DRPT Skin Type is Dry, Resistant, Pigmented, and Tight, with two barriers to skin health: dehydration and uneven pigmentation. The two main concerns, dryness and pigmentation, tend to go hand-in-hand, as itching and inflammation caused by dryness can result in hyperpigmentation.", "solution": "Moisture restoration: Use humectants (glycerin, hyaluronic acid, pentavitin) and barrier-repairing actives (ceramides, beta-glucan). Pigmentation control: Regular sunscreen, antioxidants (niacinamide, vitamin C, carnosine), and tone-evening ingredients. Mild cleansing: Avoid high-pH or harsh foaming cleansers, switch to gentle amino acid-based face wash. Daily sun protection: Essential to prevent worsening pigmentation and dryness. Lifestyle adjustments: Increase water intake, balanced diet rich in antioxidants, consistent skincare regimen."}, //2

  {"name": "DRPW", "desc": "Dry Resistant Pigmented Wrinkle Prone", "bg": "#4e7fb9", "definition": "Tipe kulit DRPW adalah Dry (kering), Resistant (tahan/sulit iritasi), Pigmented (berpigmen/mudah muncul noda), dan Wrinkled (mudah keriput). Tantangan utamanya ada pada kesehatan kulit: dehidrasi, pigmentasi, dan penuaan.", "solution": "Tipe kulit ini sebaiknya menggunakan pembersih wajah mild dan sunscreen dengan proteksi minimal SPF 15 dan melakukan re-apply. Pelembap diperlukan untuk membantu menghidrasi kulit. Bahan pencerah kulit dan antioksidan juga dapat membantu meningkatkan penampilan kulit tipe ini."}, //3

  {"name": "DSNT", "desc": "Dry Sensitive Non-Pigmented Tight", "bg": "#f78fb8", "definition": "The DSNT Skin Type is Dry, Sensitive, Non-Pigmented, and Tight. Its two barriers to skin health are dehydration and sensitivity. Unlike DSPT, pigmentation is not a major issue, but the skin remains prone to dryness, redness, irritation, and discomfort.", "solution": "<ul> <li><strong>Kahf Amino Gel Face Wash</strong> → Mild, non-irritating cleanser for sensitive, dry skin.</li> <li><strong>Kahf Brightening Serum</strong> → Niacinamide-based solution for pigmentation without irritation.</li> <li><strong>Kahf Moisturizer Sunscreen</strong> → Lightweight sun protection suitable for sensitive skin.</li> </ul>"}, //4

  {"name": "DSNW", "desc": "Dry Sensitive Non-Pigmented Wrinkle Prone", "bg": "#f2b5a7", "definition": "Tipe kulit DSNW adalah Dry (kering), Sensitive (mudah iritasi), Non pigmented (berpigmen/mudah muncul noda), dan Wrinkled (mudah keriput). Tantangan utamanya ada pada kesehatan kulit: dehidrasi, peradangan, dan penuaan.  Mayoritas tipe ini memiliki jerawat atau tanda-tanda penuaan akibat paparan matahari (photoaging).", "solution": "Tipe kulit ini sebaiknya menggunakan pembersih wajah mild dan sunscreen dengan proteksi minimal SPF 15 dan melakukan re-apply. Pelembap diperlukan untuk membantu menghidrasi kulit. Bahan anti inflamasi juga diperlukan untuk meredakan gejala inflamasi yang mungkin terjadi pada tipe kulit ini."}, //5

  {"name": "DSPT", "desc": "Dry Sensitive Pigmented Tight", "bg": "#c469aa", "definition": "The DSPT Skin Type is Dry, Sensitive, Pigmented, and Tight. This means the skin has two barriers to health: dehydration and sensitivity, combined with a tendency toward uneven pigmentation. Dryness and pigmentation often go hand-in-hand, while sensitivity increases the risk of irritation, redness, and damage from environmental stressors.", "solution": "<ul><li>Kahf Amino Gel Face Wash → Mild, non-irritating cleanser for sensitive, dry skin.</li><li>Kahf Brightening Serum → Niacinamide-based solution for pigmentation without irritation.</li><li>Kahf Moisturizer Sunscreen → Lightweight sun protection suitable for sensitive ski</li></ul>"}, //6

  {"name": "DSPW", "desc": "Dry Sensitive Pigmented Wrinkle Prone", "bg": "#f16788", "definition": "Tipe kulit DSPW adalah Dry (kering), Sensitive (mudah iritasi), Pigmented (berpigmen/mudah muncul noda), dan Wrinkled (mudah keriput). Jenis kulit DSPW adalah salah satu jenis kulit yang paling kompleks dan menantang untuk ditangani, karena terdapat empat hambatan kesehatan kulit: dehidrasi, inflamasi, pigmentasi, dan penuaan. Banyak pemilik jenis kulit DSPW juga berjuang melawan jerawat atau rosacea.", "solution": "Tipe kulit ini sebaiknya menggunakan pembersih wajah mild dan sunscreen dengan proteksi minimal SPF 15 dan melakukan re-apply. Pelembap diperlukan untuk membantu menghidrasi kulit. Bahan pencerah kulit dan antioksidan juga dapat membantu meningkatkan penampilan kulit.  Bahan anti inflamasi juga diperlukan untuk meredakan gejala inflamasi yang mungkin terjadi pada tipe kulit ini."}, //7

  {"name": "ORNT", "desc": "Oily Resistant Non-Pigmented Tight", "bg": "#a1d4be", "definition": "Tipe kulit ORNT adalah Oily (berminyak), Resistant (tahan/sulit iritasi), Non-Pigmented (tidak mudah muncul noda), dan Tight (tahan  keriput). ORNT adalah kulit normal, sehingga mudah untuk dirawat.", "solution": "Tipe kulit ORNT sebaiknya menggunakan cleanser berbusa dan salicylic acid untuk membantu mengontrol produksi minyak berlebih sekaligus menjaga pori-pori tetap bersih. Untuk membantu penyerapan skincare, gunakan pelembap ringan yang mengandung Hyaluronic Acid."}, //8

  {"name": "ORNW", "desc": "Oily Resistant Non-Pigmented Wrinkle Prone", "bg": "#a1d4be", "definition": "Tipe kulit ORNW adalah Oily (berminyak), Resistant (tahan/sulit iritasi), Non-Pigmented (tidak mudah muncul noda), dan Wrinkled (rentan keriput). Tantangan utamanya hanya satu, yaitu penuaan. Tipe kulit ini sebenarnya cukup ideal untuk usia 30 tahun ke atas, karena di usia ini tanda-tanda penuaan alami mulai terlihat akibat akumulasi sinar matahari dan proses aging.", "solution": "Tipe kulit ORNW sebaiknya menggunakan cleanser berbusa dan salicylic acid untuk membantu mengontrol produksi minyak berlebih sekaligus menjaga pori-pori tetap bersih. Untuk membantu penyerapan skincare, gunakan pelembap ringan yang mengandung Hyaluronic Acid. Kulit ORNW umumnya cukup kuat sehingga bisa mentoleransi antioksidan (Vitamin C), retinoid, dan produk anti-aging lainnya. Gunakan skincare dengan ingredients diatas bersamaan dengan sunscreen untuk membantu mengurangi keriput."}, //9

  {"name": "ORPT", "desc": "Oily Resistant Pigmented Tight", "bg": "#83c15d", "definition": "Tipe kulit ORPT adalah Oily (berminyak), Resistant (tahan/sulit iritasi), Pigmented (berpigmen/mudah muncul noda), dan Tight (sulit keriput). Tantangan utamanya ada pada pigmentasi dan oily. Kulit ORPT biasanya nggak punya masalah kering atau sensitif, tapi sering berhadapan dengan warna kulit tidak merata dan berminyak.", "solution": "Tipe kulit ORPT adalah Oily (berminyak), Resistant (tahan/sulit iritasi), Pigmented (berpigmen/mudah muncul noda), dan Tight (sulit keriput). Tantangan utamanya ada pada pigmentasi dan oily. Kulit ORPT biasanya nggak punya masalah kering atau sensitif, tapi sering berhadapan dengan warna kulit tidak merata dan berminyak.."}, //10

  {"name": "ORPW", "desc": "Oily Resistant Pigmented Wrinkle Prone", "bg": "#2e99b8", "definition": "Tipe kulit ORPW adalah Oily (berminyak), Resistant (tahan/sulit iritasi), Pigmented (berpigmen/mudah muncul noda), dan Wrinkled (mudah keriput). Tantangan utamanya ada pada pigmentasi dan kerutan. Kulit ORPW biasanya nggak punya masalah kering atau sensitif, tapi sering berhadapan dengan warna kulit tidak merata dan tanda penuaan dini seperti garis halus, keriput, atau kulit yang mulai kendur.", "solution": "Tipe kulit ORPW adalah Oily (berminyak), Resistant (tahan/sulit iritasi), Pigmented (berpigmen/mudah muncul noda), dan Wrinkled (mudah keriput). Tantangan utamanya ada pada pigmentasi dan kerutan. Kulit ORPW biasanya nggak punya masalah kering atau sensitif, tapi sering berhadapan dengan warna kulit tidak merata dan tanda penuaan dini seperti garis halus, keriput, atau kulit yang mulai kendur."}, //11

  {"name": "OSNT", "desc": "Oily Sensitive Non-Pigmented Tight", "bg": "#fdd6b9", "definition": "OSNT memiliki kulit berminyak dan sensitif, namun dengan warna kulit cerah merata tanpa bintik gelap, dan kulit kencang tanpa kerutan.", "solution": "<ul> <li>Perawatan kulit yang seimbang antara kontrol minyak dan kelembapan.</li> <li>Hindari bahan iritan; gunakan produk yang lembut dan tidak menyumbat.</li> <li>Sertakan bahan penenang dan antiinflamasi; selalu gunakan tabir surya.</li> </ul>"}, //12

  {"name": "OSNW", "desc": "Oily Sensitive Non-Pigmented Wrinkle Prone", "bg": "#ffe3a3", "definition": "OSNW adalah kulit berminyak dan sensitif, tetapi dengan warna merata dan rentan berkerut.", "solution": "<ul> <li>Tambahkan antioksidan topikal, retinoid malam hari, dan bahan antiinflamasi.</li> <li>Fokus pada barrier support untuk mengelola sensitivitas dan minyak.</li> <li>Gunakan tabir surya setiap hari.</li> </ul>"}, //13
  
  {"name": "OSPT", "desc": "Oily Sensitive Pigmented Tight", "bg": "#f7966e", "definition": "Kulit OSPT ditandai dengan produksi minyak berlebih, sensitif, memiliki kulit lebih gelap dan pigmentasi tidak merata (seperti bintik gelap), namun tetap kencang dan tidak berkerut.", "solution": "<ul><li>Gunakan produk dengan oil control dan anti inflamasi (Salicylic acid, Zinc PCA, Centella Asiatica, dll)</li> <li>Produk-produk gentle, dari sabun cuci muka hingga serum</li>Menggunakan pelembap yang ringan dan tidak menyumbat pori<li>Surfactant Cleanser, Low pH, mild exfoliation</li></ul>"}, //14

  {"name": "OSPW", "desc": "Oily Sensitive Pigmented Wrinkle Prone", "bg": "#fcb85c", "definition": "Kulit OSPW berminyak, sensitif, memiliki pigmentasi tidak merata, dan rentan berkerut.", "solution": "<ul><li>Gunakan bahan antiinflamasi (Salicylic Acid, Zinc Gluconate), pencerah (vitamin C, Gluconolactone), dan anti-penuaan (retinoid, antioksidan).</li> <li>Pilih pelembap ringan; hindari minyak yang menyumbat (misalnya kelapa, evening primrose).</li><li>Terapkan tabir surya setiap hari.</li></ul>"}, //15
];

// ------------------ determineBaumann(metrics, options) ------------------
function determineBaumann(metrics, options = {}) {
  const debug = !!options.debug;

  // helper: read numeric metric safely (accept array of keys or single key)
  function getVal(keyOrList) {
    if (!metrics) return 0;
    if (Array.isArray(keyOrList)) {
      for (let i = 0; i < keyOrList.length; i++) {
        const k = keyOrList[i];
        const v = Number(metrics[k]);
        if (!isNaN(v)) return Math.max(0, Math.min(100, Math.round(v)));
      }
      return 0;
    } else {
      const v = Number(metrics[keyOrList]);
      return isNaN(v) ? 0 : Math.max(0, Math.min(100, Math.round(v)));
    }
  }

  // ---------- Evaluators using boolean-style pattern ----------

  function evalOD() { // Oily (O) vs Dry (D)
    const sebumT = getVal('sebum_t');
    const sebumU = getVal('sebum_u');
    const largePores = getVal('largepores_detection');
    const blackhead = getVal('blackhead_detection');

    // Dry when sebumT & sebumU <50 AND enlarged pores <50 AND blackhead <20
    const isDry = (sebumT < 50) && (sebumU < 50) && (largePores < 50) && (blackhead < 20);
    const letter = isDry ? 'D' : 'O';

    return {
      letter,
      checks: [
        { metric: 'sebum_t', expectedOp: '<', expectedValue: 50, actual: sebumT, pass: sebumT < 50 },
        { metric: 'sebum_u', expectedOp: '<', expectedValue: 50, actual: sebumU, pass: sebumU < 50 },
        { metric: 'largepores_detection', expectedOp: '<', expectedValue: 50, actual: largePores, pass: largePores < 50 },
        { metric: 'blackhead_detection', expectedOp: '<', expectedValue: 20, actual: blackhead, pass: blackhead < 20 }
      ]
    };
  }

  function evalSR() { // Sensitive (S) vs Resistant (R)
    // your example logic: if acne<50 OR redness<50 OR acneScar<20 => Resistant (R) else Sensitive (S)
    let acne = getVal('acne_detection') < 50;
    // let redness = getVal(['redness_detection','redness_detection']) < 50;
    let redness = getVal('redness_detection') < 50;
    let acneScar = getVal('acnescar_detection') < 20;

    let letter = (acne || redness || acneScar) ? 'R' : 'S';

    return {
      letter,
      checks: [
        { metric: 'acne_detection', expectedOp: '<', expectedValue: 50, actual: getVal('acne_detection'), pass: getVal('acne_detection') < 50 },
        // { metric: 'redness_detection', expectedOp: '<', expectedValue: 50, actual: getVal(['redness_detection','redness_detection']), pass: getVal(['redness_detection','redness_detection']) < 50 },
        { metric: 'redness_detection', expectedOp: '<', expectedValue: 50, actual: getVal('redness_detection'), pass: getVal('redness_detection') < 50 },
        { metric: 'acnescar_detection', expectedOp: '<', expectedValue: 20, actual: getVal('acnescar_detection'), pass: getVal('acnescar_detection') < 20 }
      ]
    };
  }

  function evalNP() { // Non-Pigmented (N) vs Pigmented (P)
    const darkspot = getVal('darkspot_detection');
    const hyper = getVal('hyperpigmentation_detection_unet');
    const dullness = getVal('dullness_detection');
    const eyebags = getVal('eyebags_detection');

    // Non-Pigmented if darkspot <50 AND hyper <50 AND dullness <20 AND eyebags <50
    const isNonPigmented = (darkspot < 50) && (hyper < 50) && (dullness < 20) && (eyebags < 50);
    const letter = isNonPigmented ? 'N' : 'P';

    return {
      letter,
      checks: [
        { metric: 'darkspot_detection', expectedOp: '<', expectedValue: 50, actual: darkspot, pass: darkspot < 50 },
        { metric: 'hyperpigmentation_detection_unet', expectedOp: '<', expectedValue: 50, actual: hyper, pass: hyper < 50 },
        { metric: 'dullness_detection', expectedOp: '<', expectedValue: 20, actual: dullness, pass: dullness < 20 },
        { metric: 'eyebags_detection', expectedOp: '<', expectedValue: 50, actual: eyebags, pass: eyebags < 50 }
      ]
    };
  }

  function evalTW() { // Tight (T) vs Wrinkle-prone (W)
    const wrinkles = getVal('wrinkle_detection');
    const finelines = getVal('finelines_detection');
    const aging = getVal('predicted_age');
    const lossFirmness = getVal('lossfirmness');

    // Wrinkle-prone if any aging indicator OR loss of firmness exceed thresholds
    const isWrinkled = (wrinkles > 21) || (finelines > 21) || (aging > 21) || (lossFirmness > 20);
    const letter = isWrinkled ? 'W' : 'T';

    return {
      letter,
      checks: [
        { metric: 'wrinkle_detection', expectedOp: '>', expectedValue: 21, actual: wrinkles, pass: wrinkles > 21 },
        { metric: 'finelines_detection', expectedOp: '>', expectedValue: 21, actual: finelines, pass: finelines > 21 },
        { metric: 'predicted_age', expectedOp: '>', expectedValue: 21, actual: aging, pass: aging > 21 },
        { metric: 'lossfirmness', expectedOp: '>', expectedValue: 20, actual: lossFirmness, pass: lossFirmness > 20 }
      ]
    };
  }

  // ---------- Run evaluators ----------
  const od = evalOD();
  const sr = evalSR();
  const np = evalNP();
  const tw = evalTW();

  const code = `${od.letter}${sr.letter}${np.letter}${tw.letter}`;

  // flatten reason array for console table & UI consumption
  const reason = []
    .concat(od.checks || [])
    .concat(sr.checks || [])
    .concat(np.checks || [])
    .concat(tw.checks || []);

  const result = { matched: true, code: code, reason: reason, parts: { od, sr, np, tw } };

  if (debug) {
    console.log('determineBaumann() debug => code:', code);
    console.table(reason.map((r,i)=>({
      '#': i+1, metric: r.metric, expectedOp: r.expectedOp, expectedValue: r.expectedValue, actual: r.actual, pass: !!r.pass
    })));
  }

  return result;
}


// -------------------- completeScanSkin() (clean, no keyMetrics) --------------------
async function completeScanSkin() {
  try {
    $(".scan-helper-text").text("Analyzing...");
    $("#scan-progress").css("width", "100%");
    showScreen('loadingScreen');

    console.log('Posting data:', postData);

    const resp = await fetch('/api/analyze_v3', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(postData)
    });
    if (!resp.ok) throw new Error('Network response was not ok: ' + resp.status);
    const data = await resp.json();
    console.log('API response received');

    const baseUrl = data.baseUrl || '';

    // helper: find image object by detection type
    function findImageByDetectionType(allViews, detectionType) {
      if (!Array.isArray(allViews)) return null;
      for (let v = 0; v < allViews.length; v++) {
        const view = allViews[v];
        for (let i = 0; i < view.length; i++) {
          const obj = view[i];
          if (!obj) continue;
          if (obj.id && obj.id === detectionType) return obj;
          if (typeof obj[detectionType] !== 'undefined') return obj;
          if ((detectionType === 'sebum_t' || detectionType === 'sebum_u') && (obj.sebum_t || obj.sebum_u)) return obj;
        }
      }
      return null;
    }

    // update tab images
    const tabMapping = {
      "tabcontent-darkspot": "darkspot_detection",
      "tabcontent-acne": "acne_detection",
      "tabcontent-pore": "largepores_detection",
      "tabcontent-acne-scars": "acnescar_detection",
      "tabcontent-dullness": "dullness_detection",
      "tabcontent-wrinkles": "wrinkle_detection",
      "tabcontent-eyebags": "eyebags_detection",
      "tabcontent-finelines": "finelines_detection",
      "tabcontent-hyperpigmentation": "hyperpigmentation_detection_unet",
      "tabcontent-loss-firmness": "lossfirmness",
      "tabcontent-pigmen": "brownlight_image",
      "tabcontent-colagen": "negative_image",
      "tabcontent-aging": "predicted_age",
    };

    Object.keys(tabMapping).forEach((tabId) => {
      const detectionType = tabMapping[tabId];
      const tabElement = document.getElementById(tabId);
      if (!tabElement) return;
      const imgElement = tabElement.querySelector(".image-face-skin-result img");
      if (!imgElement) return;
      const imageData = findImageByDetectionType(data.data, detectionType);
      if (imageData && imageData.image) {
        imgElement.src = (baseUrl ? baseUrl.replace(/\/+$/,'') : '') + '/' + imageData.image.replace(/^\/+/, '');
      }
    });

    // diagnostic small images
    const diagnosticImages = document.querySelectorAll(".face-side img");
    if (diagnosticImages.length >= 3 && Array.isArray(data.data)) {
      if (data.data[0] && data.data[0][0] && data.data[0][0].image) diagnosticImages[0].src = (baseUrl ? baseUrl.replace(/\/+$/,'') : '') + '/' + data.data[0][0].image.replace(/^\/+/, '');
      if (data.data[1] && data.data[1][0] && data.data[1][0].image) diagnosticImages[1].src = (baseUrl ? baseUrl.replace(/\/+$/,'') : '') + '/' + data.data[1][0].image.replace(/^\/+/, '');
      if (data.data[2] && data.data[2][0] && data.data[2][0].image) diagnosticImages[2].src = (baseUrl ? baseUrl.replace(/\/+$/,'') : '') + '/' + data.data[2][0].image.replace(/^\/+/, '');
    }

    // render bars (uses your existing function)
    let updateResult = {};
    if (typeof updateResultBarsFromResponseJQ === 'function') {
      try { updateResult = updateResultBarsFromResponseJQ(data, 5) || {}; }
      catch (err) { console.warn('updateResultBarsFromResponseJQ error', err); updateResult = {}; }
    }

    const metricsMapRaw = (updateResult && updateResult.metricsPercentMap) ? updateResult.metricsPercentMap : (window.latestMetricsPercentMap || {});
    function normalizeMetrics(m) {
      const norm = Object.assign({}, m || {});
      if (typeof norm['darkspot'] !== 'undefined' && typeof norm['darkspot_detection'] === 'undefined') norm['darkspot_detection'] = norm['darkspot'];
      if (typeof norm['acne'] !== 'undefined' && typeof norm['acne_detection'] === 'undefined') norm['acne_detection'] = norm['acne'];
      if (typeof norm['pore'] !== 'undefined' && typeof norm['largepores_detection'] === 'undefined') norm['largepores_detection'] = norm['pore'];
      if (typeof norm['lossfirm'] !== 'undefined' && typeof norm['lossfirmness'] === 'undefined') norm['lossfirmness'] = norm['lossfirm'];
      if (norm['sebum_t'] && typeof norm['sebum_t'] === 'object' && typeof norm['sebum_t'].strength === 'number') norm['sebum_t'] = clampPercent(norm['sebum_t'].strength * 100);
      if (norm['sebum_u'] && typeof norm['sebum_u'] === 'object' && typeof norm['sebum_u'].strength === 'number') norm['sebum_u'] = clampPercent(norm['sebum_u'].strength * 100);
      Object.keys(norm).forEach(k => { const n = Number(norm[k]); if (!isNaN(n)) norm[k] = Math.max(0, Math.min(100, Math.round(n))); });
      return norm;
    }
    let metricsMap = normalizeMetrics(metricsMapRaw);

    // for testing bauman logic
    // metricsMap= {
    //   sebum_t: 40,
    //   sebum_u: 42,
    //   hyperpigmentation_detection_unet: 72,
    //   darkspot_detection: 60,
    //   finelines_detection: 10,
    //   wrinkle_detection: 15,
    //   predicted_age: 18
    // };

    // determine baumann
    const baumannRes = determineBaumann(metricsMap, { debug: false });
    
    // --- Print Baumann summary + detail tables (NO keyMetrics) ---
    (function printBaumannTables(metricsMapLocal, baumannResLocal) {
      // 1) Summary table (all evaluated rules). Prefer baumannResLocal.evaluated else window.baumannEvaluated
      const evaluated = (baumannResLocal && Array.isArray(baumannResLocal.evaluated)) ? baumannResLocal.evaluated : (window.baumannEvaluated || []);
      if (evaluated && evaluated.length) {
        const summary = evaluated.map(ev => ({
          code: ev.code,
          passed: ev.passedCount,
          total: ev.total,
          ratio: Math.round((ev.ratio || 0) * 100) + '%'
        }));
        console.log('Baumann rules summary:');
        console.table(summary);
      } else {
        console.log('No evaluated Baumann rules to summarize.');
      }

      // 2) Detail table: conditions for exact match or best candidate
      // prefer exact match reason -> baumannResLocal.reason, else baumannResLocal.best.details,
      // else fallback to top evaluated condResults in window.baumannEvaluated
      let condList = [];
      if (baumannResLocal && baumannResLocal.reason && Array.isArray(baumannResLocal.reason) && baumannResLocal.reason.length) {
        condList = baumannResLocal.reason;
      } else if (baumannResLocal && baumannResLocal.best && Array.isArray(baumannResLocal.best.details) && baumannResLocal.best.details.length) {
        condList = baumannResLocal.best.details;
      } else if (Array.isArray(evaluated) && evaluated.length) {
        // fallback: take top candidate's condResults
        const top = evaluated.slice().sort((a,b) => b.ratio - a.ratio)[0];
        if (top && Array.isArray(top.condResults)) condList = top.condResults;
      }

      // Build rows with exact technical headers
      const rows = [];
      if (Array.isArray(condList) && condList.length) {
        condList.forEach((c, idx) => {
          rows.push({
            '#': idx + 1,
            'metric': c.metric || '',
            'expectedOp': (c.expectedOp || c.op || ''),
            'expectedValue': (typeof c.expectedValue !== 'undefined' ? c.expectedValue : (typeof c.value !== 'undefined' ? c.value : '')),
            'actual': (typeof c.actual !== 'undefined' ? c.actual : ''),
            'pass': !!c.pass
          });
        });

        console.log('Baumann condition details (technical headers):');
        console.table(rows);
      } else {
        console.log('No condition details found for Baumann (no reason/best/details available).');
      }
    })(metricsMap, baumannRes);

        
    let chosenCode = null;
    if (baumannRes && baumannRes.matched) chosenCode = baumannRes.code;
    else if (baumannRes && baumannRes.best && baumannRes.best.code) chosenCode = baumannRes.best.code;
    else chosenCode = (baumannRes && baumannRes.code) ? baumannRes.code : 'UNKNOWN';

    let matched = Array.isArray(baumanType) ? baumanType.find(b => b && b.name === chosenCode) : null;
    if (!matched) matched = Array.isArray(baumanType) ? baumanType.find(b => b && (b.name || '').toLowerCase() === (chosenCode || '').toLowerCase()) : null;
    if (!matched) matched = { name: chosenCode || 'UNKNOWN', desc: '', bg: '#dddddd', definition: '', solution: '' };

    // UI update
    $('.right-result-intro').css('background-color', matched.bg || '#ddd');
    $('.right-result-intro h2').text(matched.name || chosenCode);
    $('.right-result-intro p').text(matched.desc || '');
    $('.definition-parameter p').html(matched.definition || '');
    $('.solution-parameter p').html(matched.solution || '');

    // ensure default parameter active -> darkspot
    (function activateDefaultParameter() {
      const metricKey = 'darkspot_detection';
      let percent = 0;
      if (metricsMap && typeof metricsMap[metricKey] === 'number') percent = metricsMap[metricKey];
      else if (window.latestMetricsPercentMap && typeof window.latestMetricsPercentMap[metricKey] === 'number') percent = window.latestMetricsPercentMap[metricKey];
      else {
        const safeClass = 'bar-' + metricKey.replace(/[^a-z0-9]/gi, '-').toLowerCase();
        const $barByClass = $('.' + safeClass).first();
        if ($barByClass.length) percent = parseInt($barByClass.attr('data-value')) || parseInt($barByClass.data('value')) || 0;
      }
      percent = clampPercent(percent);

      // updateParameterUI expects canonical metric keys in our setup — pass canonical id
      try { updateParameterUI(metricKey, percent); } catch (e) { try { updateParameterUI('darkspot', percent); } catch(e2){} }

      // activate side tab robustly
      let $btn = $('#tabWrapper .nav-link[data-metric="' + metricKey + '"]').first();
      if (!$btn.length) $btn = $('#tabWrapper .nav-link[data-bs-target="#tabcontent-darkspot"]').first();
      if (!$btn.length) $btn = $('#tabWrapper .nav-link').filter(function(){ const txt = ($(this).text()||'').toLowerCase(); return txt.indexOf('dark')!==-1 || txt.indexOf('spot')!==-1; }).first();
      if ($btn.length) {
        try {
          if (typeof bootstrap !== 'undefined' && bootstrap.Tab) { new bootstrap.Tab($btn[0]).show(); }
          else $btn.trigger('click');
        } catch(e) { $btn.trigger('click'); }
      } else {
        const $first = $('#tabWrapper .nav-link').first();
        if ($first.length) { try { if (typeof bootstrap !== 'undefined' && bootstrap.Tab) new bootstrap.Tab($first[0]).show(); else $first.trigger('click'); } catch(e){ $first.trigger('click'); } }
      }

      // highlight summary bar if present
      const safeClass2 = 'bar-' + metricKey.replace(/[^a-z0-9]/gi, '-').toLowerCase();
      const $summaryBar = $('.' + safeClass2).first();
      if ($summaryBar.length) { $('.bars .progress-bar').removeClass('active-bar'); $summaryBar.addClass('active-bar'); }
    })();

    // Example: collected skin metrics from scan model output
    // const metrics = {
    //   acne_detection: 12.5,
    //   acnescar_detection: 8.7,
    //   darkspot_detection: 15.2,
    //   wrinkle_detection: 5.3,
    //   largepores_detection: 9.1,
    //   finelines_detection: 6.4,
    //   dullness_detection: 10.2,
    //   eyebags_detection: 7.8,
    //   hyperpigmentation_detection_unet: 11.6,
    //   lossfirmness: 8.0,
    //   unseen_dark_spot: 9.5,
    //   potential_acne: 12.1,
    //   sensitivity_detection: 7.2,
    //   sebum_u: 42.5,
    //   sebum_t: 55.3,
    //   blackhead_detection: 10.8,
    //   redness_detection: 45,
    //   predicted_age: 27,
    // };

    // --- Build payload for backend ---
    const full_name = localStorage.getItem("full_name");
    const phone = localStorage.getItem("phone");
    const age = localStorage.getItem("age");

    // ✅ Combine all data
    payload.full_name = full_name;
    payload.phone = phone;
    payload.age = age;
    payload.acne = metricsMap.acne_detection;
    payload.acne_scar = metricsMap.acnescar_detection;
    payload.dark_spot = metricsMap.darkspot_detection;
    payload.acne = metricsMap.acne_detection;
    payload.acne_scar = metricsMap.acnescar_detection;
    payload.dark_spot = metricsMap.darkspot_detection;
    payload.wrinkle = metricsMap.wrinkle_detection;
    payload.enlarge_pores = metricsMap.largepores_detection;
    payload.fineline = metricsMap.finelines_detection;
    payload.dullness = metricsMap.dullness_detection;
    payload.eyebag = metricsMap.eyebags_detection;
    payload.hyperpigment = metricsMap.hyperpigmentation_detection_unet;
    payload.loss_firmness = metricsMap.lossfirmness;
    payload.unseen_dark_spot = metricsMap.unseen_dark_spot;
    payload.potential_acne = metricsMap.potential_acne;
    payload.sensitivity = metricsMap.sensitivity_detection;
    payload.skin_age = metricsMap.predicted_age;
    payload.sebum_u = metricsMap.sebum_u;
    payload.sebum_t = metricsMap.sebum_t;
    payload.blackhead = metricsMap.blackhead_detection;
    payload.photo_path = straightFaceSrc;

    console.log(payload);

    // --- POST to backend ---
    fetch("https://192.168.31.64:2006/api/skin_result", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    })
  .then(res => res.json())
  .then(data => {
    console.log("✅ Skin result saved:", data);
    // show result page
    showScreen("pageResultSkin");
  })
  .catch(err => {
    console.error("❌ Failed to save result:", err);
  });

    setTimeout(() => {
      $('.hint-summary').fadeIn(300);
    }, 800);

    return { success: true, metricsMap, baumannRes, matched };
  } catch (err) {
    console.error('Error in completeScanSkin():', err);
    $(".scan-helper-text").text("Analysis failed");
    showScreen('pageResultSkin');
    return { success: false, error: err };
  }
}

$('.hint-summary').fadeIn(300);

var hintCount = 0;
$('.hint-wrapper').on('click', function() {
  hintCount++
  $('.hint-summary').fadeOut(300, function() {
    $('.hint-analysis').fadeIn(300);
    $('.parent-tabs .nav-item:first-child .nav-link').css('text-indent', 'unset');
    $('.parent-tabs .nav-item:last-child .nav-link').css('text-indent', '-9999px');
  })
  
  if(hintCount > 1){
    $('.parent-tabs .nav-item:last-child .nav-link').css('text-indent', 'unset');
    $(this).fadeOut(300);
    $('.result-inner-wrapper').css({'opacity': 1, 'pointer-events': 'unset'});
    $('.parent-tabs .nav-link').css('opacity', '1');
    setTimeout(() => {
      $('.parent-tabs .nav-item:last-child .nav-link').css('text-indent', 'unset');
    }, 0);
  }
})

// ---------- CONFIG / HELPERS ----------
var labelMap = {
  'acne_detection': 'Acne',
  'darkspot_detection': 'Dark Spot',
  'blackhead_detection': 'Blackhead',
  'largepores_detection': 'Pores',
  'acnescar_detection': 'Acne Scars',
  'dullness_detection': 'Dullness',
  'predicted_age': 'Aging',
  'lossfirmness': 'Loss of Firmness',
  'redness_detection': 'Redness',
  'brownlight_image': 'Unseen Darkspot',
  'sebum_t': 'Sebum (T)',
  'sebum_u': 'Sebum (U)',
  'hyperpigmentation_detection_unet': 'Hyperpigmentation'
};

function severityColor(value){
  var v = Number(value) || 0;
  if (v >= 70) return '#f44336';
  if (v >= 40) return '#ff9800';
  return '#4caf50';
}

function clampPercent(v){ return Math.max(0, Math.min(100, Math.round(v))); }

// replace existing updateParameterUI with this (jQuery)
function updateParameterUI(metricId, percent) {
  percent = clampPercent(percent);

  // friendly label
  var label = labelMap[metricId] || (metricId || '').replace(/_/g,' ').replace(/\b\w/g, function(l){ return l.toUpperCase(); });

  // update Definition & Solution blocks
  // if ($('.definition-parameter p').length) {
  //   $('.definition-parameter p').text(definitionMap[metricId] || 'Definition not available.');
  // }
  // if ($('.solution-parameter p').length) {
  //   $('.solution-parameter p').text(solutionMap[metricId] || 'Solution not available.');
  // }

  // heading
  // $('.result-parameter h2').text('Parameter: ' + label);

  // target container
  var $container = $('.gradien-parameter');
  if ($container.length === 0) {
    var $rp = $('.result-parameter.bars').first();
    $rp.append('<div class="gradien-parameter"></div>');
    $container = $rp.find('.gradien-parameter').first();
  }

  // clear and rebuild bar
  $container.empty();

  var color = severityColor(percent);
  var safeClass = 'param-' + (metricId || 'param').replace(/[^a-z0-9]/gi,'-').toLowerCase();

  var $wrapper = $('<div class="bar-wrapper"></div>');
  var $progress = $('<div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>');

  var $bar = $('<div></div>')
    .addClass(safeClass + ' progress-bar')
    .attr('data-value', percent)
    .css({
      'width': (percent > 0 ? '0%' : '0%'), // start at 0 no matter what
      'background-color': color
    })
    .html(label.replace('Negative Image', 'COLLAGEN').replace('Dark Spot', 'DARKSPOT').replace('Detection', '') + ' <div class="bar-value">' + percent + '%</div>');

  $progress.append($bar);
  $wrapper.append($progress);
  $container.append($wrapper);

  // Animate width if > 0, else just keep it at 0
  $bar[0].offsetWidth; // reflow
  $bar.css('transition', 'width 600ms cubic-bezier(.2,.9,.2,1)');
  setTimeout(function(){
    $bar.css('width', percent + '%'); // works even if 0, will "stay" at 0
  }, 20);

  // update aria and text immediately (so 0% shows)
  $progress.attr('aria-valuenow', percent);
  $bar.find('.bar-value').text(percent + '%');

  // after transition ensure correct value
  $bar.on('transitionend', function(){
    $progress.attr('aria-valuenow', percent);
    $bar.find('.bar-value').text(percent + '%');
  });
}

// ✅ when clicking nav tabs inside SKIN ANALYSIS
$('.parent-tabs > .nav-item > .nav-link').on('show.bs.tab', function () {
  $('#tabWrapper .nav-link[data-bs-target="#tabcontent-acne"]').click();
  setTimeout(() => {
    $('#tabWrapper .nav-link[data-bs-target="#tabcontent-darkspot"]').click();
  }, 0);
});

$('[data-bs-target="#tab_summary_report"]').on('show.bs.tab', function() {
  $('.title-section').css('display', 'block');
});

$('[data-bs-target="#tab_skin_analysis"]').on('show.bs.tab', function() {
  $('.title-section').css('display', 'none');
});

// ✅ when clicking nav tabs inside SKIN ANALYSIS
$('#tabWrapper .nav-link').on('shown.bs.tab', function (e) {
  var target = $(e.target).data('bs-target'); // ex: "#tabcontent-darkspot"
  var metricId = target.replace("#tabcontent-", ""); // -> "darkspot"

  // find the % value from summary report bar
  var $bar = $('.bar-' + metricId);
  var percent = $bar.length ? parseInt($bar.data('value')) || 0 : 0;
  updateParameterUI(metricId, percent);
});

// ---------- MAP METRIC TO SIDE TABS (badges + data-metric) ----------
function mapMetricsToSideTabs(metricsObj) {
  // metricsObj: { id: percent, ... }
  // find each tab button under the side scroller and try to match by label
  $('#tabWrapper .nav-link').each(function(){
    var $btn = $(this);
    var txt = ($btn.text() || '').trim().toLowerCase();

    // try to match with labelMap values
    var matchedId = null;
    $.each(labelMap, function(id, label){
      if (txt === (label + '').toLowerCase() || txt.indexOf(label.toLowerCase()) !== -1) {
        matchedId = id;
        return false;
      }
    });

    // fallback: if the button text contains keywords like 'pore' => largepores_detection, 'acne' => acne_detection
    if (!matchedId) {
      if (txt.indexOf('pore') !== -1) matchedId = 'pore';
      if (txt.indexOf('acne') !== -1 && !matchedId) matchedId = 'acne';
      if ((txt.indexOf('dark') !== -1 || txt.indexOf('spot') !== -1) && !matchedId) matchedId = 'darkspot';
      if (txt.indexOf('scar') !== -1 && !matchedId) matchedId = 'acne-scar';
      if (txt.indexOf('dull') !== -1 && !matchedId) matchedId = 'dullness';
      if (txt.indexOf('wrink') !== -1 && !matchedId) matchedId = 'wrinkle';
      if (txt.indexOf('eyebag') !== -1 && !matchedId) matchedId = 'eyebags';
      if (txt.indexOf('fineline') !== -1 || txt.indexOf('fine') !== -1) matchedId = 'finelines';
      if (txt.indexOf('hyper') !== -1 || txt.indexOf('pigmen') !== -1) matchedId = 'hyperpigmentation';
      if (txt.indexOf('firm') !== -1) matchedId = 'lossfirmness';
      if (txt.indexOf('aging') !== -1) matchedId = 'predicted_age';
    }
  });

// robust single handler: resolve canonical metric id then updateParameterUI
$('#tabWrapper .nav-link').off('shown.bs.tab.metric').on('shown.bs.tab.metric', function (e) {
  const $btn = $(e.target);
  let metricId = $btn.attr('data-metric'); // preferred canonical id

  // tab -> canonical mapping if data-metric not present
  if (!metricId) {
    const target = ($btn.attr('data-bs-target') || $btn.data('bs-target') || '').toString().replace('#','').toLowerCase();
    if (target) {
      // if mapping exists (tabcontent-darkspot => darkspot_detection) try to derive:
      const maybe = target.replace(/^tabcontent-/, '');
      const explicitMap = {
        'darkspot': 'darkspot_detection',
        'acne': 'acne_detection',
        'pore': 'largepores_detection',
        'acne-scars': 'acnescar_detection',
        'dullness': 'dullness_detection',
        'wrinkles': 'wrinkle_detection',
        'eyebags': 'eyebags_detection',
        'finelines': 'finelines_detection',
        'hyperpigmentation': 'hyperpigmentation_detection_unet',
        'loss-firmness': 'lossfirmness',
        'pigmen': 'brownlight_image',
        'colagen': 'negative_image',
        'aging': 'predicted_age'
      };
      if (explicitMap[maybe]) metricId = explicitMap[maybe];
      else {
        // try contains match
        for (const k in explicitMap) {
          if (maybe.indexOf(k) !== -1) { metricId = explicitMap[k]; break; }
        }
      }
    }
  }

  // 2) label matching against labelMap and metrics map
  if (!metricId) {
    const txt = ($btn.text() || '').toLowerCase();
    const mm = window.latestMetricsPercentMap || {};
    // first try labelMap exact match
    $.each(labelMap, function(key, label) {
      if (txt.indexOf((label || '').toLowerCase()) !== -1) {
        metricId = key;
        return false;
      }
    });
    // fallback: try metrics map keys (maybe metricKey contains the word)
    if (!metricId) {
      $.each(mm, function(k,v){
        const label = (labelMap[k] || k).toLowerCase();
        if (txt.indexOf(label) !== -1 || (k.toLowerCase().indexOf(txt) !== -1)) {
          metricId = k;
          return false;
        }
      });
    }
  }

  // 3) final fallback: look for bar class containing relevant keyword (e.g. contains 'darkspot')
  if (!metricId) {
    const txt = ($btn.text().re || '').toLowerCase();
    const $candidateBar = $("[class*='bar-']").filter(function(){ return (this.className || '').toLowerCase().indexOf(txt) !== -1; }).first();
    if ($candidateBar.length) {
      // class like 'bar-darkspot-detection' -> derive metric id by reversing class transform:
      const classes = ($candidateBar.attr('class') || '').split(/\s+/);
      for (let i=0;i<classes.length;i++){
        if (classes[i].indexOf('bar-') === 0) {
          // undo 'bar-' and '-' -> '_'
          metricId = classes[i].replace(/^bar-/, '').replace(/-/g, '_');
          break;
        }
      }
    }
  }

  // Now read percent from the canonical metrics map (preferred)
  const metricsMapSource = window.latestMetricsPercentMap || {};
  let percent = null;
  if (metricId && typeof metricsMapSource[metricId] !== 'undefined') {
    percent = metricsMapSource[metricId];
  } else if (metricId) {
    // fallback: try short-name (strip _detection suffix)
    const short = metricId.replace(/_detection$/, '').replace(/_/, '');
    const $barShort = $('.bar-' + short);
    if ($barShort.length) percent = parseInt($barShort.attr('data-value')) || parseInt($barShort.data('value')) || 0;
  }
  percent = (typeof percent === 'number') ? clampPercent(percent) : 0;

  // finally update UI
  if (metricId) updateParameterUI(metricId, percent);
  else {
    // absolute fallback: try to infer from button text by searching any matching metric in map
    const txt = ($btn.text() || '').toLowerCase();
    let found = null;
    $.each(window.latestMetricsPercentMap || {}, function(k,v){
      const label = (labelMap[k] || k).toLowerCase();
      if (txt.indexOf(label) !== -1) { found = { id: k, value: v }; return false; }
    });
    if (found) updateParameterUI(found.id, found.value);
    else updateParameterUI('darkspot_detection', (window.latestMetricsPercentMap && window.latestMetricsPercentMap.darkspot_detection) ? window.latestMetricsPercentMap.darkspot_detection : 0);
  }
});

}

// ---------- MAIN: updateResultBarsFromResponseJQ (updated) ----------
function updateResultBarsFromResponseJQ(response, topN) {
  topN = typeof topN === 'number' ? topN : 5;
  if (!response || !response.data) return { top: [], metricsPercentMap: {} };

  // Helper: extract a numeric "strength" / raw value from item
  function getStrengthFromItem(item) {
    if (!item) return 0;
    if (typeof item.strength === 'number') return item.strength;

    // pick numeric values from other keys (skip meta keys)
    var ignore = { id:1, image:1, boxes:1, overlay:1, raw:1, overlap:1, mask:1, values:1 };
    for (var k in item) {
      if (!item.hasOwnProperty(k) || ignore[k]) continue;
      var v = item[k];
      if (typeof v === "number") return v;
      if (v && typeof v === 'object' && typeof v.strength === 'number') return v.strength;
    }

    // named nested keys
    if (item.sebum_t && typeof item.sebum_t.strength === 'number') return item.sebum_t.strength;
    if (item.sebum_u && typeof item.sebum_u.strength === 'number') return item.sebum_u.strength;
    if (item.redness_detection && typeof item.redness_detection.strength === 'number') return item.redness_detection.strength;
    if (item.brownlight_image && typeof item.brownlight_image.strength === 'number') return item.brownlight_image.strength;

    return 0;
  }

  // Convert a raw numeric score to percent with the described heuristic
  function rawToPercent(raw) {
    raw = Number(raw) || 0;
    if (raw <= 1) {
      // raw is fraction 0..1
      return clampPercent(Math.round(raw * 100));
    } else {
      // raw already in 0..100-ish scale
      return clampPercent(Math.round(raw));
    }
  }

  // IDs that must be divided by 3 BEFORE conversion
  var divideBy3Ids = {
    'sebum_t': true,
    'sebum_u': true,
    'predicted_age': true,        // "aging"
    'dullness_detection': true,
    'lossfirmness': true
  };

  // Aggregate best percentage per detection id across views
  var agg = {}; // id -> { value: percent, item: exampleItem }

  $.each(response.data, function(viewIdx, view){
    if (!$.isArray(view)) return;
    $.each(view, function(i, item){
      if (!item) return;

      // If the payload includes nested sebum objects without id,
      // handle them as their own metrics (sebum_t / sebum_u)
      if (item.sebum_t || item.sebum_u) {
        if (item.sebum_t && typeof item.sebum_t.strength === 'number') {
          var raw = item.sebum_t.strength;
          if (divideBy3Ids['sebum_t']) raw = raw / 3;
          var p = rawToPercent(raw);
          if (!agg['sebum_t'] || p > agg['sebum_t'].value) agg['sebum_t'] = { value: p, item: item };
        }
        if (item.sebum_u && typeof item.sebum_u.strength === 'number') {
          var raw2 = item.sebum_u.strength;
          if (divideBy3Ids['sebum_u']) raw2 = raw2 / 3;
          var p2 = rawToPercent(raw2);
          if (!agg['sebum_u'] || p2 > agg['sebum_u'].value) agg['sebum_u'] = { value: p2, item: item };
        }
        // Continue — we already processed sebum nested objects
        // (but if the object also has an id later we'll still process below)
      }

      // canonical id (some items include id)
      var id = item.id || null;
      if (!id) {
        // try to detect known keys in object itself (rare)
        for (var key in item) {
          if (!item.hasOwnProperty(key)) continue;
          if (key.indexOf('_detection') !== -1 || key === 'redness_detection' || key === 'brownlight_image' || key === 'negative_image') {
            id = key;
            break;
          }
        }
      }
      if (!id) return;

      // compute percent
      var percent = 0;
      if (id === "acne_detection" || id === "darkspot_detection") {
        var boxesLen = Array.isArray(item.boxes) ? item.boxes.length : 0;
        percent = clampPercent(boxesLen * 10);
      } else {
        // get the raw strength value
        var raw = getStrengthFromItem(item);

        // apply divide-by-3 if the metric requires it
        if (divideBy3Ids[id]) raw = raw / 3;

        // convert with heuristic
        percent = rawToPercent(raw);
      }

      if (!agg[id] || percent > agg[id].value) {
        agg[id] = { value: percent, item: item };
      }
    });
  });

  // convert agg -> sorted array
  var arr = [];
  for (var k in agg) {
    if (!agg.hasOwnProperty(k)) continue;
    arr.push({ id: k, value: agg[k].value, item: agg[k].item });
  }
  arr.sort(function(a,b){ return b.value - a.value; });

  var top = arr.slice(0, topN);

  // build metricsPercentMap for external consumption (Baumann uses this)
  var metricsPercentMap = {};
  for (var j = 0; j < arr.length; j++) metricsPercentMap[arr[j].id] = arr[j].value;
  window.latestMetricsPercentMap = metricsPercentMap;

  // render top bars into the summary container
  var $container = $('.bars .bar-left-side');
  if ($container.length === 0) $container = $('.bars').first();
  $container.empty();

  if (top.length === 0) {
    $container.append('<div class="no-results">No detectable issues found</div>');
  } else {
    $.each(top, function(idx, metric){
      var id = metric.id;
      var value = metric.value;
      var label = labelMap[id] || id.replace(/_/g, ' ').replace(/\b\w/g, function(l){ console.log(l); return l.toUpperCase(); });
      var color = typeof severityColor === 'function' ? severityColor(value) : '#4caf50';
      var safeClass = 'bar-' + id.replace(/[^a-z0-9]/gi,'-').toLowerCase();

      var $wrapper = $('<div class="bar-wrapper"></div>');
      var $progress = $('<div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>');

      var $bar = $('<div></div>')
        .addClass(safeClass + ' progress-bar')
        .attr('data-value', value)
        .css({
          'width': '0%', // animate from 0
          'background-color': color
        })
        .html(label.replace('Negative Image', 'COLLAGEN').replace('Dark Spot', 'DARKSPOT').replace('Detection', '') + ` <div class="bar-value">` + value + '%</div>');
        console.log(label);

      // click behavior (open side tab or update parameter UI)
      $bar.on('click', function() {
        var $sideBtn = $('#tabWrapper .nav-link[data-metric="' + id + '"]').first();
        if (!$sideBtn.length) {
          var short = id.replace(/_detection$/,'').replace(/_/g,'-');
          $sideBtn = $('#tabWrapper .nav-link[data-bs-target="#tabcontent-' + short + '"]').first();
        }
        if (!$sideBtn.length) {
          var lowLabel = (label || '').toLowerCase();
          $sideBtn = $('#tabWrapper .nav-link').filter(function() {
            var t = ($(this).text() || '').toLowerCase();
            return t.indexOf(lowLabel) !== -1 || t.indexOf(lowLabel.split(' ')[0]) !== -1;
          }).first();
        }
        if ($sideBtn && $sideBtn.length) {
          try {
            if (typeof bootstrap !== 'undefined' && bootstrap.Tab) new bootstrap.Tab($sideBtn[0]).show();
            else $sideBtn.trigger('click');
          } catch (e) { $sideBtn.trigger('click'); }
        } else {
          if (typeof updateParameterUI === 'function') updateParameterUI(id, value);
        }
        $container.find('.progress-bar').removeClass('active-bar');
        $bar.addClass('active-bar');
      });

      $progress.append($bar);
      $wrapper.append($progress);
      $container.append($wrapper);

      // animate width with small stagger
      (function($b, p, n){
        setTimeout(function(){
          $b.css('transition', 'width 700ms cubic-bezier(.2,.9,.2,1)');
          $b.css('width', p + '%');
          // update inner text in case value changed after animation
          $b.find('.bar-value').text(p + '%');
        }, 40 * n);
      })($bar, value, idx);
    });
  }

  // highlight first/top bar
  $container.find('.progress-bar').removeClass('active-bar');
  var $firstBar = $container.find('.progress-bar').first();
  if ($firstBar.length) $firstBar.addClass('active-bar');

  // re-run mapping
  if (typeof mapMetricsToSideTabs === 'function') mapMetricsToSideTabs(metricsPercentMap);

  return { top: top, metricsPercentMap: metricsPercentMap };
}

// ui.js
// Prevent page reload on unhandled promise rejection
window.addEventListener("unhandledrejection", function (event) {
  console.error("Unhandled rejection:", event.reason);
  event.preventDefault();
});

let scanCompleted = false;

async function startFaceScan() {
  try {
    await mindarThree.start();
    clock = new THREE.Clock();

    renderer.setAnimationLoop(() => {
      // Update face detection
      if (startScanFace) {
        onUpdate(); // Your existing face detection update function
      }

      // Scanning logic
      if (startCapture && currentStepIndex < scanSteps.length) {
        const currentStep = scanSteps[currentStepIndex];

        if (
          currentStep.orientation === "straight" &&
          Math.abs(window.eulerY) < 0.2 &&
          !lookedStraight
        ) {
          const capture = captureFrame("straight");
          if (capture) {
            capturedImages.push(capture);
            lookedStraight = true;
            setTimeout(() => {
              nextStep();
            }, 2000);
          }
        } else if (
          currentStep.orientation === "right" &&
          window.eulerY > 0.5 &&
          !lookedRight
        ) {
          const capture = captureFrame("right");
          if (capture) {
            capturedImages.push(capture);
            lookedRight = true;
            nextStep();
          }
        } else if (
          currentStep.orientation === "left" &&
          window.eulerY < -0.5 &&
          !lookedLeft
        ) {
          const capture = captureFrame("left");
          if (capture) {
            capturedImages.push(capture);
            lookedLeft = true;
            nextStep();
          }
        }
      
        if (lookedStraight && lookedLeft && lookedRight){
          // Check for completion
          const straightImage = capturedImages.find(
            (img) => img.orientation === "straight"
          );
          const leftImage = capturedImages.find(
            (img) => img.orientation === "left"
          );
          const rightImage = capturedImages.find(
            (img) => img.orientation === "right"
          );

          if (straightImage){
            $("<img>").addClass("straight-face").attr("src", straightImage.dataUrl).appendTo("#captured-photo");
          }

          if (leftImage){
            $("<img>").addClass("left-face").attr("src", leftImage.dataUrl).appendTo("#captured-photo");
          }

          if (rightImage){
            $("<img>").addClass("right-face").attr("src", rightImage.dataUrl).appendTo("#captured-photo");
          }

          straightFaceSrc = straightImage?.dataUrl;
          leftFaceSrc = leftImage?.dataUrl;
          rightFaceSrc = rightImage?.dataUrl;
        
          console.log(lookedStraight, lookedLeft, lookedRight);
          if (straightFaceSrc && leftFaceSrc && rightFaceSrc) {
            postData.id = "123";
            postData.sources.push(straightFaceSrc.split(",")[1]);
            postData.sources.push(leftFaceSrc.split(",")[1]);
            postData.sources.push(rightFaceSrc.split(",")[1]);
            // postData.raw_landmarks.push('')
            completeScanSkin();
          }
        }
      }

      // Update face mesh animation
      if (faceMesh?.material) {
        faceMesh.material.uniforms.time.value = clock.getElapsedTime();
      }

      renderer.render(scene, camera);
    });

    // Initialize UI
    $("#splash-screen").css("pointer-events", "all");
    $(".splash-continue > span").text("[ tap to continue ]");
    $(".splash-continue > .fas").css("display", "none");
    $(".splash-continue").css("pointer-events", "all");

    $(".splash-loading").fadeOut(300);
    $(".button-start-wrapper").removeClass("d-none");
    // $("#button-start").removeClass("d-none");
    $("#button-scan-qr").removeClass("d-none");
    $("#button-fill-form").removeClass("d-none");
    $("#instruct-home").removeClass("d-none");
  } catch (error) {
    console.error("Face scan initialization failed:", error);
    $(".splash-loading")
      .html(
        "<small>Error starting camera,<br/>Please allow camera access.</small>"
      )
      .addClass("text-danger text-center");
  }
}

startFaceScan();

// Scan button handler
$("#scan-btn").on("click", function (e) {
  capturedImages = [];
  postData.sources = []
  e.preventDefault(); // ← Add this
  e.stopPropagation(); // ← Add this

  $(this).css("pointer-events", "none");
  $("#scan-btn").html(
    '<i class="fas fa-spinner fa-spin me-2"></i> Scanning...'
  );

  // Reset state
  lookedRight = lookedLeft = lookedStraight = false;
  currentStepIndex = 0;

  // Setup UI
  $("#face-scan-container").addClass("scanning");
  $(".scan-animation").fadeIn(300);

  // Set initial text and progress
  $("#scan-helper-text").text(scanSteps[currentStepIndex].text);
  $("#scan-progress").css("width", "0%"); // Start at 0%

  // Capture initial straight frame
  const straightCapture = captureFrame("straight");
  if (straightCapture) {
    capturedImages.push(straightCapture);
    lookedStraight = true;

    // Move to next step and update progress to 33.3%
    setTimeout(function() {
      nextStep();
    }, 1000)
  }

  startCapture = true;
});

// Store user answers
const userAnswers = {
  describe: null,
  pores: null,
  afternoon: null,
  blemishes: null,
  morning: null,
};

// Skin type descriptions
// const skinTypes = {
//   dry: {
//     title: "DRY",
//     description: "Tight and flaky, less visible pores.",
//     image: "/assets/images/dry.png",
//   },
//   oily: {
//     title: "OILY",
//     description: "Shiny appearance, enlarged pores, prone to breakouts.",
//     image: "/assets/images/oily.png",
//   },
//   normal: {
//     title: "NORMAL",
//     description: "Balanced, comfortable, few imperfections.",
//     image: "/assets/images/normal.png",
//   },
//   acne: {
//     title: "ACNE PRONE",
//     description: "Easily irritated, prone to redness and reactions.",
//     image: "/assets/images/acne-prone.png",
//   },
//   combination: {
//     title: "COMBINATION",
//     description: "Oily T-zone with normal to dry cheeks.",
//     image: "/assets/images/dry.png",
//   },
// };


const regexEmail = (email) => {
  return /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(
    email
  );
};

const regexPhone = (phone) => {
  return /^0[1-9][0-9]{7,11}$/.test(phone);
};

let nameValid = false,
  phoneValid = false,
  ageValid = false,
  tncValid = false,
  tnc2Valid = true;
$("#form input").on("keyup keydown change", function () {
    // Check validity for name field
    if ($(this).hasClass("name")) {
      if ($(".name").val().trim() === "") {
        $(".name").next(".error-validation").fadeIn(300);
        nameValid = false;
      } else {
        $(".name").next(".error-validation").fadeOut(300); // Hide error if valid
        nameValid = true;
      }
    }

    // Check validity for phone field
    if ($(this).hasClass("phone")) {
      let phoneValue = $(this).val().trim();

      const $error = $(this)
        .closest(".input-wrapper")
        .find(".error-validation");

      if (phoneValue === "" || !regexPhone(phoneValue)) {
        $error.fadeIn(300);
        phoneValid = false;
      } else {
        $error.fadeOut(300);
        phoneValid = true;
      }
    }

    if ($(this).hasClass("age")) {
      let ageValue = $(this).val().trim();

      const $error = $(this)
        .closest(".input-wrapper")
        .find(".error-validation");

      if (ageValue === "") {
        $error.fadeIn(300);
        ageValid = false;
      } else {
        $error.fadeOut(300);
        ageValid = true;
      }
    }

    // Check validity for phone field
    if ($(this).hasClass("tnc")) {
      if ($(".tnc").prop("checked", true)) {
        tncValid = true;
      }
    }

    // Check validity for phone field
    if ($(this).hasClass("tnc2")) {
      if ($(".tnc2").prop("checked", true)) {
        tnc2Valid = true;
      }
    }

    // Toggle the submit button state
    if (nameValid && phoneValid && tncValid && tnc2Valid) {
      $("#submit-form").removeClass("disabled");
    } else {
      $("#submit-form").addClass("disabled");
    }
  })
  .on("blur", function () {
    $(".input-autocomplete").slideUp(300);
  });

$(".splash-agreement input").on("change", function () {
  if ($(this).is(":checked")) {
    $("#take-selfie").removeClass("disabled");
  }
});

// SKIN ANALYZER

var selfie = false;

$("#page-result .icon-back").on("click", function () {
  // Reset scanning state
  startCapture = false;
  lookedRight = false;
  lookedLeft = false;
  lookedStraight = false;
  currentStepIndex = 0;
  capturedImages = [];

  // Clear any ongoing scan timeout
  if (timeOutScan) {
    clearTimeout(timeOutScan);
    timeOutScan = null;
  }

  // Reset UI elements
  $("#scan-helper-text").text("");
  $("#scan-progress").css("width", "0%");
  $("#scan-btn").css("pointer-events", "all").html("Start Scan");

  // Clear captured images display
  $("#captured-photo").empty();

  // Hide result screen and show scan screen
  showScreen("scanSkin");

  // Reset scan animation if needed
  $(".scan-animation").hide();
  $("#face-scan-container").removeClass("scanning");
});

$("#button-start").on("click", function () {
  showScreen("pageIntro");
});

$("#button-to-age").on("click", function () {
  showScreen("pageQuestionAge");
});

$("#button-to-personal-concerns").on("click", function () {
  showScreen("pageQuestionAge");
});
$("#page-intro .icon-back").on("click", function () {
  showScreen("homePage");
});

$("#skip-selfie").on("click", function () {
  showScreen("scanAnalyzerSelection");
});

$(".button-to-form").on("click", function () {
  showScreen("pageForm");
});

$("#next-to-result").on("click", function () {
  showScreen("pageSkinProduct");
});

$("#button-to-transportation").on("click", function () {
  showScreen("questionTransportation");
});

$("#button-to-livein").on("click", function () {
  showScreen("questionLivein");
});

$("#button-to-sport").on("click", function () {
  showScreen("questionSport");
});

$("#button-fill-form").on("click", function () {
  showScreen("registForm");
});

$("#take-selfie").on("click", function () {
  showScreen("scanSkin");
  selfie = true;
});

$("#button-to-skin-product").on("click", function () {
  showScreen("pageSkinProduct");
});

// ✅ Combine all data
let payload = {
  "full_name": "",
  "phone": "",
  "age": "",
  "skin_type": 0,
  "skin_concern": "",
  "skin_age": 0,
  "skin_color": "",
  "acne": 0,
  "acne_scar": 0,
  "dark_spot": 0,
  "wrinkle": 0,
  "enlarge_pores": 0,
  "fineline": 0,
  "dullness": 0,
  "eyebag": 0,
  "hyperpigment": 0,
  "loss_firmness": 0,
  "unseen_dark_spot": 0,
  "potential_acne": 0,
  "sensitivity": 0,
  "sebum_u": 0,
  "sebum_t": 0,
  "blackhead": 0,
  "photo_path": ""
};

$("#submit-form").on("click", function () {
  $("#face-scan-skin .top-intro-wrapper a").text($(".form-control.name").val());
  $(".header-name").text($(".form-control.name").val());
  
  if ($("#submit-form").hasClass("disabled")) return;
  $(this).addClass("disabled");

  const name = $(".name").val().trim();
  const phone = $(".phone").val().trim();
  const age = $(".age").val().trim();

  // ✅ Save user info to localStorage
  localStorage.setItem("full_name", name);
  localStorage.setItem("phone", phone);
  localStorage.setItem("age", age);

  showScreen("pageQuestionAge");
});

$('#question-skin-condition.question-wrapper .question-list').on('click', function() {
  var skinConcern = $('#question-skin-condition.question-wrapper .question-list.selected > p').text();
  console.log(skinConcern);
  
  payload.skin_concern = skinConcern
})

$(".button-to-home, .back-to-home").on("click", function () {
  window.location.reload();
}); 

$("#register-form .icon-back").on("click", function () {
  window.location.reload();
});


  // showScreen('scanSkin')
  // showScreen('pageResultSkin');
  // showScreen('loadingScreen');

  </script>

  <!-- <script type="module" src="/assets/js/ui.js"></script> -->
</body>

</html>