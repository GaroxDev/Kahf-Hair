<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/assets/images/favicon.png" sizes="any" />
  <title>KAHF Virtual Hair Try-On 2025</title>
  <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/owl.carousel.min.css">
  <link rel="stylesheet" href="/assets/css/hair-style.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <script>
    let eulerY = 0;
  </script>
  <script type="module" src="/assets/js/owl.carousel.min.js"></script>
  <script src="/assets/js/three.min.js"></script>
  <script src="/assets/js/GLTFLoader.js"></script>
  <script type="module" src="/assets/js/OrbitControls.js"></script>
  <!-- <script src="/assets/js/dom-to-image.min.js"></script> -->
  <script src="/assets/js/jquery-3.6.0.min.js"></script>
  <script type="module" src="/assets/js/model-viewer.min.js"></script>
  <script src="/assets/js/qrcode.min.js"></script>
</head>

<body>
  <div class="kahf-container">
    <!-- <section id="register-form" class="p-0 register kahf-screen regist hidden" >k
      <div class="header-regist" style="background: #3f4939; height: 30px; width: 100%;">
        <img class="icon-back" src="/assets/images/icon-back.png" alt="" style="top: 30px; left: 30px;">
      </div>
      <div class="title" style="padding: 15%;">
        <h2>Register your ID</h2>
        <form style="transform: scale(1.2); transform-origin: top center;">
          <label for="name">Name</label>
          <input type="text" id="name" placeholder="your name">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="email">
          <label for="phone">Phone Number</label>
          <input type="text" id="phone" placeholder="your phone number">
          <button type="submit" id="regist-submit-btn" class="regist-submit-btn">Submit</button>
        </form>
      </div>
      <div class="footer-bar"></div>
    </section>

    <section id="profile-screen" class="p-0 profile kahf-screen profile hidden">
       <div class="header-regist" style="background: #3f4939; height: 30px; width: 100%;"></div>
        <div class="icon-back-wrapper">
          <img class="icon-back" src="/assets/images/icon-back.png" alt="" style="top: 6.5%; left: 6%; width: 5.5%; filter: brightness(0) invert(1);">
          <h2 style="text-align: center; padding: 36%;color: white;">User Profile</h2>
        </div>
        <div class="profile-content">
    <div class="avatar-wrapper">
      <img src="./assets/images/Profile Logo.png" alt="Avatar" class="avatar">
    </div>
    <h3 class="username">Fadly</h3>

    <form class="profile-form">
      <label>Email</label>
      <input type="email" id="profile-email" value="fad.ly@gmail.com" readonly>

      <label>Phone Number</label>
      <input type="text" id="profile-phone" value="+6281234567890" readonly>

      <label>Date of Birth</label>
      <input type="text" id="profile-dob" value="01 / 01 / 2001" readonly>

      <button type="button" id="qr-profile-btn" class="profile-btn">Generate QR</button>
    </form>
  </div>
        <div class="footer-bar"></div>
    </section>

    <section id="start-qr-screen" class="p-0 kahf-screen page-style-1 hidden">
    <div class="header-scanqr">
      <h2 style="text-align: center; padding: 35%;color: white; font-size: 150%;">Kahf DECODE QR</h2>
      </div>

      <div class="qr-container hidden" style="text-align: center; margin: 20px 0;">
      <div id="qr_image" style="display: inline-block;"></div>
      <div class="welcome-text">Hi <b>FADLY!</b></div>
      <div class="desc-text">Scan QR to enter <b>KAHF DECODE</b> website</div>
      </div>
      <button type="button" id="back-btn" class="qr-btn">Back</button>
    </section> -->

    <section id="home-page-hair" class="home-page kahf-screen">
      <img class="logo" src="/assets/images/logo.png" alt="">
      <img class="logo-decode" src="/assets/images/logo-decode.png" alt="">
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center">
        <button id="button-start" class="kahf-btn kahf-btn-accent d-none" style="width: 220px;">
          Start
        </button>
        <div class="splash-loading justify-content-center align-items-center">
          <i class="fas fa-spinner fa-spin me-2"></i>
          <span>Please Wait</span>
        </div>
      </div>
    </section>
    <section id="face-result-screen" class="kahf-screen hidden">
      <img class="logo mb-5" width="30%" style="max-width: 200px;" src="/assets/images/logo.png" alt="">

      <button class="kahf-btn kahf-btn-accent back-btn">
        <span>Back</span>
      </button>

      <div class="face-shape-card">
        <div class="d-flex gap-5 justify-content-center mb-4">
          <div class="wrapper-captured captured-left">
            <!-- ðŸ“¸ Preview of uploaded image -->
            <img id="preview-img" src="/assets/images/oval.png" alt="Preview">
            <div class="shape-name">Your Photo</div>
          </div>
          <div class="wrapper-captured captured-right">
            <!-- ðŸŽ¯ Predicted face shape image -->
            <img id="result-img" src="/assets/images/oval.png" alt="Result">
            <div class="shape-name" id="result-shape">Result</div>
          </div>
        </div>
        <div class="face-shape-info mb-4">
          <p class="mb-2 shape-title">Face Shape Result</p>
          <p class="shape-desc" id="shape-desc">
            Upload your face photo to get prediction.
          </p>
        </div>
      </div>

    <button id="result-continue-btn" class="kahf-btn kahf-btn-accent">
      CONTINUE
    </button>
    </section>

    <!-- Face Scan Screen -->
    <section id="face-scan-hair" class="p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
        <img class="icon-back" src="/assets/images/icon-back.png" alt="">
        <img class="logo-decode" src="/assets/images/logo-decode.png" alt="">
        <img class="logo" src="/assets/images/logo-header.png" alt="">
      </div>

      <!-- INTRO -->
      <div class="intro-text">
        <h2 class="greeting">HAI FADLY !!!</h2>
        <p class="desc">
          WE'LL ANALYZE YOUR FACE SHAPE TO SUGGEST SUITABLE HAIRSTYLES AND PRODUCTS.
        </p>
      </div>

      <div id="face-scan-container" class="mb-3">
        <img class="ellipse" src="/assets/images/ellipse.png" alt="">
        <!-- <video id="camera-feed" autoplay playsinline></video> -->
        <!-- <div class="scan-animation"></div> -->
        <div class="scan-helper-container" id="scan-helper">
          <div class="scan-helper-text" id="scan-helper-text"></div>
          <div class="scan-progress">
            <div class="progress-bar" id="scan-progress"></div>
          </div>
        </div>
      </div>
      <!-- <div class="face-shape-info mb-4 mt-3">
        <p class="shape-desc" id="shape-desc">
          WE'LL ANALYZE YOUR FACE SHAPE TO SUGGEST SUITABLE HAIRSTYLES AND PRODUCTS.
        </p>
      </div> -->
      <!-- <h3 class="title-2 mb-4 text-center">Please Scan Your Face</h3>
      <h4 class="title-3 mb-5 text-center">We'll analyze your face shape to suggest suitable<br/>hairstyles and products.</h4> -->

      <button id="scan-btn" class="kahf-btn kahf-btn-accent">
        <span>Start Scan</span>
      </button>
    </section>

    <!-- Question Hair -->
    <section id="page-question-hair" class="p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
      <img class="icon-back" src="/assets/images/icon-back.png" alt="">
      <img class="logo" src="/assets/images/logo.png" alt="">
      <img class="logo-decode" src="/assets/images/logo-decode.png" alt="">
      </div>

      <div class="top-intro-wrapper pt-5">
        <h2>Apa tipe rambutmu?</h2>
      </div>
      <div class="question-wrapper question-text-container">
        <div class="question-list question-text">Straight</div>
        <div class="question-list question-text">Wavy</div>
        <div class="question-list question-text">Curly</div>
      </div>
      <div class="quest-hair d-flex gap-3 justify-content-center align-items-center">
        <button id="button-to-hairstyle" class="kahf-btn kahf-btn-accent disabled" style="width: 220px;">
          Next
        </button>
      </div>
    </section>

    <!-- Hairstyle Selection Screen -->
    <section id="hairstyle-screen" class="p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
        <img class="icon-back" src="/assets/images/icon-back.png" alt="">
        <img class="logo-decode" src="/assets/images/logo-decode.png" alt="">
        <img class="logo" src="/assets/images/logo-header.png" alt="">
      </div>
      <!-- <h1 class="kahf-title mb-5">Hairstyle Selection</h1> -->

      <!-- Three.js Container - Single consistent element -->
      <div class="hairstyle-grid">
        <div class="hairstyle-grid-inner">
          <div class="hairstyle-item" data-model-index="0">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-4.glb" alt="A 3D model" style="--poster-color: transparent;">
                <div slot="poster"></div>
                <div slot="progress-bar"></div>
              </model-viewer>
              <!-- <img src="/assets/images/image 11.png" alt=""> -->
            </div>
            <div class="hairstyle-name">Curtain Waves</div>
          </div>
          <div class="hairstyle-item" data-model-index="1">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-5.glb" alt="A 3D model" style="--poster-color: transparent;">
                <div slot="poster"></div>
                <div slot="progress-bar"></div>
              </model-viewer>
              <!-- <img src="/assets/images/image 11.png" alt=""> -->
            </div>
            <div class="hairstyle-name">Slick Back</div>
          </div>
          <div class="hairstyle-item" data-model-index="2">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-12.glb" alt="A 3D model" style="--poster-color: transparent;">
                <div slot="poster"></div>
                <div slot="progress-bar"></div>
              </model-viewer>
              <!-- <img src="/assets/images/image 12.png" alt=""> -->
            </div>
            <div class="hairstyle-name">Textured Crop</div>
          </div>
        </div>
      </div>
      <div class="sidebar-hair">
        HAIRSTYLE SELECTION
      </div>
      <button id="button-style-vault" class="kahf-btn kahf-btn-accent button-small">
        more hair style (200)
      </button>

      <div class="scene-container">
        <canvas id="renderCanvas1"></canvas>
        <!-- <model-viewer auto-rotate camera-controls id="hair_0" src="/assets/models/hair-1.glb" data-hair="hair-1" alt="A 3D model"></model-viewer>
        <model-viewer auto-rotate camera-controls id="hair_1" src="/assets/models/hair-2.glb" data-hair="hair-2" alt="A 3D model"></model-viewer>
        <model-viewer auto-rotate camera-controls id="hair_2" src="/assets/models/hair-3.glb" data-hair="hair-3" alt="A 3D model"></model-viewer> -->
        <!-- <div class="scene-name"></div> -->
        <!-- Three.js will create its own canvas here -->
        <!-- <img class="rotate-icon" src="/assets/images/rotate-icon.png" alt=""> -->
        <div class="rotate-controls">
          <button id="btnLeft" class="kahf-btn kahf-btn-accent">&laquo;</button>
          <button id="btnRight" class="kahf-btn kahf-btn-accent">&raquo;</button>
        </div>
      </div>
      <button id="hairstyle-continue-btn" class="kahf-btn kahf-btn-accent">
        next
      </button>
      <div id="sidebar-hair-style" class="sidebar">
        MCurtain Waves
      </div>
    </section>

    <!-- Hairstyle List Selection Screen -->
    <section id="hairstyle-list-screen" class="p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
        <img class="icon-back" src="/assets/images/icon-back.png" alt="">
        <img class="logo-decode" src="/assets/images/logo-decode.png" alt="">
        <img class="logo" src="/assets/images/logo-header.png" alt="">
      </div>

      <!-- Three.js Container - Single consistent element -->
      <div class="hairstyle-grid">
        <div class="hairstyle-grid-inner">
          <!-- This is where the hairstyle items will be dynamically rendered -->
          <div id="hairstyle-grid-inner-list" class="hairstyle-grid-inner-list">
            <!-- Loading state will be shown here initially -->
            <div class="loading-indicator">
              <p>Loading hairstyles...</p>
            </div>
          </div>
          
          <div class="sidebar-hair-list">
            HAIRSTYLE
          </div>
        </div>
      </div>
    </section>

    <!-- Product Recommendation Screen -->
    <section id="product-hair-screen" class="p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
        <img class="icon-back" src="/assets/images/icon-back.png" alt="">
        <img class="logo-decode" src="/assets/images/logo-decode.png" alt="">
        <img class="logo" src="/assets/images/logo-header.png" alt="">
      </div>
      <div class="sidebar-prod">
        PRODUCTS RECOMMENDATION
      </div>

      <div class="result-card">
        <div class="product-body">
          <div class="d-flex gap-3 justify-content-center mb-2">
            <!-- Left card -->
            <div class="card-prod card-prod-result">
              <div class="left-card-prod">
                <h3>Face <br>
                  Result</h3>
                <div class="face-type">OVAL</div>
                <button class="btn-detail">DETAIL</button>
              </div>
              <div class="right-card-prod">
                <img class="face-img" src="/assets/images/oval-1.png" />
              </div>
            </div>
            <!-- Right card -->
            <div class="card-prod card-prod-desc">
              The most balanced and versatile face shape, with a slightly wider forehead than jawline.
              Almost any hairstyle works well, from short, sharp crops to longer, layered looks,
              giving you the freedom to experiment.
            </div>
          </div>
        </div>
      </div>

      <div class="product-card">
        <div class="model-img">
          <model-viewer id="product-model-viewer" src="/assets/models/model-4.glb" alt="Model 1" style="--poster-color: transparent;">
            <div slot="poster"></div>
            <div slot="progress-bar"></div>
          </model-viewer>
        </div>
        <div class="product-info">
          <h3>Hair Style
            <br>Recommendations
          </h3>
          <h2 id="product-hair-style-name" style="margin-top: 15px;font-weight: bold;font-size: 150%;">Curtain Waves</h2>
        </div>
        <p id="product-hair-style-desc" style="padding-top: 19px; padding-right: 10px; font-size: 11px; text-align: left;">
          The most balanced and versatile
          <br>face shape, with a slightly 
          <br>wider forehead than jawline. 
          <br>Almost any hairstyle works 
          <br>well, from short, sharp crops 
          <br>to longer, layered looks, 
          <br>giving you the freedom to 
          <br>experiment.</p>
      </div>
      <div class="product-result-container">
        <!-- Produk 1 -->
      <div class="product-card">
        <div class="product-info">
          <h3>Hair
            <br>Styling</h3>
          <h4>KAHF</h4>
          <p>Kahf Sleek Classy Water Based Pomade</p>
          <button>PRODUCT INFORMATION</button>
        </div>
        <div class="product-img">
          <img src="/assets/images/pomade-sleek.png" alt="Pomade 1">
        </div>
      </div>

      <!-- Produk 2 -->
      <div class="product-card">
        <div class="product-info">
          <h3>Hair
            <br>Styling</h3>
          <h4>KAHF</h4>
          <p>Kahf Matte Dapper Water Based Pomade</p>
          <button>PRODUCT INFORMATION</button>
        </div>
        <div class="product-img">
          <img src="/assets/images/pomade-matte.png" alt="Pomade 2">
        </div>
      </div>

      <!-- Produk 3 -->
      <div class="product-card">
        <div class="product-info">
          <h3>Hair
            <br>Styling</h3>
          <h4>KAHF</h4>
          <p>Kahf Sleek Classy Water Based Pomade</p>
          <button>PRODUCT INFORMATION</button>
        </div>
        <div class="product-img">
          <img src="/assets/images/pomade-sleek.png" alt="Pomade 1">
        </div>
      </div>
      </div>

      <!-- Button -->
      <div class="d-flex gap-4 button-inline-wrapper justify-content-center align-items-center">
        <button id="finish-page-hair-product" class="button-to-home kahf-btn kahf-btn-accent" style="width: 50%;">
          Finish
        </button>

        <button id="share-result" class="kahf-btn kahf-btn-accent" style="width: 50%" onclick="generateResultQR()">
          Share
        </button>

        <!-- Pop Up QR Code -->
        <div id="qrModal" class="qr-modal">
          <div class="qr-modal-content">
            <span class="close">&times;</span>
            <h3 class="qr-text">Scan QR Code For Share Your Result</h3>
            <div id="qr_image_modal" style="display: inline-block;">
            </div>
          </div>
        </div>
    </section> 
  </div>

  <div id="captured-photo">
  </div>

    <script type="importmap">
      {
      "imports": {
        "three": "/assets/js/three.module.js",
        "three/addons/": "/assets/js/three/addons/",
        "mindar-face-three":"/assets/js/mindar-face-three.prod.js"
      }
    }
  </script>

 <script>
  
  // Screen navigation
  const screens = {
    profile: $('#profile-screen'),
    splash: $('#splash-screen'),
    landing: $('#landing-screen'),
    startScan: $('#start-qr-screen'),
    // hair
    homePageHair: $('#home-page-hair'),
    scan: $('#face-scan-screen'),
    result: $('#face-result-screen'),
    hairstyle: $('#hairstyle-screen'),
    pageQuestionHair: $('#page-question-hair'),
    hairstyleList: $('#hairstyle-list-screen'),
    registForm: $('#register-form'),
    product: $('#product-hair-screen'),
    scanAnalyzer: $('#skin-analyzer-splash'),
    scanSkin: $('#face-scan-skin'),
    scanHair: $('#face-scan-hair'),
    scanAnalyzerSelection: $('#skin-analyzer-selection'),
    homePage: $('#home-page'),
    pageForm: $('#page-form'),
    pageIntro: $('#page-intro'),
    // skin analyzer
    pageResult: $('#page-result'),
    pageSkinResult: $('#face-result-skin'),
    pageSkinScore: $('#page-skin-score'),
    pageSkinProduct: $('#page-result-product'),
    pageQuestionAge: $('#page-question-age'),
    questionSkinCondition: $('#page-question-skin-condition'),
    questionDirectSunlight: $('#page-question-direct-sunlight'),
    questionPersonalConcern: $('#page-question-dry-concerns'),
    questionLivein: $('#page-question-livein'),
    // i dont know
    questionDescribeSkin: $('#page-question-describe-skin'),
    questionPoresSkin: $('#page-question-pores'),
    questionAfternoon: $('#page-question-afternoon'),
    questionBlemishes: $('#page-question-blemishes'),
    questionMorning: $('#page-question-morning'),
    // skin condition
    questionNormalSkin: $('#page-question-normal-concerns'),
    questionOilySkin: $('#page-question-oily-concerns'),
    questionCombinationSkin: $('#page-question-combination-concerns'),
    questionDullSkin: $('#page-question-dull-concerns'),
    questionDrySkin: $('#page-question-dry-concerns'),
    questionAcneSkin: $('#page-question-acne-concerns'),
    // result
    resultSkinType: $('#page-result-skintype')
  }

  // --- Face capture variables ---
  let currentAngle = 0;
  let targetAngle = 0;
  let texturePath = '';
  let capturedImages = [];
  
  
  let qrCode = null;
  let qrResult = null;
  // --- QR Start ---
//   function generateQR() {
//   const baseURL = window.location.origin + window.location.pathname;
//   const qrLink = baseURL + "homePageHair";

//   if (!qrCode) {
//     qrCode = new QRCode("qr_image", {
//       text: qrLink,
//       width: 256,
//       height: 256,
//       colorDark: "#000000",
//       colorLight: "#e8e8e8",
//       correctLevel: QRCode.CorrectLevel.H,
//     });
//   } else {
//     qrCode.clear();
//     qrCode.makeCode(qrLink);
//   }

//   console.log("QR Code generated:", qrLink); 
// }
// document.getElementById("qr-profile-btn").addEventListener("click", function() {
//       generateQR();
//     });

// function handleSectionFromHash() {
//   console.log("handleSectionFromHash called!", window.location.hash);

//   if (window.location.hash) {
//     const section = window.location.hash.replace("#", "");
//     console.log("Redirect to section:", section);

//     const key = section.replace(/-([a-z])/g, g => g[1].toUpperCase());

//     if (screens[section]) {
//       console.log("Found in screens:", section);
//       setTimeout(() => {
//         showScreen(section);
//       }, 50);
//     } else {
//       console.warn("Section not found in screens:", section);
//     }
//   }
// }

// // ðŸ”¹ saat pertama kali halaman diload
// window.addEventListener("load", handleSectionFromHash);

// // ðŸ”¹ saat hash berubah (misalnya hasil scan QR buka link dengan #xxx)
// window.addEventListener("hashchange", handleSectionFromHash);


  // --- QR Result ---
  function generateResultQR() {
    if (!qrResult) {
      qrResult = new QRCode("qr_image_modal", {
      text: "https://www.kahfeveryday.com/",
      width: 256,
      height: 256,
      colorDark: "#3f4939",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H,
    });
  } else {
    qrResult.clear(); 
    qrResult.makeCode("https://www.kahfeveryday.com/");
  }
    
    
  console.log("QR Code generated for result.");
  document.getElementById("qrModal").style.display = "flex";
}

// Event listener untuk tombol share
    document.getElementById("share-result").addEventListener("click", function() {
      generateResultQR();
    });
    
    // Event listener untuk menutup modal
    $(".close").on("click", function() {
      $("#qrModal").fadeOut();
    });
    
    // Tutup modal jika diklik di luar area konten
    window.addEventListener("click", function(event) {
      const modal = document.getElementById("qrModal");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });

  // Function to show a specific screen
  function showScreen(screenName) {
    // Hide all screens
    Object.values(screens).forEach(screen => {
      screen.addClass('hidden');
    });

    // Show the requested screen
    screens[screenName].removeClass('hidden');
  }

//   document.getElementById("regist-submit-btn").addEventListener("click", function(e) {
//     e.preventDefault(); // biar gak reload form
//     console.log("Register form submitted");
//     showScreen("profile");
// });

  async function completeScan() {
    try {
      // ðŸŸ¢ Update UI to reflect scan completion
      $('#scan-progress').css('width', '100%');
      $('#scan-helper-text').text('Scanning Complete...');

      // ðŸŸ¢ Prepare result screen
      const photoContainer = document.querySelector("#captured-photo");
      if (photoContainer) photoContainer.innerHTML = "";

      // ðŸŸ¢ Proceed only if images haven't been logged and are available
      if (capturedImages.length > 0) {
        const straightImage = capturedImages.find(img => img.orientation === "straight");
        const leftImage = capturedImages.find(img => img.orientation === "left");
        const rightImage = capturedImages.find(img => img.orientation === "right");

        if (straightImage) $('<img>').addClass('straight-face').attr('src', straightImage.dataUrl).appendTo('#captured-photo');
        if (leftImage) $('<img>').addClass('left-face').attr('src', leftImage.dataUrl).appendTo('#captured-photo');
        if (rightImage) $('<img>').addClass('right-face').attr('src', rightImage.dataUrl).appendTo('#captured-photo');

        const straightFaceSrc = straightImage?.dataUrl?.split(",")[1];
        const leftFaceSrc = leftImage?.dataUrl?.split(",")[1];
        const rightFaceSrc = rightImage?.dataUrl?.split(",")[1];

        if (straightFaceSrc && leftFaceSrc && rightFaceSrc) {
            
            fetch("http://localhost:8000/api/upload-face", { // âœ… remove trailing slash
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  center: straightFaceSrc,
                  left: leftFaceSrc,
                  right: rightFaceSrc
                })
              })
              .then(res => res.json())
              .then(data => {
                texturePath = '';
                texturePath = "http://192.168.31.63:8000/static/output_size/final_uv_overlay.png";

                // texturePath = '/hair_tryon_backend/static/output_size/result.png'
                // texturePath = 'https://pixielab.s3.ap-southeast-3.amazonaws.com/texture/result.png'

                initThreeScene();
                console.log("Predictions:", data.predictions);
                console.log("Result image saved at:", data.saved_path);

                // âœ… NEW CODE: Render hairstyle items from API response
                if (data.hairfastgan_results) {
                  renderHairstyleItems(data.hairfastgan_results);
                } else {
                  console.warn("No hairstyle data in API response");
                }

                // âœ… Display predictions
                const predictionsDiv = document.createElement("div");
                predictionsDiv.innerHTML = `
                <h3>Face Shape Predictions</h3>
                <p><strong>Center:</strong> ${data.predictions.center.class} (${data.predictions.center.confidence})</p>
                <p><strong>Left:</strong> ${data.predictions.left.class} (${data.predictions.left.confidence})</p>
                <p><strong>Right:</strong> ${data.predictions.right.class} (${data.predictions.right.confidence})</p>
              `;
                document.querySelector("#captured-photo").appendChild(predictionsDiv);

                // âœ… Display result image
                const resultImg = document.createElement("img");
                resultImg.src = "data:image/png;base64," + data.overlay_base64;
                resultImg.style.maxWidth = "300px";
                resultImg.style.border = "2px solid #333";
                resultImg.style.display = "block";
                resultImg.style.marginTop = "10px";
                document.querySelector("#captured-photo").appendChild(resultImg);
              })
              .catch(err => console.error("Upload error:", err));

            showScreen('pageQuestionHair');

          } else {
            const warningMsg = document.createElement("div");
            warningMsg.textContent = "Could not capture all required angles. Please try again.";
            Object.assign(warningMsg.style, {
              color: "#ff8800",
              textAlign: "center",
              margin: "20px 0"
            });
            photoContainer.appendChild(warningMsg);
        }

      } else {
        console.log("Images already processed previously.");
      }

    } catch (err) {
      console.error("Error in completeScan():", err);
      alert("An unexpected error occurred during scan completion");

      // showScreen('result');
      const fallback = document.createElement("div");
      fallback.textContent = "Unexpected error. Please try again.";
      Object.assign(fallback.style, {
        color: "#ff4444",
        textAlign: "center",
        margin: "20px 0"
      });
      document.querySelector("#captured-photo").appendChild(fallback);
    }
  }

// âœ… NEW FUNCTION: Render hairstyle items
  function renderHairstyleItems(hairstyleData) {
    const gridInnerList = document.getElementById('hairstyle-grid-inner-list');
    
    if (!gridInnerList) {
      console.error("Could not find hairstyle-grid-inner-list element");
      return;
    }
    
    // Clear existing content
    gridInnerList.innerHTML = '';
    
    // Render each hairstyle item
    hairstyleData.forEach((item, index) => {
      console.log("Rendering hairstyle item:", item);
      const hairstyleItem = document.createElement('div');
      hairstyleItem.className = 'hairstyle-item';
      hairstyleItem.setAttribute('data-model-index', index);
      hairstyleItem.setAttribute('data-model-src', item.output_path);
      hairstyleItem.setAttribute('data-name', item.name || 'Hairstyle');
      hairstyleItem.setAttribute('data-recommended', item.recommended || false);
      
      // Create recommended tag if needed
      let recommendedTag = '';
      if (item.recommended) {
          recommendedTag = `<span class="tag-recommended"><label>RECOMMENDED</label></span>`;
      }
      
      // Set the inner HTML for the hairstyle item
      hairstyleItem.innerHTML = `
          <div class="hairstyle-img">
              <model-viewer src="${item.output_path}" alt="${item.name || 'Hairstyle'} 3D model" 
                  camera-orbit="-35deg 75deg 2.5m" style="--poster-color: transparent;" 
                  ar-status="not-presenting">
                  <div slot="poster"></div>
                  <div slot="progress-bar"></div>
              </model-viewer>
              ${recommendedTag}
          </div>
          <div class="hairstyle-name">${item.name || 'Hairstyle'}</div>
      `;
      
      // Append to the grid
      gridInnerList.appendChild(hairstyleItem);
    });
    
    console.log(`Rendered ${hairstyleData.length} hairstyle items`);
  }

    let selectedHairStyleName = '';

    // Fungsi untuk mengupdate nama hairstyle di sidebar
    function updateSidebarHairStyle() {
      const sidebarElement = document.getElementById("sidebar-hair-style");
      if (sidebarElement) {
        sidebarElement.textContent = selectedHairStyleName;
      }
    }

    // Event listener untuk item hairstyle
    document.addEventListener("DOMContentLoaded", function() {
      // Gunakan event delegation untuk menangani klik pada hairstyle-item
      document.addEventListener("click", function(e) {
        const hairstyleItem = e.target.closest(".hairstyle-item");
        if (hairstyleItem) {
          // Ambil nama hairstyle dari elemen .hairstyle-name
          const hairStyleNameElement = hairstyleItem.querySelector(".hairstyle-name");
          if (hairStyleNameElement) {
            selectedHairStyleName = hairStyleNameElement.textContent;
            // Update teks di sidebar
            updateSidebarHairStyle();
            
            // Hapus class active dari semua item
            document.querySelectorAll(".hairstyle-item").forEach(item => {
              item.classList.remove("active");
            });
            
            // Tambahkan class active ke item yang dipilih
            hairstyleItem.classList.add("active");
          }
        }
      });
      
      // Inisialisasi sidebar dengan nilai default
      updateSidebarHairStyle();
    });

  // Fungsi untuk set target rotasi kamera (clamp -45Â° sampai 45Â°)
  function setRotationY(angle) {
    const min = THREE.MathUtils.degToRad(-20);
    const max = THREE.MathUtils.degToRad(20);

    targetAngle = Math.min(Math.max(angle, min), max);
  }
  

  // --- Your Three.js scene setup ---
  function initThreeScene() {
    const container = document.querySelector('.scene-container');
    container.classList.remove('d-none');

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(60, 700 / 450, 0.1, 100);
    camera.position.set(0, 2, 8);

    const myCanvas = document.getElementById('renderCanvas1');
    const renderer = new THREE.WebGLRenderer({
        canvas: myCanvas,
        alpha: true,
        antialias: true
    });
    renderer.setSize(700, 450);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    scene.background = new THREE.Color(0xE8E8E8);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enableZoom = true;
    controls.enablePan = false;
    controls.enableRotate = false;
    controls.target.set(0, 2, 0);

    // --- Lights ---
    const ambientLight = new THREE.AmbientLight(0xffffff, 1,5); // very subtle
    scene.add(ambientLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.5); // dim directional light
    dirLight.position.set(0, 10, 10);
    dirLight.target.position.set(0, 0, 0);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 512; // smaller = softer
    dirLight.shadow.mapSize.height = 512;
    dirLight.shadow.radius = 8; // very soft edges
    dirLight.shadow.camera.near = 0.5;
    dirLight.shadow.camera.far = 50;
    dirLight.shadow.camera.left = -10;
    dirLight.shadow.camera.right = 10;
    dirLight.shadow.camera.top = 10;
    dirLight.shadow.camera.bottom = -10;
    scene.add(dirLight);

    // --- Shadow Plane ---
    const planeGeometry = new THREE.CircleGeometry(5, 64);
    const planeMaterial = new THREE.ShadowMaterial({ opacity: 0.05 }); // extremely low shadow
    const plane = new THREE.Mesh(planeGeometry, planeMaterial);
    plane.rotation.x = -Math.PI / 2;
    plane.position.y = -6;
    plane.receiveShadow = true;
    scene.add(plane);

    let faceModel = null;
    let currentHair = null;

    const loader = new THREE.GLTFLoader();
    const textureLoader = new THREE.TextureLoader();

    // --- Load Face Model ---
    loader.load('./assets/models/head_bagus.glb', (gltf) => {
        faceModel = gltf.scene;
        faceModel.position.set(0, -12.35, 0);
        faceModel.scale.set(9, 9, 9);
        faceModel.traverse((child) => {
            if (child.isMesh) {
                child.castShadow = true;
                child.receiveShadow = true;
            }
        });
        scene.add(faceModel);

        textureLoader.load(texturePath, (texture) => {
            texture.flipY = false;
            faceModel.traverse((child) => {
                if (child.isMesh) {
                    child.material = new THREE.MeshStandardMaterial({
                        map: texture,
                        transparent: true,
                        side: THREE.DoubleSide,
                    });
                    child.material.needsUpdate = true;
                }
            });
        });
    });

    // --- Hairstyle Loader ---
    let isLoadingHair = false;
    function loadHairstyle(path) {
        if (!faceModel || isLoadingHair) return;
        isLoadingHair = true;

        if (currentHair) {
            scene.remove(currentHair);
            currentHair.traverse((child) => {
                if (child.isMesh) {
                    child.geometry.dispose();
                    if (child.material.isMaterial) {
                        cleanMaterial(child.material);
                    } else {
                        child.material.forEach(mat => cleanMaterial(mat));
                    }
                }
            });
            currentHair = null;
        }

        loader.load(path, (gltf) => {
            const hair = gltf.scene;
            hair.position.set(0, -12.3, 0);
            hair.scale.set(9, 9, 9);

            hair.traverse((child) => {
                if (child.isMesh) {
                    if (!child.material) child.material = new THREE.MeshStandardMaterial({ color: 0xffffff });
                    child.material.transparent = true;
                    child.material.side = THREE.DoubleSide;
                    child.material.alphaTest = 0.5;
                    child.castShadow = true;
                    child.receiveShadow = true;
                    child.renderOrder = 1;
                }
            });

            scene.add(hair);
            currentHair = hair;
            isLoadingHair = false;
        });
    }

    function cleanMaterial(material) {
        material.dispose();
        for (const key in material) {
            if (material[key] && material[key].isTexture) material[key].dispose();
        }
    }

    // --- Rotation Control ---
    window.setRotationY = function(angle) {
        const min = THREE.MathUtils.degToRad(-20);
        const max = THREE.MathUtils.degToRad(20);
        targetAngle = Math.min(Math.max(angle, min), max);
    };

    // --- Animate Loop ---
    function animate() {
        requestAnimationFrame(animate);

        currentAngle += (targetAngle - currentAngle) * 0.1;
        camera.position.x = 5 * Math.sin(currentAngle);
        camera.position.z = 5 * Math.cos(currentAngle);
        camera.lookAt(0, 2, 0);

        controls.update();
        renderer.render(scene, camera);
    }
    animate();
}
  // Tombol kiri
  document.getElementById('btnLeft').addEventListener('click', () => {
    setRotationY(targetAngle - THREE.MathUtils.degToRad(20));
  });

  // Tombol kanan
  document.getElementById('btnRight').addEventListener('click', () => {
    setRotationY(targetAngle + THREE.MathUtils.degToRad(20));
  });

  let selectedHairStyle = {
      modelSrc: '',
      name: '',
      description: ''
    };

    // Data untuk setiap hairstyle
    const hairStyleData = {
      0: {
        modelSrc: '/assets/models/model-4.glb',
        name: 'Curtain Waves',
        description: 'A relaxed and stylish look with natural waves framing the face. The curtain-style fringe gives off a soft, youthful vibe while maintaining a sense of effortless charm. Perfect for casual everyday wear or characters that embody freedom and creativity.'
      },
      1: {
        modelSrc: '/assets/models/model-5.glb',
        name: 'Slick Back',
        description: 'A timeless hairstyle that highlights confidence and elegance. With its clean, backward flow and subtle volume, it draws attention to the face and sharpens the overall look. Ideal for formal settings, professional styles, or characters that need a refined, sophisticated presence.'
      },
      2: {
        modelSrc: '/assets/models/model-12.glb',
        name: 'Textured Crop',
        description: 'A modern, low-maintenance haircut with sharp texture on top and clean sides. This hairstyle balances simplicity with a bold edge, giving off an energetic and masculine vibe. Great for active lifestyles or characters that value strength, practicality, and straightforward style.'
      }
    };

    // Fungsi untuk mengupdate product screen dengan hairstyle yang dipilih
    function updateProductScreen() {
      // Update model viewer
      const modelViewer = document.getElementById('product-model-viewer');
      if (modelViewer) {
        modelViewer.setAttribute('src', selectedHairStyle.modelSrc);
      }
      
      // Update nama hairstyle
      const nameElement = document.getElementById('product-hair-style-name');
      if (nameElement) {
        nameElement.textContent = selectedHairStyle.name;
      }
      
      // Update deskripsi hairstyle
      const descElement = document.getElementById('product-hair-style-desc');
      if (descElement) {
        descElement.textContent = selectedHairStyle.description;
      }
    }

    // Event listener untuk item hairstyle
    document.addEventListener("DOMContentLoaded", function() {
      // Gunakan event delegation untuk menangani klik pada hairstyle-item
      document.addEventListener("click", function(e) {
        const hairstyleItem = e.target.closest(".hairstyle-item");
        if (hairstyleItem) {
          const index = hairstyleItem.getAttribute("data-model-index");
          
          // Update selectedHairStyle dengan data dari hairStyleData
          if (hairStyleData[index]) {
            selectedHairStyle = hairStyleData[index];
            
            // Update sidebar jika ada
            updateSidebarHairStyle();
          }
        }
      });
      
      // Event listener untuk tombol next di hairstyle screen
      const continueButton = document.getElementById("hairstyle-continue-btn");
      if (continueButton) {
        continueButton.addEventListener("click", function() {
          // Update product screen sebelum menampilkannya
          updateProductScreen();
          showScreen(product);
        });
      }
    });
</script>
    <script type="module" src="/assets/js/ui.js"></script>
</body>

</html>