<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/assets/images/favicon.png" sizes="any" />
  <title>KAHF Virtual Hair Try-On 2025</title>
  <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/owl.carousel.min.css">
  <link rel="stylesheet" href="/assets/css/hair-style.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <script>
    let eulerY = 0;
  </script>
  <script type="module" src="/assets/js/owl.carousel.min.js"></script>
  <script src="/assets/js/three.min.js"></script>
  <script src="/assets/js/GLTFLoader.js"></script>
  <script type="module" src="/assets/js/OrbitControls.js"></script>
  <script src="/assets/js/dom-to-image.min.js"></script>
  <script src="/assets/js/jquery-3.6.0.min.js"></script>
  <script type="module" src="/assets/js/model-viewer.min.js"></script>
  <script src="/assets/js/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <!-- <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> -->
</head>

<body>
  <div class="kahf-container">
    <section id="home-page-hair" class="home-page kahf-screen">
      <img class="logo" src="/assets/images/KV-Hair.png" alt="">
      <img class="logo-decode" src="/assets/images/kahf-logo.png" alt="">
      <img class="logo-desc" src="/assets/images/kahf-desc.png" alt="">
      <div class="d-flex gap-3 mt-5 justify-content-center align-items-center">
        <button id="button-scan-qr" class="kahf-btn kahf-btn-accent d-none" style="width: 220px; pointer-events: none;">
          SCAN QR
        </button>
        <div id="qr-popup" class="qr-popup">
          <div class="qr-popup-content">
            <span class="qr-close">&times;</span>
            <h2>Scan QR Code</h2>
            <div id="qr-reader" style="width: 300px; height: 300px; margin-top: 10px;"></div>
          </div>
        </div>
        <button id="button-fill-form" class="kahf-btn kahf-btn-accent d-none" style="width: 220px;">
          FILL FORM
        </button>
        <div id="instruct-home" class="instruct d-none">NO QR? START HERE</div>
        <div class="splash-loading justify-content-center align-items-center">
          <i class="fas fa-spinner fa-spin me-2"></i>
          <span>Please Wait</span>
        </div>
      </div>
    </section>
    <section id="register-form" class="p-0 register kahf-screen regist hidden" >
      <img class="icon-back" src="/assets/images/icon-back.png" alt="">
      <img class="logo-regist" src="/assets/images/logo-kahf.png" alt="">
      <div class="title" style="padding: 15%;">
        <img class="title-cover" src="/assets/images/title-cover.png" alt="">
        <h2>REGISTER <br>
        TO DECODE</h2>
        <h3>FILL IN YOUR DETAILS TO UNLOCK<br>
        THE EXPERIENCE.</h3>
        <form style="position: absolute; top: 42.5%; left:18%; width:46%;" id="regist-form">
          <label for="name">Full Name</label>
          <input type="text" id="name" class="name" placeholder="your name" required>
          <label for="phone">Whatsapp Number</label>
          <input type="number" id="phone" class="phone" placeholder="your number" required inputmode="numeric" pattern="[0-9]*">
        </form>
        <div class="checkbox-group">
        <label class="checkbox-item">
          <input type="checkbox" id="privacy-required" required>
          <span class="checkbox-span">See our <a href="#">Privacy Policy</a> for more information.</span>
        </label>

        <label class="checkbox-item-2">
          <input type="checkbox" id="privacy">
          <span  class="checkbox-span-2">I agree to receive promotional & further information from Kahf (Optional)</span>
        </label>
      </div>
        <button type="submit" id="regist-submit-btn" class="kahf-btn kahf-btn-accent disabled" disabled>NEXT</button>
      </div>
    </section>
    <section id="face-scan-hair" class="face-scan p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
        <img class="icon-back" src="/assets/images/icon-back.png" alt="">
        <img class="logo-decode" src="/assets/images/kahf-logo.png" alt="">
        <img class="logo" src="/assets/images/logo-scan-wajah.png" alt="">
      </div>

      <!-- INTRO -->
      <div class="intro-text">
        <h2 class="greeting">HAI !!!</h2>
        <p class="desc">
          WE'LL ANALYZE YOUR FACE SHAPE TO SUGGEST SUITABLE HAIRSTYLES AND PRODUCTS.
        </p>
      </div>

      <div id="face-scan-container" class="mb-3">
        <img class="ellipse" src="/assets/images/ellipse.png" alt="">
        <div class="scan-helper-container" id="scan-helper">
          <div class="scan-helper-text" id="scan-helper-text"></div>
          <div class="scan-progress">
            <div class="progress-bar" id="scan-progress"></div>
          </div>
        </div>
      </div>
      <button id="scan-btn" class="kahf-btn kahf-btn-accent">
        <span>SCAN</span>
      </button>
    </section>
    <!-- Question Hair -->
    <section id="page-question-hair" class="question p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
      <img class="icon-back" src="/assets/images/icon-back.png" alt="">
      </div>
      <img class="logo" src="/assets/images/question-logo.png" alt="">
      <img class="logo-decode" src="/assets/images/kahf-logo.png" alt="">
      <div class="heading-with-image flex items-center gap-4">
        <h2>APA TIPE RAMBUTMU?</h2>
        <div class="question-wrapper2 question-text-container">
          <div class="question-list question-text" data-value="Straight">
            <span>YOUR PHOTO</span>
          <img id="your-photo" src="./assets/images/Straight-Model.png" alt="Your Photo">
        </div>
      </div>
      <div class="question-wrapper question-text-container">
        <div class="question-list question-text" data-value="Straight" id="button-to-hairstyle1">
          <span>Straight</span>
          <img src="./assets/images/Straight-1.png">
        </div>
        <div class="question-list question-text" data-value="Wavy" id="button-to-hairstyle2">
          <span>Wavy</span>
          <img src="./assets/images/Wavy-1.png">
        </div>
        <div class="question-list question-text" data-value="Curly" id="button-to-hairstyle3">
          <span>Curly</span>
          <img src="./assets/images/Curly-1.png">
        </div>
        <div class="question-list question-text" data-value="Coily" id="button-to-hairstyle4">
          <span>Tight Curly</span>
          <img src="./assets/images/Tight Curly-1.png">
        </div>
      </div>

    </section>
    <section id="loading-screen" class="loading p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
        <!-- <img class="icon-back" src="/assets/images/icon-back.png" alt=""> -->
      </div>
      <img class="logo" src="/assets/images/loading-logo.png" alt="">
      <img class="logo-decode" src="/assets/images/kahf-logo.png" alt="">
      <img class="logo-desc" src="/assets/images/kahf-desc.png" alt="">
      <div class="result-loading justify-content-center align-items-center">
          <i class="custom-spinner me-2"></i>
          <span>Please Wait</span>
        </div>
    </section>
    <section id="face-result-screen" class="kahf-screen hidden">
      <img class="logo mb-5" width="30%" style="max-width: 200px;" src="/assets/images/logo-hair.png" alt="">
      <button class="kahf-btn kahf-btn-accent back-btn">
        <span>Back</span>
      </button>
      <div class="face-shape-card">
        <div class="d-flex gap-5 justify-content-center mb-4">
          <!-- Foto user -->
          <div class="wrapper-captured captured-left">
            <img id="preview-img" src="/assets/images/default.png" alt="Preview">
            <div class="shape-name">Your Photo</div>
          </div>
          <!-- Hasil prediksi -->
          <div class="wrapper-captured captured-right">
            <img id="result-img" src="/assets/images/default.png" alt="Result">
            <div class="shape-name" id="result-shape">Result</div>
          </div>
        </div>

        <!-- Info hasil prediksi -->
        <div class="face-shape-info mb-4">
          <p class="mb-2 shape-title">Face Shape Result</p>
          <p class="shape-desc" id="shape-desc">
            Upload your face photo to get recomendation.
          </p>
        </div>
      </div>


    <button id="result-continue-btn" class="kahf-btn kahf-btn-accent">
      CONTINUE
    </button>
    </section>
    <!-- Hairstyle Selection Screen -->
    <section id="hairstyle-screen" class="hairstyle kahf-screen page-stye-2 hidden">
      <img class="icon-back" src="/assets/images/icon-back.png" alt="">
      <!-- <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt=""> -->
      <img class="logo" src="/assets/images/hairstyle-logo.png" alt="">
      <!-- <h1 class="kahf-title mb-5">Hairstyle Selection</h1> -->
      <div class="hairstyle-name-2">
         QUIFF
      </div>
      <div class="hair-style">
        HAIR STYLE
      </div>
      <!-- Three.js Container - Single consistent element -->
      <div class="hairstyle-grid">
        <div class="hairstyle-grid-inner-two">
          <div class="hairstyle-item active" data-model-index="0">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-quiff.glb" alt="A 3D model" style="--poster-color: transparent;">
                <div slot="poster"></div>
                <div slot="progress-bar"></div>
              </model-viewer>
            </div>
            <div class="hairstyle-name">QUIFF</div>
          </div>
          <div class="hairstyle-item" data-model-index="1">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-layered.glb" alt="A 3D model" style="--poster-color: transparent;">
                <div slot="poster"></div>
                <div slot="progress-bar"></div>
              </model-viewer>
            </div>
            <div class="hairstyle-name">LAYERED</div>
          </div>
          <div class="hairstyle-item" data-model-index="2">
            <div class="hairstyle-img">
              <model-viewer src="/assets/models/model-slickback.glb" alt="A 3D model" style="--poster-color: transparent;">
                <div slot="poster"></div>
                <div slot="progress-bar"></div>
              </model-viewer>
            </div>
            <div class="hairstyle-name">SLICK BACK</div>
          </div>
        </div>
      </div>
      
      <button id="button-style-vault" class="kahf-btn kahf-btn-accent button-small">
        more hair style (200)
      </button>

      <div class="scene-container">
        <canvas id="renderCanvas1"></canvas>
        <!-- <model-viewer auto-rotate camera-controls id="hair_0" src="/assets/models/hair-1.glb" data-hair="hair-1" alt="A 3D model"></model-viewer>
        <model-viewer auto-rotate camera-controls id="hair_1" src="/assets/models/hair-2.glb" data-hair="hair-2" alt="A 3D model"></model-viewer>
        <model-viewer auto-rotate camera-controls id="hair_2" src="/assets/models/hair-3.glb" data-hair="hair-3" alt="A 3D model"></model-viewer> -->
        <!-- <div class="scene-name"></div> -->
        <!-- Three.js will create its own canvas here -->
        <!-- <img class="rotate-icon" src="/assets/images/rotate-icon.png" alt=""> -->
        <div class="face-desc" id="face-desc">
          <p>The most balanced and versatile face shape, with a slightly wider forehead than jawline. Almost any hairstyle works well, from short, sharp crops to longer, layered looks, giving you the freedom to experiment.Â </p>
        </div>
        <div class="rotate-controls">
          <button id="btnLeft" class="kahf-btn kahf-btn-accent">&laquo;</button>
          <button id="btnRight" class="kahf-btn kahf-btn-accent">&raquo;</button>
        </div>
      </div>
      <button id="hairstyle-continue-btn" class="kahf-btn kahf-btn-accent">
        NEXT
      </button>
    </section>
    <!-- Hairstyle List Selection Screen -->
    <section id="hairstyle-list-screen" class="p-0 kahf-screen page-stye-1 hidden"> 
      <div class="header">
        <img class="icon-back" src="/assets/images/icon-back.png" alt="">
        <!-- <img class="logo-decode" src="/assets/images/logo-decode-1.png" alt=""> -->
        <img class="logo" src="/assets/images/hair-list-logo.png" alt="">
      </div>

      <div class="first-three-grid">
        <div class="first-three-grid-inner">
          <div id="first-three-grid-inner-list" class="first-three-grid-inner-list">
            <!-- First 3 hairstyle items will be rendered here by renderFirstThreeImages() -->
          </div>

          <div class="sidebar-hair-list">
            <!-- FIRST 3 HAIRSTYLES -->
          </div>
        </div>
      </div>

      <div class="hairstyle-grid">
        <div class="hairstyle-grid-inner">
          <div id="hairstyle-grid-inner-list" class="hairstyle-grid-inner-list">
            <div class="loading-indicator">
              <p>Loading hairstyles...</p>
            </div>
          </div>
          
          <div class="sidebar-hair-list">
            <!-- HAIRSTYLE -->
          </div>
        </div>
      </div>
    </section>
    <!-- Product Recommendation Screen -->
    <section id="product-hair-screen" class="p-0 kahf-screen page-stye-1 hidden">
      <div class="header">
        <img class="icon-back" id="icon-back-white" src="/assets/images/icon-back-white.png" alt="">
        <span class="title-name">FADLY</span>
        <span class="title-decode">/DECODE HAIR</span>
      </div>
      <div class="sidebar-prod">
        HAIRSTYLE
      </div>
      <!-- Hasil Grid -->
      <div class="result-card" style="display: block;">
        <div class="result-grid">
          <!-- row 1 -->
          <div class="haircut">
            <!-- <img src="./assets/images/french-crop.png" alt="French Crop">
            <p>FRENCH CROP</p> -->
          </div>
          <div class="info face-shape">
            <h3 style="font-size: 17px;">FACE SHAPE:</h3>
            <div class="value" id="face-type">OVAL</div>
            <img id="face-shape-img" src="./assets/images/oval-1.png" alt="Oval">
          </div>
          <!-- row 2 -->
          <div class="haircut">
            <!-- <img src="./assets/images/taper-fade.png" alt="Taper Fade">
            <p>TAPER FADE</p> -->
          </div>
          <div class="info hair-type">
            <h4>HAIR TYPE:</h4>
            <div class="value hair-type-detail">CURLY</div>
            <img class="result-hair-type" src="./assets/images/curly.png" alt="Curly">
          </div>
          <!-- row 3 -->
          <div class="haircut">
            <!-- <img src="./assets/images/side-part.png" alt="Side Part">
            <p>SIDE PART</p> -->
          </div>
          <div class="info product">
            <h5>PRODUCTS RECOMMENDATION</h5>
            <div class="prod-detail">
              <img id="prod-img" src="./assets/images/pomade-sleek.png" alt="Kahf">
              <p id="prod-text">KAHF SLEEK <br>
                CLASSY WATER <br>
                BASED POMADE</p>
            </div>
          </div>
        </div>
      </div>
      <div class="product-card">
        <div class="model-img model-img-wrapper active" id="model-img" data-index="0" style="overflow: hidden;">
          <img id="result-hairstyle-img">
        </div>
        <div class="model-img-2 model-img-wrapper" data-index="1" style="overflow: hidden;">
          <canvas id="renderCanvas2"></canvas>
          <!-- <img id="result-hairstyle-img-2"> -->
        </div>
        <div class="model-img-3 model-img-wrapper" data-index="2" style="overflow: hidden;">
          <canvas id="renderCanvas3"></canvas>
          <!-- <img id="result-hairstyle-img-3"> -->
        </div>
      </div>
      <!-- Button -->
      <div class="group-button d-flex gap-4 button-inline-wrapper justify-content-center align-items-center">
        <button id="finish-page-hair-product" class="button-to-home kahf-btn kahf-btn-accent" style="width: 30%;">
          FINISH
        </button>
        <button id="download-result" class="kahf-btn kahf-btn-accent" style="width: 30%; pointer-events: none;">
          DOWNLOAD
        </button>
        <!-- <button id="share-result" class="kahf-btn kahf-btn-accent" style="width: 30%" onclick="generateResultQR()">
          SHARE
        </button>
        <div id="qrModal" class="qr-modal">
          <div class="qr-modal-content">
            <span class="close">&times;</span>
            <h3 class="qr-text">Scan QR Code For Share Your Result</h3>
            <div id="qr_image_modal" style="display: inline-block;">
            </div>
          </div>
        </div> -->
    </section>
  </div>

  <div id="captured-photo">
  </div>

    <script type="importmap">
      {
      "imports": {
        "three": "/assets/js/three.module.js",
        "three/addons/": "/assets/js/three/addons/",
        "mindar-face-three":"/assets/js/mindar-face-three.prod.js"
      }
    }
  </script>

 <script>
   async function loadYourPhoto() {
    try {
      const res = await fetch("/api/latest-face");
      const data = await res.json();

      if (data.success && data.face_base64) {
        const imgEl = document.getElementById("your-photo");
        imgEl.src = `data:image/png;base64,${data.face_base64}`;
      }
    } catch (err) {
      console.error("Failed to load your photo:", err);
    }
  }

  // Load the photo when the page is ready
  window.addEventListener("DOMContentLoaded", loadYourPhoto);
  const qrPopup = document.getElementById("qr-popup");
  const openQrBtn = document.getElementById("button-scan-qr"); // tombol scan
  const closeQrBtn = document.querySelector(".qr-close");

  let html5QrCode; // biar bisa stop di mana aja

  // buka popup + mulai scan
  openQrBtn.addEventListener("click", () => {
    qrPopup.style.display = "flex"; // pastiin tampil dulu
    qrPopup.classList.remove("hide");
    qrPopup.classList.add("show");

    html5QrCode = new Html5Qrcode("qr-reader");

    html5QrCode.start(
      { facingMode: "user" }, // kamera depan
      {
        fps: 10,
        qrbox: 250
      },
      (decodedText) => {
        console.log(`QR Code hasil: ${decodedText}`);

        // stop kamera setelah berhasil
        html5QrCode.stop().then(() => {
          closePopup(); // tutup popup
          showScreen("homePageHair"); // pindah ke homepage
        });
      },
      (errorMessage) => {
        // alert('QR Tidak Ditemukan');
        console.log("Scanning error:", errorMessage);
      }
    ).catch((err) => {
      console.error("Tidak bisa akses kamera:", err);
    });
  });

  // fungsi tutup dengan fadeOut + stop kamera
  function closePopup() {
    qrPopup.classList.remove("show");
    qrPopup.classList.add("hide");

    // stop kamera kalau masih nyala
    if (html5QrCode) {
      html5QrCode.stop().catch(err => console.warn("Gagal stop kamera:", err));
    }

    setTimeout(() => {
      qrPopup.style.display = "none";
    }, 300); // sesuai transition 0.3s
  }

  closeQrBtn.addEventListener("click", closePopup);

  // klik luar popup untuk tutup
  window.addEventListener("click", (e) => {
    if (e.target === qrPopup) {
      closePopup();
    }
  });

  // function untuk show/hide screen
  function showScreen(screenName) {
    Object.values(screens).forEach(screen => {
      screen.addClass('hidden');
    });
    screens[screenName].removeClass('hidden');
  }
  // Screen navigation
  const screens = {
    profile: $('#profile-screen'),
    splash: $('#splash-screen'),
    landing: $('#landing-screen'),
    startScan: $('#start-qr-screen'),
    loading: $('#loading-screen'),
    // hair
    homePageHair: $('#home-page-hair'),
    scan: $('#face-scan-screen'),
    result: $('#face-result-screen'),
    hairstyle: $('#hairstyle-screen'),
    pageQuestionHair: $('#page-question-hair'),
    hairstyleList: $('#hairstyle-list-screen'),
    registForm: $('#register-form'),
    product: $('#product-hair-screen'),
    scanAnalyzer: $('#skin-analyzer-splash'),
    scanHairAnalyzer: $('#hair-analyzer-splash'),
    scanSkin: $('#face-scan-skin'),
    scanHair: $('#face-scan-hair'),
    scanAnalyzerSelection: $('#skin-analyzer-selection'),
    homePage: $('#home-page'),
    pageForm: $('#page-form'),
    pageIntro: $('#page-intro'),
    loading: $('#loading-screen'),
    // skin analyzer
    pageResultSkin: $('#page-result'),
    pageSkinResult: $('#face-result-skin'),
    pageSkinScore: $('#page-skin-score'),
    pageSkinProduct: $('#page-result-product'),
    pageQuestionAge: $('#page-question-age'),
    questionSkinCondition: $('#page-question-skin-condition'),
    questionDirectSunlight: $('#page-question-direct-sunlight'),
    questionPersonalConcern: $('#page-question-dry-concerns'),
    questionLivein: $('#page-question-livein'),
    // i dont know
    questionDescribeSkin: $('#page-question-describe-skin'),
    questionPoresSkin: $('#page-question-pores'),
    questionAfternoon: $('#page-question-afternoon'),
    questionBlemishes: $('#page-question-blemishes'),
    questionMorning: $('#page-question-morning'),
    // skin condition
    questionNormalSkin: $('#page-question-normal-concerns'),
    questionOilySkin: $('#page-question-oily-concerns'),
    questionCombinationSkin: $('#page-question-combination-concerns'),
    questionDullSkin: $('#page-question-dull-concerns'),
    questionDrySkin: $('#page-question-dry-concerns'),
    questionAcneSkin: $('#page-question-acne-concerns'),
    // result
    resultSkinType: $('#page-result-skintype')
  }

  const checkbox = document.getElementById("privacy");
  const button = document.getElementById("take-selfie-hair");
  const questionItems = document.querySelectorAll(".question-list");

  questionItems.forEach(item => {
    item.addEventListener("click", () => {
      // hapus active dari semua
      questionItems.forEach(el => el.classList.remove("active"));
      // tambahkan active ke item yang diklik
      item.classList.add("active");
      // kasih delay 1 detik sebelum masuk loading
      setTimeout(() => {
        showScreen('loading');
        setTimeout(() => {
          showScreen('hairstyle');
        }, 35000);
      }, 2000);
    });
  });
  // const questionItems = document.querySelectorAll(".question-list");

  // // helper function untuk tunggu semua assets
  // function waitForAssets() {
  //   const models = document.querySelectorAll("model-viewer");
  //   const overlays = document.querySelectorAll(".texture-overlay img"); 
  //   // ganti selector sesuai class overlay kamu

  //   let promises = [];

  //   // model-viewer
  //   models.forEach(mv => {
  //     promises.push(new Promise(resolve => {
  //       if (mv.loaded) { // kalau model sudah ready
  //         resolve();
  //       } else {
  //         mv.addEventListener("load", () => resolve(), { once: true });
  //       }
  //     }));
  //   });

  //   // overlay image
  //   overlays.forEach(img => {
  //     promises.push(new Promise(resolve => {
  //       if (img.complete) { // kalau image sudah ready
  //         resolve();
  //       } else {
  //         img.addEventListener("load", () => resolve(), { once: true });
  //         img.addEventListener("error", () => resolve(), { once: true }); // biar gak nge-hang
  //       }
  //     }));
  //   });

  //   return Promise.all(promises);
  // }

  // questionItems.forEach(item => {
  //   item.addEventListener("click", () => {
  //     // reset selected
  //     questionItems.forEach(el => el.classList.remove("selected"));
  //     item.classList.add("selected");

  //     setTimeout(() => {
  //       showScreen('loading');

  //       // tunggu semua assets
  //       waitForAssets().then(() => {
  //         console.log("âœ… Semua model & overlay loaded!");
  //         showScreen('hairstyle');
  //       });
  //     }, 2000);
  //   });
  // });

//   document.getElementById("regist-submit-btn").addEventListener("click", function() {
//   const name = document.getElementById("name").value.trim();
//   const greeting = document.querySelector(".greeting");
//   const titleName = document.querySelector(".title-name");

//   if (name) {
//     greeting.textContent = `HAI ${name.toUpperCase()} !!!`;
//   } else {
//     greeting.textContent = "HAI !!!";
//   }

//   if (name) {
//     titleName.textContent = `${name.toUpperCase()}`;
//   } else {
//     titleName.textContent = "";
//   }
// });

  let registeredName = ""; // variabel global

  document.getElementById("regist-submit-btn").addEventListener("click", function() {
    const name = document.getElementById("name").value.trim();
    const greeting = document.querySelector(".greeting");
    const titleName = document.querySelector(".title-name");

    if (name) {
      registeredName = name.toUpperCase(); // simpan nama user
      greeting.textContent = `HAI ${registeredName} !!!`;
      titleName.textContent = `${registeredName}`;
    } else {
      greeting.textContent = "HAI !!!";
      titleName.textContent = "";
      registeredName = ""; // kosong kalau ga isi
    }
  });

  document.getElementById("download-result").addEventListener("click", function () {
  const section = document.getElementById("product-hair-screen");
  const userName = document.querySelector(".title-name").textContent.trim();
  const safeName = userName ? userName.replace(/\s+/g, "_") : "user";
  const fileName = `hairstyle_result_${safeName}.png`;

  // Daftar id yang mau di-skip
  const skipIds = ["download-result", "finish-page-hair-product", "icon-back-white"];

  domtoimage.toBlob(section, {
    filter: function(node) {
      return !skipIds.includes(node.id);
    }
  })
  .then(function (blob) {
    const link = document.createElement("a");
    link.download = fileName;
    link.href = URL.createObjectURL(blob);
    link.click();
  })
  .catch(function (error) {
    console.error("Download gagal:", error);
  });
});

  const nameInput = document.getElementById("name");
  const phoneInput = document.getElementById("phone");
  const requiredCheckbox = document.getElementById("privacy-required");
  const submitBtn = document.getElementById("regist-submit-btn");

  // fungsi cek validasi
  function validateForm() {
    const nameFilled = nameInput.value.trim() !== "";
    const phoneFilled = phoneInput.value.trim() !== "";
    const checkboxChecked = requiredCheckbox.checked;

    if (nameFilled && phoneFilled && checkboxChecked) {
      submitBtn.disabled = false;
      submitBtn.classList.remove("disabled");
    } else {
      submitBtn.disabled = true;
      submitBtn.classList.add("disabled");
    }
  }

  // event listener
  nameInput.addEventListener("input", validateForm);
  phoneInput.addEventListener("input", validateForm);
  requiredCheckbox.addEventListener("change", validateForm);

  // kondisi awal
  validateForm();

  // --- Face capture variables ---
  let currentAngle = 0;
  let targetAngle = 0;
  let texturePath = '';
  let capturedImages = [];
  
  document.addEventListener('DOMContentLoaded', function () {
  const hairTypeOptions = document.querySelectorAll('.question-list');
  const resultCard = document.querySelector('.result-card');
  const hairTypeDetail = document.querySelector('.hair-type-detail');
  const resultImg = document.querySelector('.result-hair-type'); // pastikan ada <img class="result-img">

  // mapping data-value ke gambar
  const hairTypeImages = {
    "Straight": "./assets/images/Straight-1.png",
    "Wavy": "./assets/images/Wavy-1.png",
    "Curly": "./assets/images/Curly-1.png",
    "Tight Curly": "./assets/images/Tight Curly-1.png"
  };

  hairTypeOptions.forEach(option => {
    option.addEventListener('click', function () {
      // reset selected
      hairTypeOptions.forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');

      // ambil value
      const selectedHairType = this.getAttribute('data-value');

      // isi teks dan gambar sesuai mapping
      hairTypeDetail.textContent = selectedHairType;
      resultImg.setAttribute('src', hairTypeImages[selectedHairType]);
      resultImg.setAttribute('alt', selectedHairType);

      // tampilkan result-card
      resultCard.style.display = 'block';

      console.log('User memilih:', selectedHairType);
    });
  });
});
  
  let qrCode = null;
  let qrResult = null;
  
  // --- QR Result ---
  function generateResultQR() {
    if (!qrResult) {
      qrResult = new QRCode("qr_image_modal", {
      text: "https://www.kahfeveryday.com/",
      width: 256,
      height: 256,
      colorDark: "#3f4939",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H,
    });
  } else {
    qrResult.clear(); 
    qrResult.makeCode("https://www.kahfeveryday.com/");
  }
    
    
  console.log("QR Code generated for result.");
  document.getElementById("qrModal").style.display = "flex";
}



// Event listener untuk tombol share
    // document.getElementById("share-result").addEventListener("click", function() {
    //   generateResultQR();
    // });
    
    // // Event listener untuk menutup modal
    // $(".close").on("click", function() {
    //   $("#qrModal").fadeOut();
    // });
    
    // // Tutup modal jika diklik di luar area konten
    // window.addEventListener("click", function(event) {
    //   const modal = document.getElementById("qrModal");
    //   if (event.target === modal) {
    //     modal.style.display = "none";
    //   }
    // });

  function showScreen(screenName) {
    // Hide all screens
    Object.values(screens).forEach(screen => {
      $(screen).addClass('hidden'); // wrap with $()
    });

    // Show the requested screen
    $(screens[screenName]).removeClass('hidden'); // wrap with $()
  }


const faceShape = [
  {
    name: "Oval",
    image: "/assets/images/oval.png",
    description:
      "The most balanced and versatile face shape, with a slightly wider forehead than jawline. Almost any hairstyle works well, from short, sharp crops to longer, layered looks, giving you the freedom to experiment.",
  },
  {
    name: "Round",
    image: "/assets/images/round.png",
    description:
      "Characterized by equal width and length with soft jawlines. Hairstyles that add height and volume on top help elongate the face, while keeping the sides shorter for a sharper, more defined appearance.",
  },
  {
    name: "Square",
    image: "/assets/images/square.png",
    description:
      "Defined by a strong, angular jawline and balanced proportions. Textured or layered cuts help soften sharp angles, adding movement and balance without losing the masculine edge.",
  },
  {
    name: "Rectangle",
    image: "/assets/images/oblong.png",
    description:
      "Longer than it is wide, with a straight jawline. Styles with added volume on the sides help balance the length, while avoiding excessive height on top to keep proportions in check.",
  },
  {
    name: "Oblong",
    image: "/assets/images/oblong.png",
    description:
      "Longer than it is wide, with a straight jawline. Styles with added volume on the sides help balance the length, while avoiding excessive height on top to keep proportions in check.",
  },
  {
    name: "Heart",
    image: "/assets/images/heart.png",
    description:
      "A broad forehead that tapers to a narrow, pointed chin. Hairstyles that add fullness and texture around the jawline create harmony and draw attention to the eyes and cheekbones.",
  },
  {
    name: "Diamond",
    image: "/assets/images/diamond.png",
    description:
      "Wide cheekbones with a narrow forehead and chin. Best paired with styles that bring volume or bangs to the forehead, balancing the width and adding softness to the overall look.",
  },
  {
    name: "Triangle",
    image: "/assets/images/triangular.png",
    description:
      "A wider jawline compared to the forehead. Opt for hairstyles with volume and fullness at the crown to balance proportions and add height, creating a more even silhouette.",
  },
];

// Array produk
const products = [
  {
    img: "./assets/images/pomade-sleek.png",
    alt: "Kahf",
    text: "KAHF SLEEK <br> CLASSY WATER <br> BASED POMADE"
  },
  {
    img: "./assets/images/pomade-matte.png",
    alt: "Kahf",
    text: "KAHF MATTE <br> DAPPER WATER <br> BASED POMADE"
  },
  {
    img: "./assets/images/pomade-sleek.png",
    alt: "Kahf",
    text: "KAHF SLEEK <br> CLASSY WATER <br> BASED POMADE"
  }
];

// ambil elemen produk
const prodImg = document.getElementById("prod-img");
const prodText = document.getElementById("prod-text");

// event listener untuk setiap model-img
function updateProduct(index) {
  const product = products[index];
  if (!product) return; // jaga2 kalau index salah
  prodImg.src = product.img;
  prodImg.alt = product.alt;
  prodText.innerHTML = product.text;
}

// kasih event listener ke setiap card
$(".model-img-wrapper").on("click", function () {
  const index = parseInt($(this).attr('data-index'));
  console.log("Klik index:", index);
  updateProduct(index);

  $(".model-img-wrapper").removeClass("active");
  $(this).addClass("active");
});

function updateFaceShapeUI(prediction) {
    const result = faceShape.find(
      item => item.name.toLowerCase() === prediction.toLowerCase()
    );

    if (result) {
      document.getElementById("face-type").textContent = result.name;
      document.getElementById("face-shape-img").src = result.image;
      document.getElementById("face-shape-img").alt = result.name;
      document.querySelector("#face-desc p").textContent = result.description;
    } else {
      document.getElementById("face-type").textContent = "Unknown";
      document.getElementById("face-shape-img").src = "";
      document.querySelector("#face-desc p").textContent = "No description available.";
    }
  }

  // ðŸ”¹ Misalnya ini callback dari model prediksi
  function onScanComplete(predictedResult) {
    // predictedResult misalnya: "Oval", "Round", "Square", dll
    updateFaceShapeUI(predictedResult);
  }

function renderHairstyleItems(hairstyleData, lazyNine) { 
  const gridInnerList = document.getElementById('hairstyle-grid-inner-list');
  if (!gridInnerList) return console.error("Could not find hairstyle-grid-inner-list element");

  // Create 9 copies of lazyNine
  const lazyNineArray = Array.from({ length: 9 }, () => ({ output_base64: lazyNine }));

  // Merge actual results + placeholders
  const mergedData = [...hairstyleData, ...lazyNineArray.slice(hairstyleData.length)];

  // Clear grid
  gridInnerList.innerHTML = '';

  mergedData.forEach((item, index) => {
    const hairstyleItem = document.createElement('div');
    hairstyleItem.className = 'hairstyle-item';
    hairstyleItem.setAttribute('data-model-index', index);
    hairstyleItem.setAttribute('data-name', item.name || 'Hairstyle');
    hairstyleItem.style.opacity = '0'; // start hidden for fade-in

    const recommendedTag = item.recommended
      ? `<span class="tag-recommended"><label>RECOMMENDED</label></span>` : '';

    const isLazyNine = !item.name; // placeholder items have no name

    hairstyleItem.innerHTML = `
      <div class="hairstyle-img" style="${isLazyNine ? 'opacity:0.6;' : ''}">
        <img src="data:image/png;base64,${item.output_base64}" alt="${item.name || 'Hairstyle'}" />
        ${recommendedTag}
      </div>
      <div class="hairstyle-name">${item.name || 'Hairstyle'}</div>
    `;

    gridInnerList.appendChild(hairstyleItem);

    // Fade-in effect
    setTimeout(() => {
      hairstyleItem.style.transition = 'opacity 0.5s';
      hairstyleItem.style.opacity = '1';
    }, 50 * index);
  });

  console.log(`Rendered ${mergedData.length} hairstyle items`);
}

function renderFirstThreeImages(hairstyleData) {
  const gridInnerList = document.getElementById('first-three-grid-inner-list'); // separate container
  if (!gridInnerList) return console.error("Could not find first-three-grid-inner-list element");

  // Clear grid
  gridInnerList.innerHTML = '';

  hairstyleData.forEach((item, index) => {
    const hairstyleItem = document.createElement('div');
    hairstyleItem.className = 'hairstyle-item';
    hairstyleItem.setAttribute('data-model-index', index);
    hairstyleItem.setAttribute('data-name', item.name || 'Hairstyle');

    const recommendedTag = item.recommended
      ? `<span class="tag-recommended"><label>RECOMMENDED</label></span>` : '';

    hairstyleItem.innerHTML = `
      <div class="hairstyle-img">
        <img src="data:image/png;base64,${item.output_base64}" alt="${item.name || 'Hairstyle'}" />
        ${recommendedTag}
      </div>
      <div class="hairstyle-name">${item.name || 'Hairstyle'}</div>
    `;

    gridInnerList.appendChild(hairstyleItem);
  });

  console.log(`Rendered ${hairstyleData.length} first-three hairstyle items`);
}

data_global_texture = null;
remaining_gallery = null;
centerBase64 = null;
currentBatchIndex = 0;
uploadedFaceBase64 = null;
face_url = null;

async function completeScan() {
  console.log("Completing scan process...");
  try {
    // ðŸŸ¢ Update UI to reflect scan completion
    console.log("Scan complete. Updating UI...");
    $('#scan-progress').css('width', '100%');
    $('#scan-helper-text').text('Scanning Complete...');

    // ðŸŸ¢ Langsung kasih feedback analyzing (tanpa nunggu fetch selesai)
    setTimeout(() => {
      $('#scan-helper-text').text('Analyzing...');
    }, 500); // kasih delay dikit biar transisinya natural

    // ðŸŸ¢ Prepare result screen
    const photoContainer = document.querySelector("#captured-photo");
    if (photoContainer) photoContainer.innerHTML = "";

    // ðŸŸ¢ Proceed only if images haven't been logged and are available
    console.log("Captured count: 1");
    console.log("Captured Images Array:", capturedImages);
    if (capturedImages.length > 0) {
      const straightImage = capturedImages.find(img => img.orientation === "straight");
      const leftImage = capturedImages.find(img => img.orientation === "left");
      const rightImage = capturedImages.find(img => img.orientation === "right");

      $('#your-photo').attr('src', straightImage.dataUrl);
      if (straightImage) $('<img>').addClass('straight-face').attr('src', straightImage.dataUrl).appendTo('#captured-photo');
      if (leftImage) $('<img>').addClass('left-face').attr('src', leftImage.dataUrl).appendTo('#captured-photo');
      if (rightImage) $('<img>').addClass('right-face').attr('src', rightImage.dataUrl).appendTo('#captured-photo');

      const straightFaceSrc = straightImage?.dataUrl?.split(",")[1];
      const leftFaceSrc = leftImage?.dataUrl?.split(",")[1];
      const rightFaceSrc = rightImage?.dataUrl?.split(",")[1];
      uploadedFaceBase64 = straightFaceSrc;

      console.log("Captured Images:", {
        straight: !!straightFaceSrc,
        left: !!leftFaceSrc,
        right: !!rightFaceSrc
      });

      if (straightFaceSrc && leftFaceSrc && rightFaceSrc) {
        console.log("Uploading images to backend...");
        showScreen('pageQuestionHair');
        fetch("/api/upload-face", { // âœ… remove trailing slash
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            center: straightFaceSrc,
            left: leftFaceSrc,
            right: rightFaceSrc
          })
        })
        .then(res => res.json())
        .then(data => {
          // âœ… Use backend-provided texture URL (supports HTTPS)
          if (data.overlay_base64_raw) {
            console.log("Creating frontend Image from base64...");

            // Create a new Image object
            const textureImg = new Image();

            // Set its src to the base64 string
            textureImg.src = "data:image/png;base64," + data.overlay_base64_raw;
            centerBase64 = data.overlay_base64_raw;
            data_global_texture = "data:image/png;base64," + data.final_uv_overlay;
            remaining_gallery = data.remaining_gallery_base64;
            face_url = data.face_url;
            // remaining_gallery.forEach((imgBase64, index) => {
            //     console.log(`Image ${index + 1}:`, imgBase64);
            // });

            // Optional: styling for preview
            Object.assign(textureImg.style, {
              maxWidth: "300px",
              border: "2px solid #333",
              display: "block",
              marginTop: "10px"
            });

            // Append to DOM for debug/preview
            document.querySelector("#captured-photo").appendChild(textureImg);

            // Now you can use this Image object for your 3D texture
            texturePath = textureImg;
            console.log("Texture Image object created:", textureImg);
          } else {
            console.warn("texture_base64 is missing from API response");
          }

          console.log("Texture path set to:", texturePath);
          console.log("API response received:", data);

          if (data.hairfastgan_results && data.hairfastgan_results.length > 0) {
            lazyNine = data.face_base64;
            uploadedFaceBase64 = data.face_base64;

            const defaultNames = ["Quiff", "Layered", "Slickback"];
            data.hairfastgan_results.slice(0, 3).forEach((item, index) => {
                item.name = defaultNames[index] || item.name || "Hairstyle";
            });
            
            renderHairstyleItems(data.hairfastgan_results, lazyNine);
            renderFirstThreeImages(data.hairfastgan_results);
            console.log("Hairstyle data rendered:", data.hairfastgan_results);
          } else {
            console.warn("No hairstyle data in API response");
          }

          if (data.predictions?.center?.class) {
            console.log("Updating face shape UI with:", data.predictions.center.class);
            updateFaceShapeUI(data.predictions.center.class);
          } else {
            console.warn("Predictions center.class is missing");
          }

          console.log("Face shape UI updated.");
          initThreeScene();
          console.log("Three.js scene initialized.");
          console.log("Predictions:", data.predictions);
          console.log("Result image saved at:", data.saved_path);

          // âœ… Display predictions
          const predictionsDiv = document.createElement("div");
          predictionsDiv.innerHTML = `
            <h3>Face Shape Predictions</h3>
            <p><strong>Center:</strong> ${data.predictions?.center?.class || "-"} (${data.predictions?.center?.confidence || "-"})</p>
            <p><strong>Left:</strong> ${data.predictions?.left?.class || "-"} (${data.predictions?.left?.confidence || "-"})</p>
            <p><strong>Right:</strong> ${data.predictions?.right?.class || "-"} (${data.predictions?.right?.confidence || "-"})</p>
          `;
          document.querySelector("#captured-photo").appendChild(predictionsDiv);


          // âœ… Display result image
          const resultImg = document.createElement("img");
          resultImg.src = "data:image/png;base64," + data.overlay_base64_raw;
          resultImg.style.maxWidth = "300px";
          resultImg.style.border = "2px solid #333";
          resultImg.style.display = "block";
          resultImg.style.marginTop = "10px";
          document.querySelector("#captured-photo").appendChild(resultImg);
          console.log("Displaying result image from API response");
          if (data.overlay_base64_raw) {
            console.log("Displaying overlay image from API response");
            console.log("Overlay base64 length:", data.overlay_base64_raw?.length);
            const resultImg = document.createElement("img");
            resultImg.src = "data:image/png;base64," + data.overlay_base64_raw;
            Object.assign(resultImg.style, {
              maxWidth: "300px",
              border: "2px solid #333",
              display: "block",
              marginTop: "10px"
            });
            // console.log("%c ", "font-size:200px; background:url(" + resultImg.src + ") no-repeat; background-size:contain;");
            document.querySelector("#captured-photo").appendChild(resultImg);
          } else {
            console.warn("overlay_base64_raw is missing from API response");
          }


          // Tampilkan analyzing
          $('#scan-helper-text').text('Recomendation Ready!');
          // Tunggu 1 detik sebelum pindah screen
          // setTimeout(() => {
            // showScreen('pageQuestionHair');
          // }, 1000);
        })
        .catch(err => {
          console.error("Upload error:", err);
          // Tampilkan pesan error
          $('#scan-helper-text').text('Error. Please try again.');
          // Dalam 3 detik, kembali ke scan screen
          setTimeout(() => {
            // Reset state scan
            startCapture = false;
            lookedRight = false;
            lookedLeft = false;
            lookedStraight = false;
            currentStepIndex = 0;
            capturedImages = [];
            if (typeof scanSteps !== "undefined" && scanSteps[currentStepIndex]) {
              $('#scan-helper-text').text(scanSteps[currentStepIndex].text);
            } else {
              $('#scan-helper-text').text("Start Scan");
            }
            $('#scan-progress').css('width', '0%');
            $('#scan-btn').css('pointer-events', 'all').html('Start Scan');
            showScreen('scanHair');
          }, 3000);
        });

      } else {
        const warningMsg = document.createElement("div");
        warningMsg.textContent = "Could not capture all required angles. Please try again.";
        Object.assign(warningMsg.style, {
          color: "#ff8800",
          textAlign: "center",
          margin: "20px 0"
        });
        photoContainer.appendChild(warningMsg);
      }

    } else {
      console.log("Images already processed previously.");
    }

  } catch (err) {
    console.error("Error in completeScan():", err);
    alert("An unexpected error occurred during scan completion");

    const fallback = document.createElement("div");
    fallback.textContent = "Unexpected error. Please try again.";
    Object.assign(fallback.style, {
      color: "#ff4444",
      textAlign: "center",
      margin: "20px 0"
    });
    document.querySelector("#captured-photo").appendChild(fallback);
  }
}

// Fungsi untuk mengupdate nama hairstyle di sidebar
function updateSidebarHairStyle() {
  const sidebarElement = document.getElementById("sidebar-hair-style");
  if (sidebarElement) {
    sidebarElement.textContent = selectedHairStyleName;
  }
}

// document.getElementById("showGalleryBtn").addEventListener("click", async () => {
//     try {
//         const response = await fetch("/api/process-remaining-gallery", {
//             method: "POST",
//             headers: {
//                 "Content-Type": "application/json",
//             },
//             body: JSON.stringify({
//                 center: centerBase64
//             })
//         });

//         const data = await response.json();

//         const galleryBase64 = data.remaining_gallery_base64; // array of processed gallery images
//         const container = document.getElementById("galleryContainer");
//         container.innerHTML = ""; // clear previous images

//         galleryBase64.forEach((imgBase64, index) => {
//             console.log(`Gallery Image ${index + 1}:`, imgBase64);

//             const img = document.createElement("img");
//             img.src = `data:image/png;base64,${imgBase64}`;
//             img.style.width = "150px";
//             img.style.margin = "5px";

//             container.appendChild(img);
//         });

//     } catch (err) {
//         console.error("Error fetching gallery images:", err);
//     }
// });

// Event listener untuk item hairstyle
document.addEventListener("DOMContentLoaded", function() {
  // Gunakan event delegation untuk menangani klik pada hairstyle-item
  document.addEventListener("click", function(e) {
    const hairstyleItem = e.target.closest(".hairstyle-item");
    if (hairstyleItem) {
      // Ambil nama hairstyle dari elemen .hairstyle-name
      const hairStyleNameElement = hairstyleItem.querySelector(".hairstyle-name");
      if (hairStyleNameElement) {
        selectedHairStyleName = hairStyleNameElement.textContent;
        // Update teks di sidebar
        updateSidebarHairStyle();
        
        // Hapus class active dari semua item
        document.querySelectorAll(".hairstyle-item").forEach(item => {
          item.classList.remove("active");
        });
        
        // Tambahkan class active ke item yang dipilih
        hairstyleItem.classList.add("active");
      }
    }
  });
  
  // Inisialisasi sidebar dengan nilai default
  updateSidebarHairStyle();
});

  // --- Your Three.js scene setup ---
  // function initThreeScene() {
  //   const container = document.querySelector('.scene-container');
  //   container.classList.remove('d-none');

  //   const scene = new THREE.Scene();
  //   scene.background = null;
    
  //   const camera = new THREE.PerspectiveCamera(60, 700 / 450, 0.1, 100);
  //   camera.position.set(0, 2, 2);

  //   const myCanvas = document.getElementById('renderCanvas1');
  //   const renderer = new THREE.WebGLRenderer({
  //     canvas: myCanvas,
  //     // antialias: true,
  //     alpha: true,
  //     preserveDrawingBuffer: true
  //   });
  //   renderer.setSize(700, 450);

    
    
  //   //pencahayaan tambahan
  //   const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  //   dirLight.position.set(0, 10, 10);
  //   scene.add(dirLight);

  //   const controls = new THREE.OrbitControls(camera, renderer.domElement);
  //   controls.enableDamping = true;
  //   controls.enableZoom = true;
  //   controls.enablePan = false;
  //   controls.enableRotate = false;
  //   controls.target.set(0, 2, 0);

  //   scene.add(new THREE.AmbientLight(0xffffff, 1.5));

  //   //
  //   let faceModel = null;
  //   let currentHair = null;

  //   const loader = new THREE.GLTFLoader();
  //   const textureLoader = new THREE.TextureLoader();
  //   const texturePath = data_global_texture;
  //   const texture = textureLoader.load(texturePath, () => {
  //     // Texture loaded callback
  //     texture.flipY = false;                // âœ… prevent flipping
  //     texture.encoding = THREE.sRGBEncoding; // optional for correct colors
  //   });

  //   // --- Load Face Model ---
  //   loader.load('./assets/models/head_bagus.glb', (gltf) => {
  //     faceModel = gltf.scene;
  //     faceModel.position.set(0, -13, 0);
  //     faceModel.scale.set(9, 9, 9);
  //     scene.add(faceModel);

  //     // Apply the texture
  //     faceModel.traverse((child) => {
  //       if (child.isMesh) {
  //         if (child.material) {
  //           child.material.map = texture;
  //         } else {
  //           child.material = new THREE.MeshStandardMaterial({
  //             map: texture,
  //             transparent: true,
  //             side: THREE.DoubleSide,
  //           });
  //         }
  //         child.material.needsUpdate = true;
  //       }
  //     });
  //     const defaultHair = '/assets/models/Medium-LengthSidePart.glb'; // pilih salah satu default
  //     loadHairstyle(defaultHair);
  //   });


  //   // Fungsi untuk set target rotasi kamera (clamp -45Â° sampai 45Â°)
  //   function setRotationY(angle) {
  //     const min = THREE.MathUtils.degToRad(-18);
  //     const max = THREE.MathUtils.degToRad(18); //ganti ini

  //     targetAngle = Math.min(Math.max(angle, min), max);
  //   }

  //   // --- Event Button Hairstyle ---
  //   $('.hairstyle-item').click(function () {
  //     const index = $(this).attr('data-model-index');
  //     const files = [
  //       '/assets/models/Medium-LengthSidePart.glb',
  //       '/assets/models/Layered.glb',
  //       '/assets/models/SlickBack.glb'
  //     ];

  //     loadHairstyle(files[index]);

  //     $('.hairstyle-item').removeClass('active');
  //     $(this).addClass('active');
  //   });

  //   let isLoadingHair = false; // flag loading

  //   // --- Load Hairstyle on button click ---
  //   function loadHairstyle(path) {
  //     if (!faceModel) {
  //       console.warn("Face model belum loaded.");
  //       return;
  //     }
  //     if (isLoadingHair) {
  //       console.log("Masih loading hairstyle, tunggu sebentar...");
  //       return; // jangan load baru kalau sebelumnya belum selesai
  //     }

  //     isLoadingHair = true;

  //     // Hapus hairstyle lama
  //     if (currentHair) {
  //       scene.remove(currentHair);
  //       currentHair.traverse((child) => {
  //         if (child.isMesh) {
  //           child.geometry.dispose();
  //           if (child.material.isMaterial) {
  //             cleanMaterial(child.material);
  //           } else {
  //             child.material.forEach(mat => cleanMaterial(mat));
  //           }
  //         }
  //       });
  //       currentHair = null;
  //     }

  //     loader.load(path, (gltf) => {
  //       const hair = gltf.scene;

  //       // posisikan relatif di atas face
  //       hair.position.set(-0, -13.105, 0.01);
  //       hair.scale.set(9, 9, 9);

  //       hair.traverse((child) => {
  //         if (child.isMesh) {
  //           if (!child.material) {
  //             child.material = new THREE.MeshStandardMaterial({ color: 0xffffff });
  //           }
  //           child.material.transparent = true;
  //           child.material.side = THREE.FrontSide;
  //           child.material.alphaTest = 0.5;
  //           child.material.depthWrite = true;
  //           child.material.depthTest = true;
  //           child.renderOrder = 1;
  //           child.geometry.computeVertexNormals();
  //         }
  //       });

  //       scene.add(hair);
  //       currentHair = hair;
  //       isLoadingHair = false; // selesai load
  //     });
  //   }

  //   function cleanMaterial(material) {
  //     material.dispose();
  //     for (const key in material) {
  //       if (material[key] && material[key].isTexture) {
  //         material[key].dispose();
  //       }
  //     }
  //   }

  //   // --- Animate loop ---
  //   const clock = new THREE.Clock();

    // function animate() {
    //   requestAnimationFrame(animate);

    //   // Smooth rotation ke targetAngle
    //   currentAngle += (targetAngle - currentAngle) * 0.1;

    //   camera.position.x = 5 * Math.sin(currentAngle);
    //   camera.position.z = 5 * Math.cos(currentAngle);
    //   camera.lookAt(0, 2, 0);

    //   controls.update();
    //   renderer.render(scene, camera);
    // }
    // animate();

    // // Tombol kiri
    // document.getElementById('btnLeft').addEventListener('click', () => {
    //   setRotationY(targetAngle - THREE.MathUtils.degToRad(20));
    // });

    // // Tombol kanan
    // document.getElementById('btnRight').addEventListener('click', () => {
    //   setRotationY(targetAngle + THREE.MathUtils.degToRad(20));
    // });
  // }

  function initThreeScene() {
  // ---- Shared loader ----
  const loader = new THREE.GLTFLoader();
  const textureLoader = new THREE.TextureLoader();
  const texturePath = data_global_texture;
  const texture = textureLoader.load(texturePath, () => {
    texture.flipY = false;
    texture.encoding = THREE.sRGBEncoding;
  });

  let modelGroup; // grup model utama (canvas1)
  let allGroups = []; // semua group di semua canvas

  // ---- Utility: load face + texture ----
  function loadFace(scene, onLoaded) {
    loader.load('./assets/models/Head_Diterusin.glb', (gltf) => {
      const faceModel = gltf.scene;
      faceModel.position.set(0, -2.675, 0);
      faceModel.scale.set(3, 2.8, 3);

      const group = new THREE.Group();
      group.add(faceModel);
      scene.add(group);

      faceModel.traverse((child) => {
        if (child.isMesh) {
          if (child.material) {
            child.material.map = texture;
          } else {
            child.material = new THREE.MeshStandardMaterial({
              map: texture,
              transparent: true,
              side: THREE.DoubleSide,
            });
          }
          child.material.needsUpdate = true;
        }
      });

      allGroups.push(group); // simpan semua group
      onLoaded(group);
    });
  }

  // ---- Utility: load hairstyle ----
  function loadHairstyle(group, path) {
    loader.load(path, (gltf) => {
      const hair = gltf.scene;
      hair.position.set(0, -3.045, 0.01);
      hair.scale.set(3, 3, 3);
      hair.traverse((child) => {
        if (child.isMesh) {
          if (!child.material) {
            child.material = new THREE.MeshStandardMaterial({ color: 0xffffff });
          }
          child.material.transparent = true;
          child.material.side = THREE.FrontSide;
          child.material.alphaTest = 0.5;
          child.material.depthWrite = true;
          child.material.depthTest = true;
          child.renderOrder = 1;
          child.geometry.computeVertexNormals();
        }
      });

      if (group) {
        // hapus hairstyle lama dulu
        const oldHair = group.children.filter(c => c.name === 'hair');
        oldHair.forEach(h => group.remove(h));

        hair.name = 'hair'; // supaya gampang dihapus
        group.add(hair);
      }
    });
  }

  // ---- Buat scene untuk 1 canvas ----
  function createScene(canvasId, defaultHairPath, isMain = false) {
    const scene = new THREE.Scene();
    scene.background = null;
    const camera = new THREE.PerspectiveCamera(60, 700 / 450, 0.1, 100);
    camera.position.set(0, 2, 2);
    const canvas = document.getElementById(canvasId);
    const renderer = new THREE.WebGLRenderer({
      canvas: canvas,
      alpha: true,
      preserveDrawingBuffer: true
    });
    renderer.setSize(700, 450);

    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(0, 10, 10);
    scene.add(dirLight);
    scene.add(new THREE.AmbientLight(0xffffff, 1.5));

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enableZoom = false;
    controls.enablePan = false;
    controls.enableRotate = false;
    controls.target.set(0, 2, 0);

    loadFace(scene, (group) => {
      if (defaultHairPath) loadHairstyle(group, defaultHairPath);
      if (isMain) modelGroup = group;
    });

    return { scene, camera, renderer, controls };
  }

  // ---- Init canvas utama + preview ----
  const view1 = createScene('renderCanvas1', '/assets/models/Quiff.glb', true);
  const view2 = createScene('renderCanvas2', '/assets/models/Layered.glb');
  const view3 = createScene('renderCanvas3', '/assets/models/Slickback-2.glb');

  // ---- Animate loop ----
  function animate() {
    requestAnimationFrame(animate);
    [view1, view2, view3].forEach(view => {
      view.controls.update();
      view.renderer.render(view.scene, view.camera);
    });
  }
  animate();

  // ---- Button rotation untuk semua canvas ----
  const btnLeft = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  
  const minRotation = -Math.PI / 9;
  const maxRotation =  Math.PI / 9;

  btnLeft.addEventListener("click", () => {
    allGroups.forEach(g => {
      g.rotation.y = THREE.MathUtils.clamp(g.rotation.y + 0.2, minRotation, maxRotation);
    });
  });
  btnRight.addEventListener("click", () => {
    allGroups.forEach(g => {
      g.rotation.y = THREE.MathUtils.clamp(g.rotation.y - 0.2, minRotation, maxRotation);
    });
  });

  // ---- Hairstyle selection untuk canvas utama ----
  $('.hairstyle-item').click(function () {
    const index = $(this).data('model-index');
    const files = [
      '/assets/models/Quiff.glb',
      '/assets/models/Layered.glb',
      '/assets/models/SlickBack.glb'
    ];

    const names = [
      'QUIFF',
      'LAYERED',
      'SLICK BACK'
    ]

    if (modelGroup) loadHairstyle(modelGroup, files[index]);

    $('.hairstyle-item').removeClass('active');
    $(this).addClass('active');

    $('.hairstyle-name-2').text(names[index]);
  });
}

function captureCanvas() {
      const canvas = document.getElementById('renderCanvas1');


      
      try {
        const imageData = canvas.toDataURL('image/png');
        displayCapturedImage(imageData);
      } catch (e) {
        console.error("Error capturing canvas:", e);
        // alert("Failed to capture image. Please try again.");
      }
    }

    // Tampilkan gambar hasil tangkapan
    function displayCapturedImage(imageData) {
      const capturedImage = document.getElementById('result-hairstyle-img');
      capturedImage.src = imageData;
      capturedImage.style.display = 'block';
      console.log(imageData);
    }

    // Event listener untuk tombol capture
document.getElementById('hairstyle-continue-btn').addEventListener('click', captureCanvas);

let selectedHairStyle = {
    modelSrc: '',
    name: '',
    description: ''
  };

    // Data untuk setiap hairstyle
const hairStyleData = {
  0: {
    modelSrc: '/assets/models/model-4.glb',
    name: 'TWO BLOCK',
    description: 'A relaxed and stylish look with natural waves framing the face. The curtain-style fringe gives off a soft, youthful vibe while maintaining a sense of effortless charm. Perfect for casual everyday wear or characters that embody freedom and creativity.'
  },
  1: {
    modelSrc: '/assets/models/model-5.glb',
    name: 'BUZZCUT',
    description: 'A timeless hairstyle that highlights confidence and elegance. With its clean, backward flow and subtle volume, it draws attention to the face and sharpens the overall look. Ideal for formal settings, professional styles, or characters that need a refined, sophisticated presence.'
  },
  2: {
    modelSrc: '/assets/models/model-12.glb',
    name: 'FRENCH CROP',
    description: 'A modern, low-maintenance haircut with sharp texture on top and clean sides. This hairstyle balances simplicity with a bold edge, giving off an energetic and masculine vibe. Great for active lifestyles or characters that value strength, practicality, and straightforward style.'
  }
};

    // Fungsi untuk mengupdate product screen dengan hairstyle yang dipilih
function updateProductScreen() {
  // Update model viewer
  const modelViewer = document.getElementById('product-model-viewer');
  if (modelViewer) {
    modelViewer.setAttribute('src', selectedHairStyle.modelSrc);
  }
  
  // Update nama hairstyle
  const nameElement = document.getElementById('product-hair-style-name');
  if (nameElement) {
    nameElement.textContent = selectedHairStyle.name;
  }
  
  // Update deskripsi hairstyle
  const descElement = document.getElementById('product-hair-style-desc');
  if (descElement) {
    descElement.textContent = selectedHairStyle.description;
  }
}

    // Event listener untuk item hairstyle
document.addEventListener("DOMContentLoaded", function() {
  // Gunakan event delegation untuk menangani klik pada hairstyle-item
  document.addEventListener("click", function(e) {
    const hairstyleItem = e.target.closest(".hairstyle-item");
    if (hairstyleItem) {
      const index = hairstyleItem.getAttribute("data-model-index");
      
      // Update selectedHairStyle dengan data dari hairStyleData
      if (hairStyleData[index]) {
        selectedHairStyle = hairStyleData[index];
        
        // Update sidebar jika ada
        updateSidebarHairStyle();
      }
    }
  });
  
  // Event listener untuk tombol next di hairstyle screen
  const continueButton = document.getElementById("hairstyle-continue-btn");
  if (continueButton) {
    continueButton.addEventListener("click", function() {
      // Update product screen sebelum menampilkannya
      updateProductScreen();
      showScreen('product');
    });
  }
});

document.addEventListener('DOMContentLoaded', function() {
      // Hair Type Selection Logic
      const hairTypeOptions = document.querySelectorAll('.question-list');
      const hairTypeDetail = document.querySelector('.hair-type-detail');
      
      hairTypeOptions.forEach(option => {
          option.addEventListener('click', function() {
              // Hapus kelas 'selected' dari semua opsi
              hairTypeOptions.forEach(opt => opt.classList.remove('selected'));
              
              // Tambahkan kelas 'selected' ke opsi yang diklik
              this.classList.add('selected');
              
              // Ambil nilai dari opsi yang dipilih
              const selectedHairType = this.getAttribute('data-value');
              
              // Simpan nilai ke dalam elemen hair-type-detail
              hairTypeDetail.textContent = selectedHairType;
              
              // Simpan pilihan user (bisa dikembangkan untuk disimpan ke database)
              console.log('User memilih jenis rambut:', selectedHairType);
          });
      });
      
      // Hairstyle Selection Logic
      const hairstyleItems = document.querySelectorAll('#hairstyle-list-screen .hairstyle-item');
      const selectedSlots = document.querySelectorAll('.hairstyle-grid-inner .hairstyle-item');
      
      // Inisialisasi state
      let selectedHairstyles = [
          { modelSrc: "/assets/models/model-4.glb", name: "TWO BLOCK", recommended: true },
          { modelSrc: "/assets/models/model-5.glb", name: "BUZZCUT", recommended: true },
          { modelSrc: "/assets/models/model-12.glb", name: "FRENCH CROP", recommended: true }
      ];
      
      // Fungsi untuk mengupdate tampilan slot yang dipilih
      function updateSelectedSlots() {
          selectedSlots.forEach((slot, index) => {
              if (index < selectedHairstyles.length) {
                  const hairstyleData = selectedHairstyles[index];
                  
                  // Update model-viewer
                  const modelViewer = slot.querySelector('model-viewer');
                  modelViewer.setAttribute('src', hairstyleData.modelSrc);
                  modelViewer.setAttribute('alt', hairstyleData.name);
                  
                  // Update nama
                  const nameElement = slot.querySelector('.hairstyle-name');
                  nameElement.textContent = hairstyleData.name;

                  // Update tag recommended
                  const recommendedTag = slot.querySelector('.tag-recommended');
                  if (hairstyleData.recommended) {
                      if (!recommendedTag) {
                          const newTag = document.createElement('span');
                          newTag.className = 'tag-recommended';
                          newTag.innerHTML = '<label>RECOMMENDED</label>';
                          slot.querySelector('.hairstyle-img').appendChild(newTag);
                      }
                  } else if (recommendedTag) {
                      recommendedTag.remove();
                  }

                  console.log('Slot', index, 'updated with', hairstyleData);
              }
          });
          
          console.log('Gaya rambut terpilih:', selectedHairstyles);
      }
      
      // Event listener untuk item gaya rambut
      hairstyleItems.forEach(item => {
          item.addEventListener('click', function() {
              // Dapatkan data dari item yang diklik
              const modelSrc = this.getAttribute('data-model-src');
              const name = this.getAttribute('data-name');
              const recommended = this.getAttribute('data-recommended') === 'true';
            
              console.log('Item clicked:', { modelSrc, name, recommended });
              
              // Tambahkan item baru di awal array
              selectedHairstyles.unshift({
                  modelSrc,
                  name,
                  recommended
              });
              
              // Jika lebih dari 3 item, hapus item terakhir
              if (selectedHairstyles.length > 3) {
                  selectedHairstyles.pop();
              }
              
              // Update tampilan
              updateSelectedSlots();
              
              // Tandai item yang dipilih
              hairstyleItems.forEach(i => i.classList.remove('selected'));
              this.classList.add('selected');
          });
      });
      
      // Inisialisasi tampilan
      updateSelectedSlots();
  });
  
</script>

<script type="module" src="/assets/js/ui.js"></script>

</body>

</html>